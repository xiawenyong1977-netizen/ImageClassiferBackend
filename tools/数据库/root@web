#!/bin/bash
# MySQL主从复制自动配置脚本
# 主库：root@app
# 从库：root@web

set -e

# ============================================
# 配置区域 - 请根据实际情况修改
# ============================================

# 服务器信息
APP_HOST="app"              # App服务器主机名或IP（主库）
WEB_HOST="web"              # Web服务器主机名或IP（从库）
APP_USER="root"             # App服务器SSH用户
WEB_USER="root"             # Web服务器SSH用户

# MySQL配置
MYSQL_ROOT_PASSWORD=""      # MySQL root密码（如果为空，脚本会提示输入）
REPL_USER="repl_user"       # 复制用户名
REPL_PASSWORD=""            # 复制用户密码（如果为空，脚本会生成随机密码）
DATABASE_NAME="image_classifier"  # 需要同步的数据库名

# MySQL配置文件路径
MYSQL_CONF_APP="/etc/mysql/mysql.conf.d/mysqld.cnf"
MYSQL_CONF_WEB="/etc/mysql/mysql.conf.d/mysqld.cnf"
if [ ! -f "$MYSQL_CONF_APP" ]; then
    MYSQL_CONF_APP="/etc/my.cnf"
fi
if [ ! -f "$MYSQL_CONF_WEB" ]; then
    MYSQL_CONF_WEB="/etc/my.cnf"
fi

# ============================================
# 辅助函数
# ============================================

# 获取MySQL root密码
get_mysql_password() {
    if [ -z "$MYSQL_ROOT_PASSWORD" ]; then
        read -sp "请输入MySQL root密码（两个服务器使用相同密码）: " MYSQL_ROOT_PASSWORD
        echo
    fi
}

# 生成复制用户密码
generate_repl_password() {
    if [ -z "$REPL_PASSWORD" ]; then
        REPL_PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)
        echo "生成复制用户密码: ${REPL_PASSWORD}"
    fi
}

# 获取App服务器IP
get_app_ip() {
    APP_IP=$(ssh ${APP_USER}@${APP_HOST} "hostname -I | awk '{print \$1}'" 2>/dev/null || echo "")
    if [ -z "$APP_IP" ]; then
        read -p "请输入App服务器IP地址: " APP_IP
    fi
    echo "$APP_IP"
}

# ============================================
# 主程序
# ============================================

echo "=========================================="
echo "MySQL主从复制自动配置脚本"
echo "=========================================="
echo "主库服务器: ${APP_USER}@${APP_HOST}"
echo "从库服务器: ${WEB_USER}@${WEB_HOST}"
echo "=========================================="
echo ""

# 检查SSH连接
echo "检查SSH连接..."
if ! ssh -o ConnectTimeout=5 ${APP_USER}@${APP_HOST} "echo 'App服务器连接成功'" &>/dev/null; then
    echo "❌ 错误：无法连接到App服务器 ${APP_USER}@${APP_HOST}"
    exit 1
fi
echo "✅ App服务器连接成功"

if ! ssh -o ConnectTimeout=5 ${WEB_USER}@${WEB_HOST} "echo 'Web服务器连接成功'" &>/dev/null; then
    echo "❌ 错误：无法连接到Web服务器 ${WEB_USER}@${WEB_HOST}"
    exit 1
fi
echo "✅ Web服务器连接成功"
echo ""

# 获取MySQL密码
get_mysql_password

# 生成复制用户密码
generate_repl_password

# 获取App服务器IP
APP_IP=$(get_app_ip)
echo "App服务器IP: ${APP_IP}"
echo ""

# ============================================
# 步骤1：配置主库（App服务器）
# ============================================

echo "=========================================="
echo "步骤1：配置主库（App服务器）"
echo "=========================================="


# 上传并执行主库配置脚本
echo "在App服务器上配置主库..."
ssh ${APP_USER}@${APP_HOST} bash <<MASTER_SCRIPT_EOF
set -e
MYSQL_ROOT_PASSWORD="$MYSQL_ROOT_PASSWORD"
REPL_USER="$REPL_USER"
REPL_PASSWORD="$REPL_PASSWORD"
DATABASE_NAME="$DATABASE_NAME"
MYSQL_CONF="$MYSQL_CONF_APP"

echo "配置MySQL主服务器..."

# 备份配置文件
if [ -f "\$MYSQL_CONF" ]; then
    cp "\$MYSQL_CONF" "\${MYSQL_CONF}.backup.\$(date +%Y%m%d_%H%M%S)"
fi

# 配置server-id
if grep -q "^server-id" "\$MYSQL_CONF" 2>/dev/null; then
    sed -i 's/^server-id.*/server-id = 1/' "\$MYSQL_CONF"
else
    echo "" >> "\$MYSQL_CONF"
    echo "# MySQL主从复制配置 - 主服务器" >> "\$MYSQL_CONF"
    echo "server-id = 1" >> "\$MYSQL_CONF"
fi

# 配置log-bin
if grep -q "^log-bin" "\$MYSQL_CONF" 2>/dev/null; then
    sed -i 's|^log-bin.*|log-bin = mysql-bin|' "\$MYSQL_CONF"
else
    echo "log-bin = mysql-bin" >> "\$MYSQL_CONF"
fi

# 添加其他配置
if ! grep -q "^binlog_format" "\$MYSQL_CONF" 2>/dev/null; then
    echo "binlog_format = ROW" >> "\$MYSQL_CONF"
fi

if [ -n "\$DATABASE_NAME" ] && ! grep -q "^binlog-do-db" "\$MYSQL_CONF" 2>/dev/null; then
    echo "binlog-do-db = \${DATABASE_NAME}" >> "\$MYSQL_CONF"
fi

if ! grep -q "^expire_logs_days" "\$MYSQL_CONF" 2>/dev/null; then
    echo "expire_logs_days = 7" >> "\$MYSQL_CONF"
fi

# 重启MySQL
systemctl restart mysql 2>/dev/null || systemctl restart mysqld 2>/dev/null
sleep 3

# 创建复制用户
mysql -u root -p"\${MYSQL_ROOT_PASSWORD}" <<SQL
DROP USER IF EXISTS '\${REPL_USER}'@'%';
CREATE USER '\${REPL_USER}'@'%' IDENTIFIED BY '\${REPL_PASSWORD}';
GRANT REPLICATION SLAVE ON *.* TO '\${REPL_USER}'@'%';
FLUSH PRIVILEGES;
SQL

echo "主库配置完成"
MASTER_SCRIPT_EOF

if [ $? -eq 0 ]; then
    echo "✅ 主库配置完成"
else
    echo "❌ 主库配置失败"
    exit 1
fi

# 获取主库状态
echo "获取主库状态..."
MASTER_STATUS=$(ssh ${APP_USER}@${APP_HOST} "mysql -u root -p'${MYSQL_ROOT_PASSWORD}' -e 'SHOW MASTER STATUS\G' 2>/dev/null")
MASTER_LOG_FILE=$(echo "$MASTER_STATUS" | grep "File:" | awk '{print $2}')
MASTER_LOG_POS=$(echo "$MASTER_STATUS" | grep "Position:" | awk '{print $2}')

if [ -z "$MASTER_LOG_FILE" ] || [ -z "$MASTER_LOG_POS" ]; then
    echo "❌ 错误：无法获取主库状态"
    exit 1
fi

echo "主库日志文件: ${MASTER_LOG_FILE}"
echo "主库日志位置: ${MASTER_LOG_POS}"
echo ""

# ============================================
# 步骤2：配置从库（Web服务器）
# ============================================

echo "=========================================="
echo "步骤2：配置从库（Web服务器）"
echo "=========================================="


# 上传并执行从库配置脚本
echo "在Web服务器上配置从库..."
ssh ${WEB_USER}@${WEB_HOST} bash <<SLAVE_SCRIPT_EOF
set -e
MYSQL_ROOT_PASSWORD="$MYSQL_ROOT_PASSWORD"
MASTER_HOST="$APP_IP"
MASTER_USER="$REPL_USER"
MASTER_PASSWORD="$REPL_PASSWORD"
MASTER_LOG_FILE="$MASTER_LOG_FILE"
MASTER_LOG_POS="$MASTER_LOG_POS"
DATABASE_NAME="$DATABASE_NAME"
MYSQL_CONF="$MYSQL_CONF_WEB"

echo "配置MySQL从服务器..."

# 备份配置文件
if [ -f "\$MYSQL_CONF" ]; then
    cp "\$MYSQL_CONF" "\${MYSQL_CONF}.backup.\$(date +%Y%m%d_%H%M%S)"
fi

# 配置server-id
if grep -q "^server-id" "\$MYSQL_CONF" 2>/dev/null; then
    sed -i 's/^server-id.*/server-id = 2/' "\$MYSQL_CONF"
else
    echo "" >> "\$MYSQL_CONF"
    echo "# MySQL主从复制配置 - 从服务器" >> "\$MYSQL_CONF"
    echo "server-id = 2" >> "\$MYSQL_CONF"
fi

# 添加从库配置
if ! grep -q "^relay-log" "\$MYSQL_CONF" 2>/dev/null; then
    echo "relay-log = mysql-relay-bin" >> "\$MYSQL_CONF"
fi

if ! grep -q "^log-slave-updates" "\$MYSQL_CONF" 2>/dev/null; then
    echo "log-slave-updates = 1" >> "\$MYSQL_CONF"
fi

if ! grep -q "^read-only" "\$MYSQL_CONF" 2>/dev/null; then
    echo "read-only = 1" >> "\$MYSQL_CONF"
fi

if [ -n "\$DATABASE_NAME" ] && ! grep -q "^replicate-do-db" "\$MYSQL_CONF" 2>/dev/null; then
    echo "replicate-do-db = \${DATABASE_NAME}" >> "\$MYSQL_CONF"
fi

# 重启MySQL
systemctl restart mysql 2>/dev/null || systemctl restart mysqld 2>/dev/null
sleep 3

# 配置主从复制
mysql -u root -p"\${MYSQL_ROOT_PASSWORD}" <<SQL
STOP SLAVE;
CHANGE MASTER TO
    MASTER_HOST='\${MASTER_HOST}',
    MASTER_USER='\${MASTER_USER}',
    MASTER_PASSWORD='\${MASTER_PASSWORD}',
    MASTER_LOG_FILE='\${MASTER_LOG_FILE}',
    MASTER_LOG_POS=\${MASTER_LOG_POS};
START SLAVE;
SQL

echo "从库配置完成"
SLAVE_SCRIPT_EOF

if [ $? -eq 0 ]; then
    echo "✅ 从库配置完成"
else
    echo "❌ 从库配置失败"
    exit 1
fi

# 等待同步启动
echo "等待从库同步启动..."
sleep 5

# 检查从库状态
echo ""
echo "=========================================="
echo "检查从库同步状态..."
echo "=========================================="

SLAVE_STATUS=$(ssh ${WEB_USER}@${WEB_HOST} "mysql -u root -p'${MYSQL_ROOT_PASSWORD}' -e 'SHOW SLAVE STATUS\G' 2>/dev/null")
IO_RUNNING=$(echo "$SLAVE_STATUS" | grep "Slave_IO_Running:" | awk '{print $2}')
SQL_RUNNING=$(echo "$SLAVE_STATUS" | grep "Slave_SQL_Running:" | awk '{print $2}')
SECONDS_BEHIND=$(echo "$SLAVE_STATUS" | grep "Seconds_Behind_Master:" | awk '{print $2}')

echo "IO线程运行: ${IO_RUNNING}"
echo "SQL线程运行: ${SQL_RUNNING}"
echo "延迟时间: ${SECONDS_BEHIND} 秒"
echo ""

if [ "$IO_RUNNING" = "Yes" ] && [ "$SQL_RUNNING" = "Yes" ]; then
    echo "=========================================="
    echo "✅ 主从复制配置成功！"
    echo "=========================================="
    echo ""
    echo "配置信息："
    echo "  主库: ${APP_USER}@${APP_HOST} (${APP_IP})"
    echo "  从库: ${WEB_USER}@${WEB_HOST}"
    echo "  复制用户: ${REPL_USER}"
    echo "  复制密码: ${REPL_PASSWORD}"
    echo "  数据库: ${DATABASE_NAME}"
    echo ""
    echo "主从同步已启动，数据将自动从主库同步到从库"
else
    echo "=========================================="
    echo "⚠️  警告：主从同步可能存在问题"
    echo "=========================================="
    echo ""
    echo "请检查："
    echo "  1. 主库状态是否正常"
    echo "  2. 网络连接是否正常"
    echo "  3. 防火墙是否允许3306端口"
    echo "  4. MySQL错误日志"
    echo ""
    echo "查看从库详细状态："
    echo "  ssh ${WEB_USER}@${WEB_HOST} \"mysql -u root -p -e 'SHOW SLAVE STATUS\\G'\""
fi

