# MySQL主从复制配置说明

## 架构说明

- **主库（Master）**：root@app 服务器
- **从库（Slave）**：root@web 服务器
- **数据库名**：image_classifier

## 前置条件

1. ✅ 两个服务器已安装MySQL/MariaDB
2. ✅ SSH证书已配置，可以无密码登录
3. ✅ 两个服务器的MySQL root密码相同（或已知）
4. ✅ 防火墙允许3306端口（MySQL端口）

## ⚠️ 重要提示：MySQL与MariaDB兼容性

**如果主库是MySQL 8.0，从库是MariaDB 10.5（或反之），可能会遇到binlog兼容性问题。**

常见错误：
- `ERROR 1594: Relay log read failure: Could not parse relay log event entry`
- `ERROR 1236: Client requested source to start replication from position > file size`

**解决方案：**
1. 确保主库和从库的`server_id`不同（主库=1，从库=2）
2. 使用主库当前的`SHOW MASTER STATUS`位置，而不是历史位置
3. 如果持续出现1594错误，考虑：
   - 在主库设置`binlog_format=ROW`（更兼容）
   - 或暂时移除`replicate_do_db`限制进行测试
   - 或考虑升级/统一数据库版本

## 防火墙配置（重要！）

**主从复制需要从库能够连接到主库的MySQL端口（3306），因此必须配置防火墙规则。**

### 步骤1：在主库（App服务器）开放3306端口

```bash
# SSH登录到App服务器
ssh root@app

# 方式1：使用firewalld（CentOS/RHEL）
firewall-cmd --permanent --add-port=3306/tcp
firewall-cmd --reload
firewall-cmd --list-ports  # 验证端口已开放

# 方式2：使用ufw（Ubuntu/Debian）
ufw allow 3306/tcp
ufw reload
ufw status  # 验证端口已开放

# 方式3：使用iptables（通用）
iptables -A INPUT -p tcp --dport 3306 -j ACCEPT
iptables-save > /etc/iptables/rules.v4  # 保存规则（Debian/Ubuntu）
# 或
service iptables save  # 保存规则（CentOS/RHEL）
```

### 步骤2：检查MySQL是否监听外部连接

```bash
# 在主库检查MySQL监听地址
netstat -tlnp | grep 3306
# 或
ss -tlnp | grep 3306

# 如果只显示 127.0.0.1:3306，需要修改MySQL配置
# 编辑MySQL配置文件
vim /etc/mysql/mysql.conf.d/mysqld.cnf
# 或
vim /etc/my.cnf

# 找到并修改（或添加）：
# bind-address = 0.0.0.0  # 允许所有IP连接
# 或
# bind-address = 主库IP地址  # 只允许特定IP连接

# 重启MySQL
systemctl restart mysql
# 或
systemctl restart mysqld

# 再次检查
netstat -tlnp | grep 3306
# 应该显示 0.0.0.0:3306 或 主库IP:3306
```

### 步骤3：测试从库到主库的连接

```bash
# 在从库（Web服务器）测试连接
ssh root@web

# 测试能否连接到主库的MySQL端口
telnet 主库IP 3306
# 或
nc -zv 主库IP 3306

# 如果连接成功，说明防火墙配置正确
# 如果连接失败，检查：
# 1. 防火墙规则是否正确
# 2. MySQL是否监听外部连接
# 3. 云服务器安全组是否允许3306端口（如果使用云服务器）
```

### 云服务器额外配置

如果使用阿里云、腾讯云等云服务器，还需要在**云控制台**配置安全组规则：

1. 登录云服务器控制台
2. 找到App服务器的安全组
3. 添加入站规则：
   - 协议：TCP
   - 端口：3306
   - 源：Web服务器的IP地址（或0.0.0.0/0，不推荐）
   - 描述：MySQL主从复制

### 验证防火墙配置

```bash
# 在主库执行
ssh root@app "firewall-cmd --list-ports 2>/dev/null || ufw status 2>/dev/null || iptables -L -n | grep 3306"

# 在从库测试连接
ssh root@web "timeout 3 bash -c '</dev/tcp/主库IP/3306' && echo '连接成功' || echo '连接失败'"
```

## 配置步骤

### 方式1：使用自动化脚本（推荐）

```bash
# 1. 上传脚本到本地或任意服务器
cd tools/数据库

# 2. 编辑脚本，修改配置（可选）
# 如果服务器主机名不是app和web，需要修改：
# APP_HOST="your-app-host"
# WEB_HOST="your-web-host"

# 3. 执行配置脚本
bash setup-mysql-replication.sh
```

脚本会自动：
1. 检查SSH连接
2. 在App服务器配置主库
3. 在Web服务器配置从库
4. 自动获取主库日志文件和位置
5. 配置主从复制关系
6. 检查同步状态

### 方式2：手动配置

#### 步骤1：在App服务器（主库）配置

```bash
# SSH登录到App服务器
ssh root@app

# 执行主库配置脚本
bash setup-mysql-master.sh
```

记录输出的信息：
- 复制用户名和密码
- 主库日志文件（File）
- 主库日志位置（Position）

#### 步骤2：在Web服务器（从库）配置

```bash
# SSH登录到Web服务器
ssh root@web

# 编辑从库配置脚本
vim setup-mysql-slave.sh

# 修改以下变量：
# MASTER_HOST="app服务器的IP地址"
# MASTER_PASSWORD="步骤1中生成的复制用户密码"
# MASTER_LOG_FILE="步骤1中获取的日志文件"
# MASTER_LOG_POS="步骤1中获取的日志位置"

# 执行从库配置脚本
bash setup-mysql-slave.sh
```

## 验证配置

### 检查主库状态

```bash
ssh root@app "mysql -u root -p -e 'SHOW MASTER STATUS\G'"
```

### 检查从库状态

```bash
ssh root@web "mysql -u root -p -e 'SHOW SLAVE STATUS\G'"
```

关键字段：
- `Slave_IO_Running`: 应该是 `Yes`
- `Slave_SQL_Running`: 应该是 `Yes`
- `Seconds_Behind_Master`: 延迟秒数（应该接近0）

### 测试数据同步

```bash
# 在主库插入测试数据
ssh root@app "mysql -u root -p image_classifier -e \"INSERT INTO test_table VALUES (1, 'test');\""

# 在从库查询
ssh root@web "mysql -u root -p image_classifier -e \"SELECT * FROM test_table WHERE id=1;\""
```

## 常见问题

### 1. 从库无法连接主库

**检查项：**
- 主库MySQL端口是否开放（默认3306）
- 防火墙规则是否允许
- MySQL是否监听外部连接（bind-address配置）
- 云服务器安全组是否允许3306端口
- 复制用户权限是否正确

**解决方案：**
```bash
# 1. 在主库检查复制用户
mysql -u root -p -e "SELECT User, Host FROM mysql.user WHERE User='repl_user';"

# 2. 检查主库是否监听外部连接
netstat -tlnp | grep 3306
# 如果只显示 127.0.0.1:3306，需要修改MySQL配置：
# bind-address = 0.0.0.0

# 3. 检查防火墙规则
firewall-cmd --list-ports 2>/dev/null || ufw status 2>/dev/null || iptables -L -n | grep 3306

# 4. 在从库测试连接
telnet 主库IP 3306
# 或
nc -zv 主库IP 3306

# 5. 如果使用云服务器，检查安全组规则
```

### 2. 从库同步延迟

**可能原因：**
- 网络延迟
- 主库写入压力大
- 从库性能不足

**解决方案：**
- 检查网络连接质量
- 优化主库写入性能
- 提升从库硬件配置

### 3. 从库同步错误

**查看错误信息：**
```bash
ssh root@web "mysql -u root -p -e 'SHOW SLAVE STATUS\G' | grep Last_Error"
```

**常见错误：**
- 表不存在：需要先在从库创建表结构
- 数据冲突：需要重置从库或跳过错误

## 维护命令

### 停止从库同步

```bash
ssh root@web "mysql -u root -p -e 'STOP SLAVE;'"
```

### 启动从库同步

```bash
ssh root@web "mysql -u root -p -e 'START SLAVE;'"
```

### 重置从库

```bash
ssh root@web "mysql -u root -p <<EOF
STOP SLAVE;
RESET SLAVE;
CHANGE MASTER TO
    MASTER_HOST='主库IP',
    MASTER_USER='repl_user',
    MASTER_PASSWORD='复制密码',
    MASTER_LOG_FILE='日志文件',
    MASTER_LOG_POS=日志位置;
START SLAVE;
EOF"
```

### 查看同步延迟

```bash
ssh root@web "mysql -u root -p -e 'SHOW SLAVE STATUS\G' | grep Seconds_Behind_Master"
```

## 注意事项

1. ⚠️ **从库设置为只读**：从库配置了 `read-only=1`，防止误操作
2. ⚠️ **数据一致性**：配置主从复制前，确保从库数据为空或与主库一致
3. ⚠️ **备份重要**：配置前建议备份数据库
4. ⚠️ **网络稳定**：主从复制需要稳定的网络连接
5. ⚠️ **日志保留**：主库配置了7天日志保留，可根据需要调整

## 配置完成后

配置成功后，架构图中的主从复制关系将生效：
- 主库（App服务器）的所有写操作会自动同步到从库（Web服务器）
- 从库可以用于只读查询，减轻主库压力
- 数据通过主从复制自动同步

