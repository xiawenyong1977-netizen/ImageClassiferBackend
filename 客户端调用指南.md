# 客户端调用指南

## 📋 API基本信息

**服务器地址**：`http://123.57.68.4:8000`

**核心接口**：
1. `POST /api/v1/classify/check-cache` - 查询缓存（推荐先调用）
2. `POST /api/v1/classify` - 图片分类

---

## 🎯 推荐调用流程（最优化）

```
1. 客户端压缩图片（1024px, 80%质量）
   ↓
2. 计算SHA-256哈希
   ↓
3. 调用 /check-cache 查询缓存
   ├─ 缓存命中 → 直接使用结果 ✅（省带宽100%）
   └─ 缓存未命中 → 继续步骤4
   ↓
4. 调用 /classify 上传图片
   ↓
5. 获取分类结果
```

---

## 📱 各平台调用示例

### 1. JavaScript / TypeScript (Web / React Native)

#### 完整示例

```javascript
// ============================================
// 图片分类完整流程
// ============================================

const API_BASE_URL = 'http://123.57.68.4:8000';

/**
 * 分类映射表（客户端维护）
 */
const categoryMap = {
  "social_activities": "社交活动",
  "pets": "宠物萌照",
  "single_person": "单人照片",
  "foods": "美食记录",
  "travel_scenery": "旅行风景",
  "screenshot": "手机截图",
  "idcard": "证件照",
  "other": "其它"
};

/**
 * 计算SHA-256哈希
 */
async function calculateSHA256(imageFile) {
  const arrayBuffer = await imageFile.arrayBuffer();
  const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  return hashHex;
}

/**
 * 压缩图片（可选但推荐）
 */
async function compressImage(imageFile) {
  // 使用第三方库如 browser-image-compression
  // npm install browser-image-compression
  const imageCompression = require('browser-image-compression');
  
  const options = {
    maxSizeMB: 0.5,          // 最大0.5MB
    maxWidthOrHeight: 1024,  // 最大1024px
    useWebWorker: true
  };
  
  return await imageCompression(imageFile, options);
}

/**
 * 查询缓存
 */
async function checkCache(imageHash, userId = null) {
  const response = await fetch(`${API_BASE_URL}/api/v1/classify/check-cache`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-User-ID': userId || ''
    },
    body: JSON.stringify({
      image_hash: imageHash
    })
  });
  
  return await response.json();
}

/**
 * 上传图片分类
 */
async function uploadAndClassify(imageFile, imageHash = null, userId = null) {
  const formData = new FormData();
  formData.append('image', imageFile);
  
  if (imageHash) {
    formData.append('image_hash', imageHash);
  }
  
  const headers = {};
  if (userId) {
    headers['X-User-ID'] = userId;
  }
  
  const response = await fetch(`${API_BASE_URL}/api/v1/classify`, {
    method: 'POST',
    headers: headers,
    body: formData
  });
  
  return await response.json();
}

/**
 * 完整的图片分类流程（推荐使用）
 */
async function classifyImage(imageFile, userId = null) {
  try {
    console.log('🔧 开始处理图片...');
    
    // 步骤1: 压缩图片
    const compressed = await compressImage(imageFile);
    console.log(`📊 原始大小: ${imageFile.size / 1024}KB, 压缩后: ${compressed.size / 1024}KB`);
    
    // 步骤2: 计算哈希
    const imageHash = await calculateSHA256(compressed);
    console.log(`🔑 哈希: ${imageHash.substring(0, 16)}...`);
    
    // 步骤3: 查询缓存
    console.log('🔍 查询缓存...');
    const cacheResult = await checkCache(imageHash, userId);
    
    if (cacheResult.cached) {
      // 缓存命中！
      console.log('✅ 缓存命中！节省上传带宽');
      return {
        ...cacheResult.data,
        category_name: categoryMap[cacheResult.data.category],
        from_cache: true,
        request_id: cacheResult.request_id
      };
    }
    
    // 步骤4: 缓存未命中，上传图片
    console.log('⬆️  上传图片分类...');
    const result = await uploadAndClassify(compressed, imageHash, userId);
    
    if (result.success) {
      console.log('✅ 分类成功:', result.data.category);
      return {
        ...result.data,
        category_name: categoryMap[result.data.category],
        from_cache: result.from_cache,
        request_id: result.request_id,
        processing_time_ms: result.processing_time_ms
      };
    } else {
      throw new Error(result.error || '分类失败');
    }
    
  } catch (error) {
    console.error('❌ 分类失败:', error);
    throw error;
  }
}

/**
 * 使用示例
 */
async function example() {
  const fileInput = document.getElementById('image-input');
  const imageFile = fileInput.files[0];
  
  if (!imageFile) {
    alert('请选择图片');
    return;
  }
  
  try {
    const result = await classifyImage(imageFile, 'device-uuid-123');
    
    console.log('分类结果:', {
      category: result.category,           // "foods"
      category_name: result.category_name, // "美食记录"
      confidence: result.confidence,       // 0.92
      description: result.description,     // "一盘美味的..."
      from_cache: result.from_cache,       // true/false
      request_id: result.request_id        // "req_xxx"
    });
    
    // 显示结果
    alert(`分类：${result.category_name}\n置信度：${(result.confidence * 100).toFixed(1)}%`);
    
  } catch (error) {
    alert('分类失败: ' + error.message);
  }
}
```

---

### 2. React Native

```javascript
import CryptoJS from 'crypto-js';
import ImageResizer from 'react-native-image-resizer';
import { Platform } from 'react-native';

const API_BASE_URL = 'http://123.57.68.4:8000';

/**
 * 计算SHA-256哈希（React Native）
 */
async function calculateSHA256(imageUri) {
  const response = await fetch(imageUri);
  const blob = await response.blob();
  const arrayBuffer = await blob.arrayBuffer();
  const wordArray = CryptoJS.lib.WordArray.create(arrayBuffer);
  return CryptoJS.SHA256(wordArray).toString();
}

/**
 * 压缩图片（React Native）
 */
async function compressImage(imageUri) {
  const result = await ImageResizer.createResizedImage(
    imageUri,
    1024,      // 最大宽度
    1024,      // 最大高度
    'JPEG',    // 格式
    80,        // 质量
    0,         // 旋转
    null,
    false,
    { mode: 'contain', onlyScaleDown: true }
  );
  
  return result;
}

/**
 * 完整分类流程（React Native）
 */
async function classifyImage(imageUri, userId) {
  try {
    // 1. 压缩图片
    const compressed = await compressImage(imageUri);
    
    // 2. 计算哈希
    const imageHash = await calculateSHA256(compressed.uri);
    
    // 3. 查询缓存
    const cacheResponse = await fetch(`${API_BASE_URL}/api/v1/classify/check-cache`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-User-ID': userId,
      },
      body: JSON.stringify({ image_hash: imageHash }),
    });
    
    const cacheResult = await cacheResponse.json();
    
    if (cacheResult.cached) {
      // 缓存命中
      return {
        ...cacheResult.data,
        from_cache: true
      };
    }
    
    // 4. 上传图片
    const formData = new FormData();
    formData.append('image', {
      uri: compressed.uri,
      type: 'image/jpeg',
      name: 'image.jpg',
    });
    formData.append('image_hash', imageHash);
    
    const uploadResponse = await fetch(`${API_BASE_URL}/api/v1/classify`, {
      method: 'POST',
      headers: {
        'X-User-ID': userId,
      },
      body: formData,
    });
    
    const result = await uploadResponse.json();
    return result.data;
    
  } catch (error) {
    console.error('分类失败:', error);
    throw error;
  }
}

/**
 * React组件使用示例
 */
import React, { useState } from 'react';
import { View, Button, Image, Text } from 'react-native';
import { launchImageLibrary } from 'react-native-image-picker';

function ImageClassifier() {
  const [result, setResult] = useState(null);
  const [loading, setLoading] = useState(false);
  
  const pickAndClassify = async () => {
    // 选择图片
    const response = await launchImageLibrary({
      mediaType: 'photo',
      quality: 0.8,
    });
    
    if (response.didCancel) return;
    
    const imageUri = response.assets[0].uri;
    
    // 分类
    setLoading(true);
    try {
      const result = await classifyImage(imageUri, 'device-uuid-123');
      setResult(result);
      
      alert(`分类结果：${categoryMap[result.category]}`);
    } catch (error) {
      alert('分类失败: ' + error.message);
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <View>
      <Button 
        title={loading ? "分类中..." : "选择图片并分类"} 
        onPress={pickAndClassify}
        disabled={loading}
      />
      {result && (
        <View>
          <Text>类别：{categoryMap[result.category]}</Text>
          <Text>置信度：{(result.confidence * 100).toFixed(1)}%</Text>
          <Text>描述：{result.description}</Text>
        </View>
      )}
    </View>
  );
}
```

---

### 3. Flutter / Dart

```dart
import 'dart:io';
import 'dart:convert';
import 'package:crypto/crypto.dart';
import 'package:http/http.dart' as http;
import 'package:flutter_image_compress/flutter_image_compress.dart';

const API_BASE_URL = 'http://123.57.68.4:8000';

// 分类映射
const categoryMap = {
  "social_activities": "社交活动",
  "pets": "宠物萌照",
  "single_person": "单人照片",
  "foods": "美食记录",
  "travel_scenery": "旅行风景",
  "screenshot": "手机截图",
  "idcard": "证件照",
  "other": "其它"
};

/// 计算SHA-256哈希
String calculateSHA256(List<int> bytes) {
  return sha256.convert(bytes).toString();
}

/// 压缩图片
Future<List<int>> compressImage(String imagePath) async {
  final result = await FlutterImageCompress.compressWithFile(
    imagePath,
    minWidth: 1024,
    minHeight: 1024,
    quality: 80,
    format: CompressFormat.jpeg,
  );
  return result!;
}

/// 查询缓存
Future<Map<String, dynamic>?> checkCache(String imageHash, String userId) async {
  final response = await http.post(
    Uri.parse('$API_BASE_URL/api/v1/classify/check-cache'),
    headers: {
      'Content-Type': 'application/json',
      'X-User-ID': userId,
    },
    body: jsonEncode({
      'image_hash': imageHash,
    }),
  );
  
  final result = jsonDecode(response.body);
  
  if (result['cached'] == true) {
    return result['data'];
  }
  return null;
}

/// 上传图片分类
Future<Map<String, dynamic>> uploadAndClassify(
  List<int> imageBytes,
  String imageHash,
  String userId,
) async {
  final request = http.MultipartRequest(
    'POST',
    Uri.parse('$API_BASE_URL/api/v1/classify'),
  );
  
  request.headers['X-User-ID'] = userId;
  request.fields['image_hash'] = imageHash;
  request.files.add(
    http.MultipartFile.fromBytes(
      'image',
      imageBytes,
      filename: 'image.jpg',
    ),
  );
  
  final streamedResponse = await request.send();
  final response = await http.Response.fromStream(streamedResponse);
  final result = jsonDecode(response.body);
  
  return result['data'];
}

/// 完整的分类流程
Future<Map<String, dynamic>> classifyImage(
  String imagePath,
  String userId,
) async {
  try {
    print('🔧 压缩图片...');
    final compressedBytes = await compressImage(imagePath);
    print('📊 压缩后大小: ${compressedBytes.length / 1024}KB');
    
    print('🔐 计算哈希...');
    final imageHash = calculateSHA256(compressedBytes);
    print('🔑 哈希: ${imageHash.substring(0, 16)}...');
    
    print('🔍 查询缓存...');
    final cachedResult = await checkCache(imageHash, userId);
    
    if (cachedResult != null) {
      print('✅ 缓存命中！');
      return {
        ...cachedResult,
        'category_name': categoryMap[cachedResult['category']],
        'from_cache': true,
      };
    }
    
    print('⬆️  上传图片...');
    final result = await uploadAndClassify(compressedBytes, imageHash, userId);
    
    print('✅ 分类完成: ${result['category']}');
    return {
      ...result,
      'category_name': categoryMap[result['category']],
      'from_cache': false,
    };
    
  } catch (error) {
    print('❌ 分类失败: $error');
    rethrow;
  }
}

/// Flutter Widget示例
class ImageClassifierWidget extends StatefulWidget {
  @override
  _ImageClassifierWidgetState createState() => _ImageClassifierWidgetState();
}

class _ImageClassifierWidgetState extends State<ImageClassifierWidget> {
  Map<String, dynamic>? result;
  bool loading = false;
  
  Future<void> pickAndClassify() async {
    // 选择图片
    final ImagePicker picker = ImagePicker();
    final XFile? image = await picker.pickImage(source: ImageSource.gallery);
    
    if (image == null) return;
    
    // 分类
    setState(() => loading = true);
    
    try {
      final classificationResult = await classifyImage(
        image.path,
        'device-uuid-123',
      );
      
      setState(() {
        result = classificationResult;
        loading = false;
      });
      
      // 显示结果
      showDialog(
        context: context,
        builder: (context) => AlertDialog(
          title: Text('分类结果'),
          content: Text(
            '类别：${classificationResult['category_name']}\n'
            '置信度：${(classificationResult['confidence'] * 100).toStringAsFixed(1)}%\n'
            '描述：${classificationResult['description'] ?? ''}'
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: Text('确定'),
            ),
          ],
        ),
      );
      
    } catch (error) {
      setState(() => loading = false);
      showDialog(
        context: context,
        builder: (context) => AlertDialog(
          title: Text('错误'),
          content: Text('分类失败: $error'),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: Text('确定'),
            ),
          ],
        ),
      );
    }
  }
  
  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        ElevatedButton(
          onPressed: loading ? null : pickAndClassify,
          child: Text(loading ? '分类中...' : '选择图片并分类'),
        ),
        if (result != null)
          Padding(
            padding: EdgeInsets.all(16),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text('类别：${result!['category_name']}', 
                  style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
                Text('置信度：${(result!['confidence'] * 100).toStringAsFixed(1)}%'),
                if (result!['description'] != null)
                  Text('描述：${result!['description']}'),
                Text('来源：${result!['from_cache'] ? '缓存' : '大模型'}'),
              ],
            ),
          ),
      ],
    );
  }
}
```

---

### 4. Python客户端

```python
import requests
import hashlib
from PIL import Image
import io

API_BASE_URL = "http://123.57.68.4:8000"

# 分类映射
CATEGORY_MAP = {
    "social_activities": "社交活动",
    "pets": "宠物萌照",
    "single_person": "单人照片",
    "foods": "美食记录",
    "travel_scenery": "旅行风景",
    "screenshot": "手机截图",
    "idcard": "证件照",
    "other": "其它"
}

def calculate_sha256(image_bytes):
    """计算SHA-256哈希"""
    return hashlib.sha256(image_bytes).hexdigest()

def compress_image(image_path, max_size_kb=500):
    """压缩图片"""
    img = Image.open(image_path)
    
    # 调整尺寸
    if max(img.size) > 1024:
        ratio = 1024 / max(img.size)
        new_size = tuple(int(dim * ratio) for dim in img.size)
        img = img.resize(new_size, Image.LANCZOS)
    
    # 压缩
    output = io.BytesIO()
    img.save(output, format='JPEG', quality=80, optimize=True)
    return output.getvalue()

def check_cache(image_hash, user_id=None):
    """查询缓存"""
    headers = {}
    if user_id:
        headers['X-User-ID'] = user_id
    
    response = requests.post(
        f"{API_BASE_URL}/api/v1/classify/check-cache",
        headers=headers,
        json={"image_hash": image_hash}
    )
    
    result = response.json()
    return result.get('data') if result.get('cached') else None

def upload_and_classify(image_bytes, image_hash=None, user_id=None):
    """上传图片分类"""
    files = {'image': ('image.jpg', image_bytes, 'image/jpeg')}
    data = {}
    headers = {}
    
    if image_hash:
        data['image_hash'] = image_hash
    if user_id:
        headers['X-User-ID'] = user_id
    
    response = requests.post(
        f"{API_BASE_URL}/api/v1/classify",
        headers=headers,
        files=files,
        data=data
    )
    
    result = response.json()
    return result.get('data')

def classify_image(image_path, user_id=None):
    """完整的图片分类流程"""
    print(f"🔧 处理图片: {image_path}")
    
    # 1. 压缩
    image_bytes = compress_image(image_path)
    print(f"📊 压缩后大小: {len(image_bytes) / 1024:.2f}KB")
    
    # 2. 计算哈希
    image_hash = calculate_sha256(image_bytes)
    print(f"🔑 哈希: {image_hash[:16]}...")
    
    # 3. 查询缓存
    print("🔍 查询缓存...")
    cached_result = check_cache(image_hash, user_id)
    
    if cached_result:
        print("✅ 缓存命中！")
        cached_result['from_cache'] = True
        cached_result['category_name'] = CATEGORY_MAP.get(cached_result['category'])
        return cached_result
    
    # 4. 上传分类
    print("⬆️  上传图片...")
    result = upload_and_classify(image_bytes, image_hash, user_id)
    result['from_cache'] = False
    result['category_name'] = CATEGORY_MAP.get(result['category'])
    
    print(f"✅ 分类完成: {result['category_name']}")
    return result

# 使用示例
if __name__ == "__main__":
    result = classify_image("test.jpg", user_id="python-client-001")
    
    print(f"\n分类结果：")
    print(f"  类别: {result['category_name']}")
    print(f"  Key: {result['category']}")
    print(f"  置信度: {result['confidence'] * 100:.1f}%")
    print(f"  描述: {result.get('description', '')}")
    print(f"  来源: {'缓存' if result['from_cache'] else '大模型'}")
```

---

### 5. curl命令行测试

#### 测试1：查询缓存

```bash
curl -X POST "http://123.57.68.4:8000/api/v1/classify/check-cache" \
  -H "Content-Type: application/json" \
  -H "X-User-ID: test-user-001" \
  -d '{"image_hash": "abc123def456..."}'
```

#### 测试2：上传图片分类

```bash
curl -X POST "http://123.57.68.4:8000/api/v1/classify" \
  -H "X-User-ID: test-user-001" \
  -F "image=@test.jpg"
```

#### 测试3：带哈希上传

```bash
curl -X POST "http://123.57.68.4:8000/api/v1/classify" \
  -H "X-User-ID: test-user-001" \
  -F "image=@test.jpg" \
  -F "image_hash=abc123def456..."
```

---

## 📊 分类结果处理

### 响应格式

```json
{
  "success": true,
  "data": {
    "category": "foods",
    "confidence": 0.92,
    "description": "一盘美味的意大利面"
  },
  "from_cache": false,
  "processing_time_ms": 1523,
  "request_id": "req_1696934400_abc123",
  "timestamp": "2025-10-10T12:00:00Z"
}
```

### 客户端处理

```javascript
function handleClassificationResult(response) {
  if (!response.success) {
    console.error('分类失败:', response.error);
    return;
  }
  
  const data = response.data;
  
  // 获取中文名称
  const categoryName = categoryMap[data.category];
  
  // 显示给用户
  console.log({
    category: data.category,        // "foods"
    categoryName: categoryName,     // "美食记录"
    confidence: data.confidence,    // 0.92
    confidencePercent: (data.confidence * 100).toFixed(1) + '%',  // "92.0%"
    description: data.description,  // "一盘美味的..."
    fromCache: response.from_cache, // false
    processingTime: response.processing_time_ms + 'ms',  // "1523ms"
    requestId: response.request_id  // "req_xxx"
  });
  
  // 根据类别做不同处理
  switch (data.category) {
    case 'foods':
      // 美食照片，可以推荐美食相关功能
      break;
    case 'pets':
      // 宠物照片，可以推荐宠物相关功能
      break;
    case 'travel_scenery':
      // 风景照片，可以推荐旅行相关功能
      break;
    // ... 其他分类
  }
}
```

---

## 🔑 重要参数说明

### user_id（可选）

**作用**：
- 用于统计分析
- 区分不同用户
- 记录请求历史

**生成方式**：
```javascript
// 首次启动时生成并保存
let userId = localStorage.getItem('device_id');
if (!userId) {
  userId = 'device-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
  localStorage.setItem('device_id', userId);
}
```

### image_hash（可选但推荐）

**作用**：
- 避免服务端重复计算哈希
- 提升性能

**什么时候传**：
- 如果已经调用过`/check-cache`，哈希已计算，建议传递
- 如果直接调用`/classify`，可以不传

---

## ⚡ 性能优化建议

### 1. 客户端压缩

```javascript
// 推荐参数
{
  maxWidth: 1024,
  maxHeight: 1024,
  quality: 0.8,        // 80%质量
  format: 'JPEG'       // 统一格式
}
```

### 2. 缓存策略

```javascript
// 先查缓存再上传
if (await checkCache(hash)) {
  return result;  // 节省100%带宽
}
await uploadImage();
```

### 3. 错误处理

```javascript
try {
  const result = await classifyImage(image);
} catch (error) {
  if (error.status === 401) {
    // API密钥无效
  } else if (error.status === 413) {
    // 图片过大
  } else {
    // 其他错误
  }
}
```

---

## 📱 移动端最佳实践

### 网络判断

```javascript
// 根据网络状况调整压缩质量
const networkType = await getNetworkType();

let quality;
if (networkType === 'wifi') {
  quality = 0.85;  // WiFi下高质量
} else if (networkType === '4g') {
  quality = 0.75;  // 4G下中等
} else {
  quality = 0.6;   // 2G/3G低质量
}
```

### 进度提示

```javascript
// 显示处理进度
showProgress('压缩图片中...');
const compressed = await compressImage(image);

showProgress('计算哈希...');
const hash = await calculateSHA256(compressed);

showProgress('查询缓存...');
const cached = await checkCache(hash);

if (!cached) {
  showProgress('上传分类中...');
  await uploadAndClassify(compressed);
}

hideProgress();
```

---

## 🔍 调试技巧

### 查看完整响应

```javascript
const response = await fetch(API_URL, {...});
const text = await response.text();
console.log('原始响应:', text);
const json = JSON.parse(text);
```

### 记录请求ID

```javascript
// 保存请求ID用于追踪
const result = await classifyImage(image);
console.log('请求ID:', result.request_id);

// 遇到问题时提供request_id
if (error) {
  reportError({
    requestId: result.request_id,
    error: error.message
  });
}
```

---

## ⚠️ 注意事项

1. **API地址**
   - 开发：`http://123.57.68.4:8000`
   - 生产：建议使用域名或HTTPS

2. **图片大小**
   - 最大：10MB
   - 推荐：压缩到500KB以内

3. **支持格式**
   - JPG/JPEG
   - PNG
   - WebP
   - GIF

4. **超时设置**
   - 建议：30秒
   - 大模型调用可能需要5-15秒

5. **错误处理**
   - 始终添加try-catch
   - 显示友好的错误提示

---

## 📞 获取帮助

- **API文档**：http://123.57.68.4:8000/docs
- **在线测试**：http://123.57.68.4:8000/（Web界面）
- **设计文档**：查看 `DESIGN.md`

---

**现在您可以在任何平台的客户端中集成图片分类功能了！** 🚀

有问题随时参考这个文档或在线API文档！
