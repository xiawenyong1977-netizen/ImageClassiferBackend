# 支付回调配置检查指南

## 问题现象

点击"立即开通"后提示错误，可能是支付回调URL配置问题。

## 检查清单

### 1. 检查环境变量配置

检查 `.env` 文件中的支付回调URL配置：

```bash
WECHAT_PAY_NOTIFY_URL=https://www.xintuxiangce.top/api/v1/payment/notify
```

**重要检查点：**
- ✅ URL 必须是 HTTPS（微信要求）
- ✅ URL 必须可公网访问
- ✅ 路径为：`/api/v1/payment/notify`
- ✅ 域名正确：`www.xintuxiangce.top`

### 2. 检查代码中使用的URL

在 `app/config.py` 第 111-113 行：
```python
WECHAT_PAY_NOTIFY_URL: str = Field(
    default="https://your-domain.com/api/v1/payment/notify",
    description="微信支付回调URL"
)
```

在 `app/api/payment.py` 第 94 行使用：
```python
'notify_url': settings.WECHAT_PAY_NOTIFY_URL,
```

### 3. 检查回调路由是否正确注册

在 `app/main.py` 第 91 行已注册 payment 路由：
```python
app.include_router(payment.router)  # 支付功能
```

路由前缀在 `app/api/payment.py` 第 25 行：
```python
router = APIRouter(prefix="/api/v1/payment", tags=["支付"])
```

回调接口在 `app/api/payment.py` 第 214 行：
```python
@router.post("/notify", summary="微信支付回调通知")
async def payment_notify(request: Request):
```

完整URL：`/api/v1/payment/notify`

### 4. 在微信支付商户后台配置

需要在商户后台配置两个URL：

#### 4.1 配置支付授权目录（重要！）

1. 登录微信支付商户平台：https://pay.weixin.qq.com/
2. 进入：**产品中心** → **开发配置** → **支付配置** → **JSAPI支付**
3. 找到 **"支付授权目录"** 配置
4. 添加支付授权目录：
   ```
   https://www.xintuxiangce.top/
   ```
   **注意：** 
   - 必须以 `/` 结尾
   - 只填写域名和根路径，不要包含具体文件名
   - 这个配置用于允许哪些页面可以调起微信支付

#### 4.2 配置支付回调URL

1. 在同一页面找到 **"支付回调URL"** 或 **"通知地址"** 配置
2. 添加回调地址：
   ```
   https://www.xintuxiangce.top/api/v1/payment/notify
   ```
   **注意：**
   - 这是用于接收支付成功后的异步通知
   - 必须是 HTTPS
   - 必须可公网访问

### 5. 验证回调URL是否可访问

使用 curl 测试回调URL：

```bash
curl -X POST https://www.xintuxiangce.top/api/v1/payment/notify \
  -H "Content-Type: application/xml" \
  -d '<xml></xml>'
```

**预期结果：** 应该返回有效的 XML 响应（即使失败）

### 6. 检查服务器日志

查看创建订单时的日志，应该看到：
```
支付回调URL配置: https://www.xintuxiangce.top/api/v1/payment/notify
调用微信支付统一下单: order_no=..., notify_url=..., openid=...
```

### 7. 常见错误

#### 错误 1: 回调URL无法访问
**症状：** 微信无法访问回调URL  
**解决：** 检查防火墙、nginx配置，确保可公网访问

#### 错误 2: 回调URL返回404
**症状：** 路由不存在  
**解决：** 检查路由注册、URL路径是否正确

#### 错误 3: 回调URL返回500
**症状：** 服务器内部错误  
**解决：** 查看服务器日志，检查代码错误

#### 错误 4: 域名未在白名单
**症状：** 微信拒绝回调  
**解决：** 在微信支付商户后台添加域名白名单

## 调试步骤

### 步骤 1: 查看创建订单日志

当用户点击"立即开通"时，浏览器控制台应该显示：
```
开始创建订单，openid: xxx...
请求参数: {order_type: 'member'}
响应状态: 200
创建订单响应: {success: true, order_no: '...', payment_params: {...}}
订单创建成功，准备调起支付
```

服务器日志应该显示：
```
创建订单成功: order_no=..., openid=..., type=member, amount=29.9
准备调用微信支付接口，描述=会员开通
支付回调URL配置: https://www.xintuxiangce.top/api/v1/payment/notify
调用微信支付统一下单: ...
微信支付接口调用成功，返回prepay_id
```

### 步骤 2: 查看微信支付回调日志

支付成功后，服务器日志应该显示：
```
收到支付回调，数据长度: xxx
支付成功: order_no=..., transaction_id=..., amount=29.9
```

### 步骤 3: 排查问题

如果支付回调失败：

1. 检查回调URL是否正确
2. 检查域名是否在白名单
3. 检查回调路由是否可访问
4. 查看服务器错误日志

## 已添加的调试日志

### 前端 (web/member.html)

- ✅ 显示当前URL和code参数
- ✅ 显示授权响应
- ✅ 显示获取到的openid
- ✅ 显示创建订单请求参数
- ✅ 显示创建订单响应
- ✅ 显示错误信息

### 后端 (app/api/payment.py)

- ✅ 记录支付回调URL配置
- ✅ 记录调用微信支付的参数
- ✅ 记录支付回调请求
- ✅ 记录订单创建和更新

## 测试步骤

1. 打开公众号菜单"开通会员"
2. 打开浏览器开发者工具（F12）
3. 查看Console标签
4. 点击"立即开通"
5. 观察日志输出：
   - 是否成功获取openid
   - 是否成功创建订单
   - 是否成功调起支付
   - 是否有错误信息

6. 查看服务器日志
7. 完成支付后查看回调日志

## 相关文件

- `app/api/payment.py` - 支付接口
- `app/config.py` - 配置管理
- `web/member.html` - 会员开通页面
- `env.example` - 环境变量示例

