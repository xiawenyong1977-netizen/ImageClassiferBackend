# 微信扫码关注功能部署指南

## 一、数据库更新

需要在服务器上执行以下 SQL 文件：

### 1. 如果还没有 wechat_users 表，执行：
```bash
mysql -u root -p your_database < sql/add_wechat_users.sql
```

### 2. 创建二维码绑定表（必须执行）：
```bash
mysql -u root -p your_database < sql/add_wechat_qrcode_bindings.sql
```

### 3. 或者直接登录 MySQL 执行：
```sql
-- 创建微信二维码绑定表
CREATE TABLE IF NOT EXISTS `wechat_qrcode_bindings` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `client_id` VARCHAR(128) NOT NULL COMMENT '客户端ID',
  `scene_id` INT NOT NULL COMMENT '二维码场景值',
  `openid` VARCHAR(64) DEFAULT NULL COMMENT '用户openid（扫码关注后填入）',
  `status` ENUM('pending', 'completed', 'expired') DEFAULT 'pending' COMMENT '状态',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `completed_at` TIMESTAMP NULL DEFAULT NULL COMMENT '完成时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_client_id` (`client_id`),
  KEY `idx_scene_id` (`scene_id`),
  KEY `idx_openid` (`openid`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='微信二维码绑定表';
```

## 二、上传代码

### 需要更新的文件：
1. `app/api/auth.py` - 微信认证相关API
2. `app/api/user.py` - 用户相关API（如果已存在）
3. `app/api/image_edit.py` - 图片编辑API（需要添加 openid 参数）
4. `app/services/image_editor.py` - 图片编辑服务（需要添加额度检查）
5. `app/main.py` - 主程序（需要注册新路由）
6. `app/config.py` - 配置文件（需要添加微信配置）

### 上传方式：
```bash
# 使用 SCP 上传
scp app/api/auth.py root@your_server:/path/to/ImageClassifierBackend/app/api/
scp app/api/user.py root@your_server:/path/to/ImageClassifierBackend/app/api/
scp app/api/image_edit.py root@your_server:/path/to/ImageClassifierBackend/app/api/
scp app/services/image_editor.py root@your_server:/path/to/ImageClassifierBackend/app/services/
scp app/main.py root@your_server:/path/to/ImageClassifierBackend/app/
scp app/config.py root@your_server:/path/to/ImageClassifierBackend/app/
```

## 三、配置微信公众号

### 1. 登录微信公众平台
访问：https://mp.weixin.qq.com/

### 2. 设置服务器配置
- 进入「开发」-「基本配置」
- 填写「服务器配置」：
  - **URL**: `https://admin.xintuxiangce.top/api/v1/auth/wechat/verify`
    > **注意**：只需要配置一个URL，微信会向这个URL同时发送GET和POST请求：
    > - GET 请求用于服务器验证（配置时触发）
    > - POST 请求用于消息推送（用户关注/操作时触发）
  - **Token**: 在 `auth_config.txt` 或环境变量中设置
  - **EncodingAESKey**: 留空（使用明文模式）
  - **消息加解密方式**: 选择「明文模式」

### 3. 确认配置
- 点击「提交」，微信会向您的服务器发送一个GET请求进行验证
- 验证成功后，启动服务器配置
- 之后用户操作时会通过POST请求推送消息

## 四、环境变量配置

确保服务器上的 `.env` 文件包含微信配置：

```bash
WECHAT_APPID=your_appid
WECHAT_SECRET=your_secret
WECHAT_TOKEN=your_token
```

## 五、重启服务

```bash
# 进入项目目录
cd /path/to/ImageClassifierBackend

# 重启服务
bash deploy-to-server.sh

# 或者手动重启
sudo systemctl restart imageclassifier
# 或
pm2 restart imageclassifier
```

## 六、测试

### 1. 测试生成二维码接口
```bash
curl -X POST https://admin.xintuxiangce.top/api/v1/auth/wechat/qrcode \
  -H "Content-Type: application/json" \
  -d '{"client_id": "test_pc_001"}'
```

### 2. 测试检查关注状态
```bash
curl "https://admin.xintuxiangce.top/api/v1/auth/wechat/check-follow?client_id=test_pc_001"
```

### 3. 完整流程测试
1. 客户端调用生成二维码接口，获得 `qrcode_url`
2. 显示二维码给用户
3. 用户扫码关注公众号
4. 客户端轮询检查关注状态接口
5. 获得 `openid` 后，使用图片编辑功能

## 七、API 端点汇总

### 认证相关
- `POST /api/v1/auth/wechat/qrcode` - 生成二维码
- `GET /api/v1/auth/wechat/check-follow` - 检查关注状态
- `GET /api/v1/auth/wechat/verify` - 微信服务器验证（GET）
- `POST /api/v1/auth/wechat/verify` - 微信消息推送（POST）

### 用户相关
- `GET /api/v1/user/credits` - 查询用户额度

### 图片编辑
- `POST /api/v1/image-edit/submit` - 提交编辑任务（需要 Header: `X-WeChat-OpenID`）

## 八、常见问题

### 1. 微信服务器验证失败
- 检查 Token 是否配置正确
- 检查服务器URL是否可以访问
- 检查是否返回 PlainTextResponse

### 2. 用户关注后无法绑定
- 检查数据库 `wechat_qrcode_bindings` 表是否存在
- 检查 scene_id 映射是否正确
- 查看服务器日志

### 3. 额度扣减失败
- 检查 `wechat_users` 表是否存在
- 检查 openid 是否正确传递
- 检查数据库事务是否正常提交

## 九、注意事项

1. **scene_id 唯一性**：使用时间戳作为 scene_id，确保唯一性
2. **二维码过期**：当前设置为30天有效期
3. **并发安全**：同一个 client_id 只能绑定一个 openid
4. **额度管理**：额度按 openid 统一管理，多个 client_id 共享同一额度
