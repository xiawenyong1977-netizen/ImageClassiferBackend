# 微信支付测试指南

## 📋 测试前准备

### 1. 确认商户平台配置

登录 [微信支付商户平台](https://pay.weixin.qq.com/)，检查：

- ✅ **商户号**: `1731030428`
- ✅ **API密钥**: 已配置
- ✅ **授权目录**: `https://www.xintuxiangce.top/api/v1/`
- ✅ **回调URL**: `https://www.xintuxiangce.top/api/v1/payment/notify`

### 2. 开通JSAPI支付

在商户平台中：

1. 进入 **产品中心** > **我的产品**
2. 查看是否有 **JSAPI支付** 产品
3. 如果没有，点击 **开通**
4. 按照提示完成开通流程

## 🧪 测试支付功能

### 方式1：直接测试创建订单接口

使用Postman或curl测试接口（需要先关注公众号获取openid）：

```bash
curl -X POST https://www.xintuxiangce.top/api/v1/payment/create-order \
  -H "Content-Type: application/json" \
  -H "X-WeChat-OpenID: your_openid_here" \
  -d '{
    "order_type": "member",
    "credits_amount": null
  }'
```

### 方式2：沙箱环境测试（推荐）

在正式环境测试前，建议先在沙箱环境测试：

1. 在商户平台进入 **开发配置** > **沙箱环境**
2. 获取沙箱环境的API密钥
3. 使用沙箱参数测试

## 📝 测试流程

1. **调用创建订单接口**
   - POST `/api/v1/payment/create-order`
   - 返回 `payment_params`

2. **在前端调起微信支付**
   ```javascript
   WeixinJSBridge.invoke('getBrandWCPayRequest', {
       appId: payment_params.appId,
       timeStamp: payment_params.timeStamp,
       nonceStr: payment_params.nonceStr,
       package: payment_params.package,
       signType: payment_params.signType,
       paySign: payment_params.paySign
   }, function(res) {
       if (res.err_msg == "get_brand_wcpay_request:ok") {
           // 支付成功
       }
   });
   ```

3. **验证回调**
   - 支付成功后，微信会回调 `/api/v1/payment/notify`
   - 检查订单状态是否更新

## ⚠️ 注意事项

1. **必须关注公众号**：JSAPI支付需要在公众号内完成
2. **测试账号**：使用你的微信扫码关注后测试
3. **真实金额**：正式环境会产生真实扣费，建议先用1分钱测试

## 🔍 常见问题

**Q: 提示"未开通JSAPI支付"怎么办？**
A: 需要先在商户平台申请开通JSAPI支付产品

**Q: 支付回调没收到？**
A: 检查服务器日志，确认回调URL是否可访问

**Q: 签名验证失败？**
A: 检查API密钥是否正确配置

