# æœ¬åœ°æ¨¡å‹æ¨ç†æœåŠ¡ - æœ€ç»ˆä¼˜åŒ–æ€»ç»“ ğŸ‰

## ğŸ¯ å®Œæˆçš„ä¼˜åŒ–

ç»è¿‡å¤šè½®ä¼˜åŒ–ï¼Œæœ¬åœ°æ¨¡å‹æ¨ç†æœåŠ¡å·²è¾¾åˆ°æœ€ç®€æ´ã€æœ€åˆç†çš„çŠ¶æ€ã€‚

## ğŸ“Š ä»£ç æ¼”è¿›å†ç¨‹

| ç‰ˆæœ¬ | ä»£ç è¡Œæ•° | ä¸»è¦ç‰¹ç‚¹ | é—®é¢˜ |
|------|---------|---------|------|
| **V1 (æ‰‹åŠ¨å®ç°)** | ~646è¡Œ | æ‰‹åŠ¨å®ç°æ‰€æœ‰é¢„å¤„ç†å’Œåå¤„ç† | ä»£ç å¤æ‚ï¼Œç»´æŠ¤å›°éš¾ |
| **V2 (Ultralytics)** | ~385è¡Œ | ä½¿ç”¨Ultralyticsç®€åŒ–YOLOï¼Œä¿ç•™fallback | æœ‰å†—ä½™çš„fallbackæœºåˆ¶ |
| **V3 (ç§»é™¤fallback)** | ~328è¡Œ | ç§»é™¤æ‰€æœ‰fallbackï¼Œä½¿ç”¨torchvision | æœåŠ¡å™¨ç«¯åšäº†ä¸è¯¥åšçš„äº‹ |
| **V4 (èŒè´£åˆ†ç¦»)** âœ… | **273è¡Œ** | **æœåŠ¡å™¨åªåšæ¨ç†ï¼Œå®¢æˆ·ç«¯åšæ˜ å°„** | **æ¶æ„æ¸…æ™°åˆç†** |

### ä»£ç å‡å°‘ç»Ÿè®¡

```
646è¡Œ (V1) â†’ 273è¡Œ (V4) = å‡å°‘ 373è¡Œ (58%â†“)
```

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„å†³ç­–

### âœ… èŒè´£åˆ†ç¦»

**æœåŠ¡å™¨ç«¯**ï¼š
- âœ… åªè´Ÿè´£æ¨¡å‹æ¨ç†
- âœ… è¿”å›åŸå§‹æ£€æµ‹ç»“æœ
- âŒ ä¸åšåˆ†ç±»æ˜ å°„
- âŒ ä¸åšæˆªå›¾è¯†åˆ«

**å®¢æˆ·ç«¯**ï¼š
- âœ… è°ƒç”¨æœåŠ¡å™¨APIè·å–æ£€æµ‹ç»“æœ
- âœ… ä½¿ç”¨ `MapObjectes2Category()` åšåˆ†ç±»æ˜ å°„
- âœ… ä½¿ç”¨ `identifyMainRole()` åšä¸»è§’è¯†åˆ«
- âœ… ä½¿ç”¨é…ç½®æ–‡ä»¶é©±åŠ¨æ˜ å°„è§„åˆ™
- âœ… ä¸Šä¼ å‰åˆ¤æ–­æˆªå›¾

## ğŸ“¦ æœ€ç»ˆä»£ç ç»“æ„

### æœåŠ¡å™¨ç«¯æ ¸å¿ƒä»£ç 

```python
class LocalModelInference:
    """æœ¬åœ°æ¨¡å‹æ¨ç†æœåŠ¡ï¼ˆ273è¡Œï¼‰"""
    
    def __init__(self):
        # ç›´æ¥åˆå§‹åŒ–transformsï¼ˆæ— æ¡ä»¶æ£€æŸ¥ï¼‰
        self.mobilenet_transform = transforms.Compose([
            transforms.Resize(256),
            transforms.CenterCrop(224),
            transforms.ToTensor()
        ])
    
    async def initialize(self):
        # åŠ è½½ä¸‰ä¸ªæ¨¡å‹ï¼šidCard, yolo8s, mobilenetv3
        for model_name in ["idCard", "yolo8s"]:
            self.models[model_name] = YOLO(path, task='detect')
        # MobileNetV3 ç”¨ ONNX Runtime
    
    def detect_with_yolo(self, image_bytes, model_name):
        # Ultralyticsè‡ªåŠ¨å¤„ç†é¢„å¤„ç†å’Œåå¤„ç†
        image = Image.open(io.BytesIO(image_bytes))
        results = self.models[model_name](image, conf=threshold)
        return detections
    
    def classify_mobilenet(self, image_bytes):
        # torchvisioné¢„å¤„ç†ï¼ˆ3è¡Œï¼‰
        image = Image.open(io.BytesIO(image_bytes)).convert('RGB')
        tensor = self.mobilenet_transform(image)
        input_tensor = tensor.unsqueeze(0).numpy()
        
        # ONNX Runtimeæ¨ç†
        outputs = self.models["mobilenetv3"].run(['496'], {'x': input_tensor})
        # Softmaxåå¤„ç†
        return predictions
    
    async def classify_image(self, image_bytes):
        # åªåšæ¨ç†ï¼Œè¿”å›åŸå§‹ç»“æœ
        id_card_detections = self.detect_with_yolo(image_bytes, 'idCard')
        general_detections = self.detect_with_yolo(image_bytes, 'yolo8s')
        mobilenet_result = self.classify_mobilenet(image_bytes)
        
        return {
            'success': True,
            'idCardDetections': id_card_detections,
            'generalDetections': general_detections,
            'mobileNetV3Detections': mobilenet_result,
            'imageDimensions': image_dimensions
            # ä¸è¿”å› categoryIdï¼
        }
```

## âœ¨ ä¼˜åŒ–äº®ç‚¹

### 1. ä½¿ç”¨æˆç†Ÿçš„åº“

| åŠŸèƒ½ | åº“ | ä»£ç é‡ |
|------|-----|--------|
| **YOLOé¢„å¤„ç†** | Ultralytics | è‡ªåŠ¨ï¼ˆ~0è¡Œï¼‰ |
| **YOLOåå¤„ç†** | Ultralytics | è‡ªåŠ¨ï¼ˆ~0è¡Œï¼‰ |
| **MobileNetV3é¢„å¤„ç†** | torchvision | 3è¡Œ |

**æ€»é¢„å¤„ç†/åå¤„ç†ä»£ç **: ~3è¡Œ vs åŸæ¥çš„ ~150è¡Œ

### 2. ç§»é™¤ä¸å¿…è¦çš„ä»£ç 

- âŒ ç§»é™¤æ‰€æœ‰ try-except å¯¼å…¥æ£€æŸ¥ï¼ˆ~15è¡Œï¼‰
- âŒ ç§»é™¤æ‰€æœ‰ fallback æœºåˆ¶ï¼ˆ~30è¡Œï¼‰
- âŒ ç§»é™¤åˆ†ç±»æ˜ å°„å‡½æ•°ï¼ˆ~35è¡Œï¼‰
- âŒ ç§»é™¤æ¡ä»¶åˆ¤æ–­é€»è¾‘ï¼ˆå¤šå¤„ï¼‰

### 3. æ¶æ„æ¸…æ™°

```
æœåŠ¡å™¨ç«¯ (273è¡Œ)
â”œâ”€â”€ åˆå§‹åŒ–æ¨¡å‹
â”œâ”€â”€ YOLOæ£€æµ‹ (Ultralyticsè‡ªåŠ¨åŒ–)
â”œâ”€â”€ MobileNetV3åˆ†ç±» (torchvisioné¢„å¤„ç†)
â””â”€â”€ è¿”å›åŸå§‹ç»“æœ

å®¢æˆ·ç«¯
â”œâ”€â”€ è°ƒç”¨æœåŠ¡å™¨API
â”œâ”€â”€ MapObjectes2Category (åˆ†ç±»æ˜ å°„)
â”œâ”€â”€ identifyMainRole (ä¸»è§’è¯†åˆ«)
â””â”€â”€ é…ç½®é©±åŠ¨çš„è§„åˆ™
```

## ğŸ“‹ APIå“åº”æ ¼å¼

### æœåŠ¡å™¨ç«¯è¿”å›ï¼ˆç®€æ´ï¼‰

```json
{
  "success": true,
  "message": "æ¨¡å‹æ¨ç†å®Œæˆ",
  "idCardDetections": [...],
  "generalDetections": [...],
  "mobileNetV3Detections": {...},
  "imageDimensions": {"width": 1920, "height": 1080},
  "allModelResults": {...}
}
```

**ä¸åŒ…å«**ï¼š
- âŒ `categoryId` - å®¢æˆ·ç«¯è´Ÿè´£
- âŒ `confidence` - å®¢æˆ·ç«¯è®¡ç®—
- âŒ ä»»ä½•ä¸šåŠ¡é€»è¾‘åˆ¤æ–­

### å®¢æˆ·ç«¯å¤„ç†

```javascript
// 1. è·å–æ£€æµ‹ç»“æœ
const result = await api.classifyImageLocal(imageFile);

// 2. å®¢æˆ·ç«¯åˆ†ç±»æ˜ å°„
const categoryId = await this.MapObjectes2Category(
    result.allModelResults,
    imageUri,
    imageDimensions
);

// 3. æœ€ç»ˆç»“æœ
console.log('åˆ†ç±»:', categoryId);
```

## ğŸ æœ€ç»ˆæ”¶ç›Š

### ä»£ç è´¨é‡

| æŒ‡æ ‡ | æ”¹è¿› |
|------|------|
| **ä»£ç è¡Œæ•°** | 58%â†“ (646â†’273) |
| **å¤æ‚åº¦** | æ˜¾è‘—é™ä½ |
| **å¯ç»´æŠ¤æ€§** | å¤§å¹…æå‡ |
| **å¯è¯»æ€§** | æ¸…æ™°ç®€æ´ |

### æ¶æ„ä¼˜åŠ¿

| æ–¹é¢ | ä¼˜åŠ¿ |
|------|------|
| **èŒè´£åˆ†ç¦»** | æœåŠ¡å™¨=æ¨ç†ï¼Œå®¢æˆ·ç«¯=ä¸šåŠ¡ |
| **é¿å…é‡å¤** | åªç»´æŠ¤ä¸€å¥—åˆ†ç±»é€»è¾‘ |
| **çµæ´»æ€§** | å®¢æˆ·ç«¯å¯è‡ªç”±è°ƒæ•´è§„åˆ™ |
| **æ€§èƒ½** | å‡å°‘æœåŠ¡å™¨è®¡ç®—è´Ÿæ‹… |
| **å¯æ‰©å±•** | ä¸åŒå®¢æˆ·ç«¯å¯æœ‰ä¸åŒç­–ç•¥ |

### æŠ€æœ¯æ ˆä¼˜åŒ–

| ç»„ä»¶ | æŠ€æœ¯æ–¹æ¡ˆ | ä¼˜åŠ¿ |
|------|---------|------|
| **YOLOæ¨ç†** | Ultralytics | è‡ªåŠ¨åŒ–ã€é›¶ä»£ç  |
| **MobileNetV3é¢„å¤„ç†** | torchvision | æ ‡å‡†åŒ–ã€3è¡Œä»£ç  |
| **ä¾èµ–ç®¡ç†** | ç»Ÿä¸€å®‰è£… | æ— fallbackï¼Œç®€å• |
| **æ¶æ„è®¾è®¡** | èŒè´£åˆ†ç¦» | æ¸…æ™°ã€æ˜“ç»´æŠ¤ |

## ğŸ“¦ ä¾èµ–è¦æ±‚

```bash
pip install ultralytics  # è‡ªåŠ¨å®‰è£… torch + torchvision
pip install onnxruntime  # ONNXæ¨ç†å¼•æ“
pip install Pillow       # å›¾åƒå¤„ç†
```

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### æœåŠ¡å™¨ç«¯

```python
from app.services.local_model_inference import local_model_inference

# åˆå§‹åŒ–
await local_model_inference.initialize()

# æ¨ç†
result = await local_model_inference.classify_image(image_bytes)

# result åŒ…å«åŸå§‹æ£€æµ‹ç»“æœï¼Œä¸å« categoryId
```

### å®¢æˆ·ç«¯

```javascript
// è°ƒç”¨API
const detectionResult = await fetch('/api/v1/local-classify/detailed', {
    method: 'POST',
    body: formData
});

// å®¢æˆ·ç«¯åˆ†ç±»æ˜ å°„
const categoryId = await imageClassifierService.MapObjectes2Category(
    detectionResult.allModelResults,
    imageUri,
    imageDimensions
);
```

## âœ… ä¼˜åŒ–æ£€æŸ¥æ¸…å•

- [x] ç§»é™¤æ‰‹åŠ¨å®ç°çš„é¢„å¤„ç†ä»£ç 
- [x] ä½¿ç”¨Ultralyticsç®€åŒ–YOLO
- [x] ä½¿ç”¨torchvisionç®€åŒ–MobileNetV3é¢„å¤„ç†
- [x] ç§»é™¤æ‰€æœ‰try-exceptå¯¼å…¥æ£€æŸ¥
- [x] ç§»é™¤æ‰€æœ‰fallbackæœºåˆ¶
- [x] ç§»é™¤æœåŠ¡å™¨ç«¯åˆ†ç±»æ˜ å°„
- [x] ç§»é™¤æœåŠ¡å™¨ç«¯æˆªå›¾è¯†åˆ«
- [x] æ˜ç¡®èŒè´£åˆ†ç¦»æ¶æ„
- [x] åˆ›å»ºæ¶æ„æ–‡æ¡£
- [x] ä»£ç æµ‹è¯•éªŒè¯

## ğŸ¯ æœ€ç»ˆçŠ¶æ€

### ä»£ç ç»Ÿè®¡

```
æœåŠ¡å™¨ç«¯ä»£ç : 273è¡Œ
â”œâ”€â”€ å¯¼å…¥å’Œé…ç½®: ~50è¡Œ
â”œâ”€â”€ åˆå§‹åŒ–: ~40è¡Œ
â”œâ”€â”€ YOLOæ£€æµ‹: ~50è¡Œ
â”œâ”€â”€ MobileNetV3åˆ†ç±»: ~40è¡Œ
â”œâ”€â”€ ä¸»æ¨ç†å‡½æ•°: ~45è¡Œ
â””â”€â”€ å·¥å…·å‡½æ•°: ~48è¡Œ
```

### å¤æ‚åº¦å¯¹æ¯”

```
V1 (æ‰‹åŠ¨å®ç°):
- é¢„å¤„ç†: ~50è¡Œ
- åå¤„ç†: ~80è¡Œ
- NMS: ~40è¡Œ
- åˆ†ç±»æ˜ å°„: ~35è¡Œ
- Fallback: ~30è¡Œ
æ€»è®¡: ~235è¡Œä¸šåŠ¡é€»è¾‘

V4 (æœ€ç»ˆç‰ˆ):
- é¢„å¤„ç†: 3è¡Œ (torchvision)
- åå¤„ç†: è‡ªåŠ¨ (Ultralytics)
- NMS: è‡ªåŠ¨ (Ultralytics)
- åˆ†ç±»æ˜ å°„: 0è¡Œ (å®¢æˆ·ç«¯)
- Fallback: 0è¡Œ (ç§»é™¤)
æ€»è®¡: ~3è¡Œä¸šåŠ¡é€»è¾‘ âœ¨
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- ğŸ“– [æ¶æ„è¯´æ˜ï¼šæœåŠ¡å™¨ä¸å®¢æˆ·ç«¯èŒè´£åˆ†ç¦»](./æ¶æ„è¯´æ˜_æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯èŒè´£åˆ†ç¦».md)
- ğŸ“– [æœ¬åœ°æ¨¡å‹æ¨ç†ä½¿ç”¨è¯´æ˜](./æœ¬åœ°æ¨¡å‹æ¨ç†ä½¿ç”¨è¯´æ˜.md)
- ğŸ“– [å¿«é€Ÿå…¥é—¨æŒ‡å—](./æœ¬åœ°æ¨¡å‹æ¨ç†å¿«é€Ÿå…¥é—¨.md)
- ğŸ“– [ä»£ç ä¼˜åŒ–æ€»ç»“](./ä»£ç ä¼˜åŒ–æ€»ç»“.md)

## ğŸ‰ æ€»ç»“

é€šè¿‡å¤šè½®è¿­ä»£ä¼˜åŒ–ï¼Œæœ€ç»ˆå®ç°äº†ï¼š

1. âœ… **ä»£ç å‡å°‘58%** - ä»646è¡Œé™è‡³273è¡Œ
2. âœ… **æ¶æ„æ¸…æ™°** - èŒè´£åˆ†ç¦»ï¼ŒæœåŠ¡å™¨ä¸“æ³¨æ¨ç†
3. âœ… **ä½¿ç”¨æ ‡å‡†åº“** - Ultralytics + torchvision
4. âœ… **æ˜“äºç»´æŠ¤** - æ— å†—ä½™ä»£ç ï¼Œæ— é‡å¤é€»è¾‘
5. âœ… **çµæ´»æ‰©å±•** - å®¢æˆ·ç«¯å¯è‡ªç”±è°ƒæ•´åˆ†ç±»ç­–ç•¥

**ç®€æ´ã€é«˜æ•ˆã€æ˜“ç»´æŠ¤çš„æœ€ä¼˜å®ç°ï¼** ğŸš€

---

**æœ€ç»ˆç‰ˆæœ¬**: V4  
**ä»£ç è¡Œæ•°**: 273è¡Œ  
**ä¼˜åŒ–å¹…åº¦**: 58%â†“  
**å®Œæˆæ—¥æœŸ**: 2025-10-11  
**æ¶æ„**: èŒè´£åˆ†ç¦»ï¼ŒæœåŠ¡å™¨åªåšæ¨ç†

