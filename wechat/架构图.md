# 架构图

## 三层部署架构图

```mermaid
flowchart TB
    subgraph L1["第一层：客户端"]
        direction TB
        PC[PC客户端]
        Mobile[移动端]
        Wechat[微信会员管理页面]
    end
    
    subgraph L2["第二层：WEB服务器"]
        direction TB
        Lighttpd[Lighttpd]
        Site1[芯图相册官网<br/>www.xintuxiangce.top]
        Site2[管理后台<br/>admin.xintuxaingce.top]
        Site3[Aifuture官网<br/>www.aifuture.net.cn]
        DBSlave[(MySQL数据库<br/>从库)]
    end
    
    subgraph L3["第三层：APP服务器<br/>api.aifuture.net.cn"]
        direction TB
        Nginx[Nginx反向代理]
        Gunicorn[Gunicorn<br/>WSGI服务器]
        FastAPI[FastAPI应用]
        subgraph Services["照片处理"]
            direction TB
            subgraph CoreServices["核心服务"]
                direction TB
                ClassifierService[图像分类服务<br/>ClassifierService]
                ImageEditService[图像编辑服务<br/>ImageEditService]
                LocationService[位置查询服务<br/>LocationService]
            end
            subgraph BaseServices["基础服务"]
                direction TB
                CacheService[缓存服务<br/>CacheService]
                ModelClient[大模型客户端<br/>ModelClient]
                StatsService[统计服务<br/>StatsService]
            end
        end
        subgraph MemberService["会员管理服务"]
            direction TB
            CreditService[额度服务<br/>CreditService]
            OrderService[订单服务<br/>OrderService]
            BindingService[绑定服务<br/>BindingService]
        end
        DB[(MySQL数据库<br/>主库)]
    end
    
    %% 第一层到第三层的直接访问
    PC -->|api.aifuture.net.cn| Nginx
    Mobile -->|api.aifuture.net.cn| Nginx
    
    %% 第一层到第二层再到第三层的访问
    Wechat -->|www.xintuxiangce.top| Lighttpd
    Lighttpd -->|反向代理/api/v1接口请求| Gunicorn
    
    %% Lighttpd直接服务各个网站（Web模块）
    Lighttpd -.->|WEB容器| Site1
    Lighttpd -.->|WEB容器| Site2
    Lighttpd -.->|WEB容器| Site3
    
    %% 第三层内部关系
    Nginx -->|反向代理| Gunicorn
    Gunicorn -->|运行| FastAPI
    FastAPI --> Services
    FastAPI --> MemberService
    %% 数据库连接
    Services --> DB
    MemberService --> DB
    %% 主从复制关系
    DB -.->|主从复制| DBSlave
    
    %% 样式
    classDef layer1 fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef layer2 fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef layer3 fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef db fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    classDef dbSlave fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    
    class PC,Mobile,Wechat layer1
    class Lighttpd,Site1,Site2,Site3,DBSlave layer2
    class Nginx,Gunicorn,FastAPI,Services,CoreServices,BaseServices,ClassifierService,ImageEditService,LocationService,CacheService,ModelClient,StatsService,MemberService,CreditService,OrderService,BindingService layer3
    class DB db
    class DBSlave dbSlave
```

### 三层架构说明

#### 第一层：客户端
- **PC客户端**：通过 `api.aifuture.net.cn` 域名直接访问第三层APP服务器
- **移动端**：通过 `api.aifuture.net.cn` 域名直接访问第三层APP服务器
- **微信会员管理页面**：通过 `www.xintuxiangce.top` 域名访问第二层WEB服务器

#### 第二层：WEB服务器
- **Lighttpd**：Web服务器，负责处理HTTP请求和路由
  - **芯图相册官网**：Lighttpd配置的虚拟主机/Web模块
  - **管理后台**：Lighttpd配置的虚拟主机/Web模块
  - **Aifuture官网**：Lighttpd配置的虚拟主机/Web模块
- **MySQL数据库（从库）**：从第三层主库同步数据，用于只读查询
- **职责**：
  - 作为Web服务器，直接服务芯图相册官网、管理后台和Aifuture官网（通过虚拟主机配置）
  - 反向代理转发微信会员管理的API请求到第三层APP服务器的Gunicorn
  - 提供数据库从库，支持只读查询，减轻主库压力

#### 第三层：APP服务器
- **Nginx**：反向代理服务器，处理所有API请求，反向代理到Gunicorn
- **Gunicorn**：WSGI服务器，运行FastAPI应用
- **FastAPI应用**：Python Web框架，包含所有业务逻辑
- **Service服务**：业务服务模块，分为两层
  - **核心服务**：
    - **图像分类服务（ClassifierService）**：图片分类核心服务，整合缓存、大模型和本地推理
    - **图像编辑服务（ImageEditService）**：基于阿里云百炼的图像编辑功能
    - **位置查询服务（LocationService）**：基于GPS坐标的城市位置查询
  - **基础服务**：
    - **缓存服务（CacheService）**：图片分类结果缓存管理
    - **大模型客户端（ModelClient）**：调用阿里云通义千问等大模型API
    - **统计服务（StatsService）**：请求日志记录和统计数据查询
- **会员管理服务**：会员相关的业务逻辑
  - **额度服务（CreditService）**：用户额度检查和扣减
  - **订单服务（OrderService）**：订单创建、支付处理
  - **绑定服务（BindingService）**：微信二维码与客户端绑定管理
- **MySQL数据库（主库）**：数据存储，通过主从复制同步到第二层从库

### 访问路径

1. **PC/Mobile → APP服务器**
   ```
   PC/Mobile → api.aifuture.net.cn → Nginx → Gunicorn → FastAPI → Services/MemberService → DB
   ```

2. **微信会员管理 → WEB服务器 → APP服务器**
   ```
   Wechat → www.xintuxiangce.top → Lighttpd(反向代理) → Gunicorn → FastAPI → MemberService → DB
   ```

3. **访问网站 → WEB服务器（虚拟主机）**
   ```
   客户端 → www.xintuxiangce.top → Lighttpd(Web服务器) → 芯图相册官网/管理后台/Aifuture官网(虚拟主机)
   ```

## 二维码生成与扫码关注时序图

### 场景1：生成二维码流程

```mermaid
sequenceDiagram
    participant Client as PC/Mobile客户端
    participant Nginx as Nginx反向代理
    participant Gunicorn as Gunicorn
    participant FastAPI as FastAPI应用
    participant BindingService as 绑定服务
    participant WXAPI as 微信API
    participant DB as MySQL主库
    
    Note over Client,DB: 生成二维码流程
    Client->>Nginx: POST /api/v1/auth/wechat/qrcode<br/>{client_id: "xxx"}
    Nginx->>Gunicorn: 反向代理请求
    Gunicorn->>FastAPI: 转发请求
    FastAPI->>WXAPI: 获取access_token
    WXAPI-->>FastAPI: 返回access_token
    FastAPI->>BindingService: 创建/更新绑定记录
    BindingService->>DB: INSERT/UPDATE wechat_qrcode_bindings<br/>获取自增ID作为scene_id
    DB-->>BindingService: 返回scene_id
    BindingService-->>FastAPI: 返回scene_id
    FastAPI->>WXAPI: 调用生成二维码API<br/>{scene_id: xxx}
    WXAPI-->>FastAPI: 返回二维码ticket和URL
    FastAPI-->>Gunicorn: 返回二维码信息
    Gunicorn-->>Nginx: 返回响应
    Nginx-->>Client: 返回二维码URL
    Client->>Client: 显示二维码供用户扫描
```

### 场景2：扫码关注流程

```mermaid
sequenceDiagram
    participant User as 用户
    participant WX as 微信平台
    participant Lighttpd as Lighttpd反向代理
    participant Gunicorn as Gunicorn
    participant FastAPI as FastAPI应用
    participant BindingService as 绑定服务
    participant CreditService as 额度服务
    participant DB as MySQL主库
    participant DBSlave as MySQL从库
    
    Note over User,DBSlave: 扫码关注流程
    User->>WX: 扫描二维码并关注公众号
    WX->>Lighttpd: POST /api/v1/auth/wechat/verify<br/>推送关注事件（包含scene_id和openid）
    Lighttpd->>Gunicorn: 反向代理请求
    Gunicorn->>FastAPI: 转发消息推送
    FastAPI->>FastAPI: 解析XML消息<br/>提取openid和scene_id
    
    alt 新用户关注
        FastAPI->>CreditService: 创建新用户
        CreditService->>DB: INSERT wechat_users<br/>(openid, 初始额度10张)
        DB-->>CreditService: 成功
        CreditService-->>FastAPI: 用户创建成功
    else 已关注用户扫码
        FastAPI->>DB: UPDATE wechat_users<br/>更新最后活跃时间
    end
    
    FastAPI->>BindingService: 更新绑定关系
    BindingService->>DB: UPDATE wechat_qrcode_bindings<br/>SET openid=xxx, status='completed'<br/>WHERE scene_id=xxx
    DB-->>BindingService: 更新成功
    BindingService-->>FastAPI: 绑定完成
    
    Note over DB,DBSlave: 主从复制同步
    DB-.->|主从复制| DBSlave: 同步数据到从库
    
    FastAPI-->>Gunicorn: 返回欢迎消息
    Gunicorn-->>Lighttpd: 返回响应
    Lighttpd-->>WX: 返回XML响应
    WX->>User: 显示欢迎消息
```

### 场景3：客户端查询绑定状态

```mermaid
sequenceDiagram
    participant Client as PC/Mobile客户端
    participant Nginx as Nginx反向代理
    participant Gunicorn as Gunicorn
    participant FastAPI as FastAPI应用
    participant BindingService as 绑定服务
    participant DB as MySQL主库
    
    Note over Client,DB: 客户端查询绑定状态
    Client->>Nginx: GET /api/v1/auth/wechat/binding?client_id=xxx
    Nginx->>Gunicorn: 反向代理请求
    Gunicorn->>FastAPI: 转发请求
    FastAPI->>BindingService: 查询绑定状态
    BindingService->>DB: SELECT * FROM wechat_qrcode_bindings<br/>WHERE client_id=xxx
    DB-->>BindingService: 返回绑定记录（包含openid）
    BindingService-->>FastAPI: 返回绑定信息
    FastAPI-->>Gunicorn: 返回查询结果
    Gunicorn-->>Nginx: 返回响应
    Nginx-->>Client: 返回openid和绑定状态
    Client->>Client: 根据openid判断是否已关注
```

### 场景4：开通会员流程

```mermaid
sequenceDiagram
    participant Wechat as 微信会员管理页面
    participant Lighttpd as Lighttpd反向代理
    participant Gunicorn as Gunicorn
    participant FastAPI as FastAPI应用
    participant OrderService as 订单服务
    participant CreditService as 额度服务
    participant WXPay as 微信支付API
    participant DB as MySQL主库
    participant DBSlave as MySQL从库
    participant WXNotify as 微信支付回调
    
    Note over Wechat,DBSlave: 开通会员流程
    Wechat->>Lighttpd: POST /api/v1/payment/create-order<br/>{order_type: "member"}<br/>Header: X-WeChat-OpenID
    Lighttpd->>Gunicorn: 反向代理请求
    Gunicorn->>FastAPI: 转发请求
    FastAPI->>CreditService: 检查用户会员状态
    CreditService->>DB: SELECT is_member, member_expire_at<br/>FROM wechat_users
    DB-->>CreditService: 返回用户信息
    CreditService-->>FastAPI: 验证通过（非会员）
    
    FastAPI->>OrderService: 创建会员订单
    OrderService->>DB: INSERT payment_orders<br/>(order_type='member', amount=会员价格)
    DB-->>OrderService: 返回订单号
    OrderService-->>FastAPI: 订单创建成功
    
    FastAPI->>WXPay: 调用统一下单API<br/>{order_no, openid, amount, description}
    WXPay-->>FastAPI: 返回prepay_id和支付参数
    FastAPI-->>Gunicorn: 返回支付参数
    Gunicorn-->>Lighttpd: 返回响应
    Lighttpd-->>Wechat: 返回支付参数
    Wechat->>WXPay: 调起微信支付<br/>WeixinJSBridge.invoke
    WXPay-->>Wechat: 支付成功/失败
    
    Note over WXPay,WXNotify: 支付完成后异步回调
    WXPay->>WXNotify: POST /api/v1/payment/notify<br/>支付回调通知
    WXNotify->>Lighttpd: 推送支付结果
    Lighttpd->>Gunicorn: 反向代理请求
    Gunicorn->>FastAPI: 转发回调
    FastAPI->>FastAPI: 解析XML，验证签名
    
    FastAPI->>OrderService: 更新订单状态
    OrderService->>DB: UPDATE payment_orders<br/>SET status='paid', paid_at=NOW()
    DB-->>OrderService: 更新成功
    
    FastAPI->>CreditService: 开通会员并赠送额度
    CreditService->>DB: UPDATE wechat_users<br/>SET is_member=1,<br/>member_expire_at=30天后,<br/>remaining_credits+=10,<br/>total_credits+=10
    DB-->>CreditService: 更新成功
    CreditService-->>FastAPI: 会员开通成功
    
    Note over DB,DBSlave: 主从复制同步
    DB-.->|主从复制| DBSlave: 同步数据到从库
    
    FastAPI-->>Gunicorn: 返回SUCCESS
    Gunicorn-->>Lighttpd: 返回响应
    Lighttpd-->>WXPay: 返回XML响应
```

### 场景5：购买额度流程

```mermaid
sequenceDiagram
    participant Wechat as 微信会员管理页面
    participant Lighttpd as Lighttpd反向代理
    participant Gunicorn as Gunicorn
    participant FastAPI as FastAPI应用
    participant OrderService as 订单服务
    participant CreditService as 额度服务
    participant WXPay as 微信支付API
    participant DB as MySQL主库
    participant DBSlave as MySQL从库
    participant WXNotify as 微信支付回调
    
    Note over Wechat,DBSlave: 购买额度流程
    Wechat->>Lighttpd: POST /api/v1/payment/create-order<br/>{order_type: "credits",<br/>credits_amount: 10}<br/>Header: X-WeChat-OpenID
    Lighttpd->>Gunicorn: 反向代理请求
    Gunicorn->>FastAPI: 转发请求
    FastAPI->>OrderService: 创建额度订单
    OrderService->>DB: INSERT payment_orders<br/>(order_type='credits',<br/>credits_amount=10,<br/>amount=数量×单价)
    DB-->>OrderService: 返回订单号
    OrderService-->>FastAPI: 订单创建成功
    
    FastAPI->>WXPay: 调用统一下单API<br/>{order_no, openid, amount, description}
    WXPay-->>FastAPI: 返回prepay_id和支付参数
    FastAPI-->>Gunicorn: 返回支付参数
    Gunicorn-->>Lighttpd: 返回响应
    Lighttpd-->>Wechat: 返回支付参数
    Wechat->>WXPay: 调起微信支付<br/>WeixinJSBridge.invoke
    WXPay-->>Wechat: 支付成功/失败
    
    Note over WXPay,WXNotify: 支付完成后异步回调
    WXPay->>WXNotify: POST /api/v1/payment/notify<br/>支付回调通知
    WXNotify->>Lighttpd: 推送支付结果
    Lighttpd->>Gunicorn: 反向代理请求
    Gunicorn->>FastAPI: 转发回调
    FastAPI->>FastAPI: 解析XML，验证签名
    
    FastAPI->>OrderService: 更新订单状态
    OrderService->>DB: UPDATE payment_orders<br/>SET status='paid', paid_at=NOW()
    DB-->>OrderService: 更新成功
    
    FastAPI->>CreditService: 增加用户额度
    CreditService->>DB: UPDATE wechat_users<br/>SET remaining_credits+=credits_amount,<br/>total_credits+=credits_amount
    DB-->>CreditService: 更新成功
    CreditService-->>FastAPI: 额度增加成功
    
    Note over DB,DBSlave: 主从复制同步
    DB-.->|主从复制| DBSlave: 同步数据到从库
    
    FastAPI-->>Gunicorn: 返回SUCCESS
    Gunicorn-->>Lighttpd: 返回响应
    Lighttpd-->>WXPay: 返回XML响应
```

## 关键点说明

### Web服务器职责
- ✅ 只接收微信主动调用的请求（3个接口）
- ✅ 不直接操作数据库
- ✅ 通过HTTP调用App服务器的内部接口操作数据

### App服务器职责
- ✅ 处理所有业务逻辑
- ✅ 主动调用微信API（网页授权、生成二维码、统一下单等）
- ✅ 直接操作数据库
- ✅ 提供内部接口供Web服务器调用

### 优势
- ✅ 不需要修改微信平台配置（URL保持不变）
- ✅ 前端代码无需修改（通过Nginx路由）
- ✅ 职责清晰，易于维护
- ✅ 安全性更高（Web服务器不直接操作数据库）

### 架构图样式说明

**Subgraph标题左对齐**：Mermaid的subgraph标题默认居中显示。如果您的Markdown渲染环境支持自定义CSS（如GitHub Pages、GitLab Pages、某些Markdown编辑器），可以在HTML中添加以下CSS样式来实现标题左对齐：

```css
.mermaid .subgraphLabel {
    text-align: left !important;
    justify-content: flex-start !important;
}

.mermaid .cluster-label text {
    text-anchor: start !important;
}
```

如果您的环境不支持自定义CSS，标题将保持默认的居中显示。

