# 服务拆分架构图

## 整体架构图

```mermaid
graph TB
    subgraph "外部系统"
        WX[微信平台]
        Frontend[前端页面<br/>member.html等]
    end
    
    subgraph "Nginx反向代理"
        Nginx[Nginx<br/>www.xintuxiangce.top]
    end
    
    subgraph "Web服务器<br/>只保留微信主动调用的接口"
        WebServer[FastAPI服务<br/>3个接口]
        WebVerify[GET/POST /api/v1/auth/wechat/verify<br/>服务器验证/消息推送]
        WebNotify[POST /api/v1/payment/notify<br/>支付回调]
    end
    
    subgraph "App服务器<br/>处理所有业务逻辑"
        AppServer[FastAPI服务<br/>所有业务接口]
        AppAuth[GET /api/v1/auth/wechat<br/>网页授权]
        AppQR[POST /api/v1/auth/wechat/qrcode<br/>生成二维码]
        AppOrder[POST /api/v1/payment/create-order<br/>创建订单+统一下单]
        AppUser[GET /api/v1/user/*<br/>用户查询]
        AppInternal[内部接口<br/>/api/v1/internal/*]
    end
    
    subgraph "数据库"
        DB[(MySQL<br/>image_classifier)]
    end
    
    %% 微信主动调用
    WX -->|服务器验证| WebVerify
    WX -->|消息推送| WebVerify
    WX -->|支付回调| WebNotify
    
    %% Web服务器调用App服务器内部接口
    WebVerify -.->|HTTP调用| AppInternal
    WebNotify -.->|HTTP调用| AppInternal
    
    %% 前端请求
    Frontend -->|所有API请求| Nginx
    Nginx -->|微信主动调用接口| WebServer
    Nginx -->|其他所有接口| AppServer
    
    %% App服务器操作
    AppServer -->|读写数据| DB
    AppAuth -->|调用微信API| WX
    AppQR -->|调用微信API| WX
    AppOrder -->|调用微信支付API| WX
    
    %% 样式
    classDef webServer fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef appServer fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef external fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef db fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    
    class WebServer,WebVerify,WebNotify webServer
    class AppServer,AppAuth,AppQR,AppOrder,AppUser,AppInternal appServer
    class WX,Frontend external
    class DB db
```

## 接口调用流程图

```mermaid
sequenceDiagram
    participant WX as 微信平台
    participant Frontend as 前端页面
    participant Nginx as Nginx反向代理
    participant Web as Web服务器
    participant App as App服务器
    participant DB as MySQL数据库
    
    Note over WX,DB: 场景1: 网页授权流程
    Frontend->>Nginx: GET /api/v1/auth/wechat?code=xxx
    Nginx->>App: 路由到App服务器
    App->>WX: 调用微信API获取openid
    WX-->>App: 返回openid
    App->>DB: 创建/更新用户
    DB-->>App: 成功
    App-->>Frontend: 返回openid
    
    Note over WX,DB: 场景2: 创建订单流程
    Frontend->>Nginx: POST /api/v1/payment/create-order
    Nginx->>App: 路由到App服务器
    App->>DB: 创建订单
    App->>WX: 调用微信支付API统一下单
    WX-->>App: 返回支付参数
    App-->>Frontend: 返回支付参数
    Frontend->>WX: 调起微信支付
    
    Note over WX,DB: 场景3: 支付回调流程
    WX->>Nginx: POST /api/v1/payment/notify
    Nginx->>Web: 路由到Web服务器
    Web->>App: HTTP调用内部接口更新订单
    App->>DB: 更新订单状态和用户额度
    DB-->>App: 成功
    App-->>Web: 返回成功
    Web-->>WX: 返回SUCCESS
    
    Note over WX,DB: 场景4: 消息推送流程
    WX->>Nginx: POST /api/v1/auth/wechat/verify
    Nginx->>Web: 路由到Web服务器
    Web->>App: HTTP调用内部接口保存用户
    App->>DB: 保存用户和更新绑定
    DB-->>App: 成功
    App-->>Web: 返回成功
    Web-->>WX: 返回响应
```

## 接口分类图

```mermaid
graph LR
    subgraph "Web服务器<br/>3个接口"
        W1[GET /api/v1/auth/wechat/verify<br/>服务器配置验证]
        W2[POST /api/v1/auth/wechat/verify<br/>消息推送]
        W3[POST /api/v1/payment/notify<br/>支付回调]
    end
    
    subgraph "App服务器<br/>业务接口"
        A1[GET /api/v1/auth/wechat<br/>网页授权]
        A2[POST /api/v1/auth/wechat/qrcode<br/>生成二维码]
        A3[GET /api/v1/auth/wechat/get-menu<br/>查询菜单]
        A4[POST /api/v1/auth/wechat/create-menu<br/>创建菜单]
        A5[POST /api/v1/payment/create-order<br/>创建订单+统一下单]
        A6[GET /api/v1/user/*<br/>用户查询接口]
    end
    
    subgraph "App服务器<br/>内部接口"
        I1[POST /api/v1/internal/user/create-or-update]
        I2[POST /api/v1/internal/binding/create]
        I3[PUT /api/v1/internal/binding/update]
        I4[PUT /api/v1/internal/payment/order/update]
    end
    
    W2 -.->|调用| I1
    W2 -.->|调用| I2
    W2 -.->|调用| I3
    W3 -.->|调用| I4
    
    WX[微信平台] -->|主动调用| W1
    WX -->|主动调用| W2
    WX -->|主动调用| W3
    
    A1 -->|调用| WX
    A2 -->|调用| WX
    A3 -->|调用| WX
    A4 -->|调用| WX
    A5 -->|调用| WX
    
    classDef web fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef app fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef internal fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    classDef external fill:#fff3e0,stroke:#e65100,stroke-width:2px
    
    class W1,W2,W3 web
    class A1,A2,A3,A4,A5,A6 app
    class I1,I2,I3,I4 internal
    class WX external
```

## 数据流图

```mermaid
flowchart TD
    Start([用户操作]) --> Type{操作类型}
    
    Type -->|网页授权| AuthFlow[网页授权流程]
    Type -->|创建订单| OrderFlow[创建订单流程]
    Type -->|支付完成| NotifyFlow[支付回调流程]
    Type -->|消息推送| MessageFlow[消息推送流程]
    
    AuthFlow --> Auth1[前端获取code]
    Auth1 --> Auth2[调用App服务器网页授权接口]
    Auth2 --> Auth3[App服务器调用微信API]
    Auth3 --> Auth4[App服务器操作数据库]
    Auth4 --> Auth5[返回openid给前端]
    
    OrderFlow --> Order1[前端调用创建订单]
    Order1 --> Order2[App服务器创建订单到DB]
    Order2 --> Order3[App服务器调用微信支付API]
    Order3 --> Order4[返回支付参数给前端]
    Order4 --> Order5[前端调起微信支付]
    
    NotifyFlow --> Notify1[微信回调Web服务器]
    Notify1 --> Notify2[Web服务器调用App内部接口]
    Notify2 --> Notify3[App服务器更新订单和用户]
    Notify3 --> Notify4[返回SUCCESS给微信]
    
    MessageFlow --> Msg1[微信推送消息到Web服务器]
    Msg1 --> Msg2[Web服务器调用App内部接口]
    Msg2 --> Msg3[App服务器保存用户和绑定]
    Msg3 --> Msg4[返回响应给微信]
    
    style AuthFlow fill:#e3f2fd
    style OrderFlow fill:#f3e5f5
    style NotifyFlow fill:#fff3e0
    style MessageFlow fill:#e8f5e9
```

## 部署架构图

```mermaid
graph TB
    subgraph "公网"
        Internet[互联网]
    end
    
    subgraph "Web服务器<br/>47.98.167.63"
        WebNginx[Nginx]
        WebAPI[FastAPI<br/>3个接口]
    end
    
    subgraph "App服务器<br/>47.98.167.63"
        AppNginx[Nginx]
        AppAPI[FastAPI<br/>所有业务接口]
        AppDB[(MySQL数据库)]
    end
    
    subgraph "微信平台"
        WXServer[微信服务器]
    end
    
    Internet -->|HTTPS| WebNginx
    Internet -->|HTTPS| AppNginx
    
    WXServer -->|主动调用| WebNginx
    WXServer -.->|配置URL| WebNginx
    
    WebNginx --> WebAPI
    AppNginx --> AppAPI
    
    WebAPI -.->|HTTP调用<br/>内部接口| AppAPI
    AppAPI --> AppDB
    
    classDef web fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef app fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef external fill:#fff3e0,stroke:#e65100,stroke-width:2px
    
    class WebNginx,WebAPI web
    class AppNginx,AppAPI,AppDB app
    class Internet,WXServer external
```

## 关键点说明

### Web服务器职责
- ✅ 只接收微信主动调用的请求（3个接口）
- ✅ 不直接操作数据库
- ✅ 通过HTTP调用App服务器的内部接口操作数据

### App服务器职责
- ✅ 处理所有业务逻辑
- ✅ 主动调用微信API（网页授权、生成二维码、统一下单等）
- ✅ 直接操作数据库
- ✅ 提供内部接口供Web服务器调用

### 优势
- ✅ 不需要修改微信平台配置（URL保持不变）
- ✅ 前端代码无需修改（通过Nginx路由）
- ✅ 职责清晰，易于维护
- ✅ 安全性更高（Web服务器不直接操作数据库）

