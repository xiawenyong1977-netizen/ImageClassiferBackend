# 简化方案实施任务清单

## 📋 方案概述

**核心思路**：
- Web服务器只做反向代理（lighttpd配置）
- 所有代码和页面部署在App服务器
- 不需要修改任何代码
- 微信平台配置保持不变

---

## ✅ 任务清单

### 阶段1：准备工作

#### 1.1 确认服务器信息
- [ ] 确认Web服务器IP地址：`47.98.167.63`（假设）
- [ ] 确认App服务器IP地址：`47.98.167.63`（假设）
- [ ] 确认App服务器FastAPI服务端口：`8000`
- [ ] 确认Web服务器lighttpd配置路径：`/etc/lighttpd/lighttpd.conf`

#### 1.2 备份当前配置
- [ ] 备份Web服务器lighttpd配置文件
  ```bash
  ssh root@web "cp /etc/lighttpd/lighttpd.conf /etc/lighttpd/lighttpd.conf.backup.$(date +%Y%m%d)"
  ```
- [ ] 备份App服务器当前代码（如果有）
- [ ] 记录当前微信平台配置（URL、Token等）

---

### 阶段2：配置Web服务器反向代理

#### 2.1 配置lighttpd反向代理
- [ ] 编辑Web服务器lighttpd配置文件
  ```bash
  ssh root@web "vi /etc/lighttpd/lighttpd.conf"
  ```
- [ ] 添加反向代理配置（将 `/api/v1/*` 请求代理到App服务器）
  ```lighttpd
  $HTTP["url"] =~ "^/api/v1/" {
      proxy.server = (
          "" => (
              (
                  "host" => "47.98.167.63",  # App服务器IP
                  "port" => 8000
              )
          )
      )
      proxy.header = (
          "map-host-header" => ("-", "Host"),
          "x-forwarded-for" => "$",
          "x-forwarded-proto" => "https"
      )
  }
  ```
- [ ] 测试lighttpd配置语法
  ```bash
  ssh root@web "lighttpd -t -f /etc/lighttpd/lighttpd.conf"
  ```
- [ ] 重启lighttpd服务
  ```bash
  ssh root@web "systemctl restart lighttpd"
  # 或
  ssh root@web "service lighttpd restart"
  ```
- [ ] 检查lighttpd服务状态
  ```bash
  ssh root@web "systemctl status lighttpd"
  ```

#### 2.2 验证反向代理
- [ ] 测试API请求是否正常转发到App服务器
  ```bash
  curl -X GET "https://www.xintuxiangce.top/api/v1/health"
  ```
- [ ] 检查App服务器日志，确认请求已到达
- [ ] 测试微信服务器验证接口（GET请求）
  ```bash
  curl -X GET "https://www.xintuxiangce.top/api/v1/auth/wechat/verify?signature=xxx&timestamp=xxx&nonce=xxx&echostr=xxx"
  ```

---

### 阶段3：部署App服务器

#### 3.1 代码部署
- [ ] 确认App服务器代码目录：`/opt/ImageClassifierBackend`
- [ ] 拉取最新代码（如果使用Git）
  ```bash
  ssh root@app "cd /opt/ImageClassifierBackend && git pull"
  ```
- [ ] 或直接部署代码到App服务器
- [ ] 确认所有依赖已安装
  ```bash
  ssh root@app "cd /opt/ImageClassifierBackend && source venv/bin/activate && pip install -r requirements.txt"
  ```

#### 3.2 配置环境变量
- [ ] 确认App服务器 `.env` 文件配置正确
  - [ ] MySQL数据库配置
  - [ ] 微信配置（APPID、SECRET、Token等）
  - [ ] 微信支付配置（商户号、密钥等）
- [ ] 确认所有配置与Web服务器一致（微信相关配置）

#### 3.3 部署微信页面
- [ ] 确认微信页面目录：`/opt/ImageClassifierBackend/wechat`
- [ ] 部署所有微信页面到App服务器
  - [ ] `member.html`
  - [ ] `credits.html`
  - [ ] `credits_info.html`
  - [ ] 其他页面
- [ ] 配置FastAPI静态文件服务（如果需要）
  - [ ] 在 `app/main.py` 中配置静态文件路由
  - [ ] 或通过Nginx/lighttpd提供静态文件服务

#### 3.4 启动FastAPI服务
- [ ] 确认FastAPI服务配置
- [ ] 启动FastAPI服务（使用Gunicorn或uvicorn）
  ```bash
  ssh root@app "cd /opt/ImageClassifierBackend && source venv/bin/activate && gunicorn app.main:app -c gunicorn_config.py"
  ```
- [ ] 或使用systemd服务管理
  ```bash
  ssh root@app "systemctl start image-classifier"
  ```
- [ ] 检查服务状态
  ```bash
  ssh root@app "systemctl status image-classifier"
  # 或
  ssh root@app "ps aux | grep gunicorn"
  ```

---

### 阶段4：测试验证

#### 4.1 基础功能测试
- [ ] 测试健康检查接口
  ```bash
  curl "https://www.xintuxiangce.top/api/v1/health"
  ```
- [ ] 测试用户查询接口
  ```bash
  curl -H "X-WeChat-OpenID: test_openid" "https://www.xintuxiangce.top/api/v1/user/credits"
  ```

#### 4.2 微信相关接口测试
- [ ] 测试微信服务器验证接口（GET）
  - [ ] 在微信公众平台点击"修改配置"进行验证
  - [ ] 确认验证成功
- [ ] 测试网页授权接口
  - [ ] 访问 `https://www.xintuxiangce.top/wechat/member.html?code=xxx`
  - [ ] 确认能正常获取openid
- [ ] 测试生成二维码接口
  - [ ] 调用 `POST /api/v1/auth/wechat/qrcode`
  - [ ] 确认能正常生成二维码
- [ ] 测试创建订单接口
  - [ ] 调用 `POST /api/v1/payment/create-order`
  - [ ] 确认能正常创建订单并返回支付参数

#### 4.3 微信页面测试
- [ ] 测试会员页面
  - [ ] 访问 `https://www.xintuxiangce.top/wechat/member.html`
  - [ ] 确认页面正常加载
  - [ ] 测试授权流程
  - [ ] 测试支付流程
- [ ] 测试额度页面
  - [ ] 访问 `https://www.xintuxiangce.top/wechat/credits.html`
  - [ ] 确认页面正常加载
- [ ] 测试额度详情页面
  - [ ] 访问 `https://www.xintuxiangce.top/wechat/credits_info.html`
  - [ ] 确认页面正常加载

#### 4.4 支付流程测试
- [ ] 测试创建订单
  - [ ] 前端调用 `POST /api/v1/payment/create-order`
  - [ ] 确认返回支付参数
- [ ] 测试调起微信支付
  - [ ] 确认能正常调起微信支付
- [ ] 测试支付回调
  - [ ] 模拟微信支付回调（或使用真实支付）
  - [ ] 确认回调能正常到达App服务器
  - [ ] 确认订单状态和用户额度正常更新

#### 4.5 消息推送测试
- [ ] 测试消息推送接口
  - [ ] 在微信公众平台发送测试消息
  - [ ] 确认消息能正常到达App服务器
  - [ ] 确认用户和绑定记录正常保存

---

### 阶段5：监控和验证

#### 5.1 日志检查
- [ ] 检查Web服务器lighttpd日志
  ```bash
  ssh root@web "tail -f /var/log/lighttpd/access.log"
  ssh root@web "tail -f /var/log/lighttpd/error.log"
  ```
- [ ] 检查App服务器FastAPI日志
  ```bash
  ssh root@app "tail -f /var/log/image-classifier/access.log"
  ssh root@app "tail -f /var/log/image-classifier/error.log"
  ```
- [ ] 确认反向代理请求正常转发
- [ ] 确认没有错误日志

#### 5.2 性能检查
- [ ] 检查API响应时间
- [ ] 检查反向代理性能
- [ ] 确认没有性能下降

#### 5.3 功能验证
- [ ] 完整测试所有微信相关功能
- [ ] 确认所有接口正常工作
- [ ] 确认所有页面正常访问
- [ ] 确认支付流程完整可用

---

### 阶段6：清理和文档

#### 6.1 清理旧配置（如果需要）
- [ ] 如果Web服务器之前有FastAPI服务，停止并清理
- [ ] 清理不需要的配置文件
- [ ] 清理不需要的代码文件

#### 6.2 更新文档
- [ ] 更新部署文档
- [ ] 更新架构文档
- [ ] 更新配置说明
- [ ] 记录配置变更

#### 6.3 备份和回滚方案
- [ ] 创建回滚方案文档
- [ ] 记录回滚步骤
- [ ] 备份当前配置和代码

---

## 🚨 注意事项

### 安全注意事项
- [ ] 确保反向代理配置安全（防止SSRF攻击）
- [ ] 确保内部服务不直接暴露到公网
- [ ] 确保日志不包含敏感信息

### 性能注意事项
- [ ] 监控反向代理性能
- [ ] 监控App服务器负载
- [ ] 确认连接池配置合理

### 故障处理
- [ ] 准备故障排查步骤
- [ ] 准备回滚方案
- [ ] 准备监控告警

---

## 📝 配置示例

### Web服务器lighttpd配置示例

```lighttpd
# /etc/lighttpd/lighttpd.conf

# 反向代理配置：将所有 /api/v1/* 请求代理到App服务器
$HTTP["url"] =~ "^/api/v1/" {
    proxy.server = (
        "" => (
            (
                "host" => "47.98.167.63",  # App服务器IP
                "port" => 8000
            )
        )
    )
    proxy.header = (
        "map-host-header" => ("-", "Host"),
        "x-forwarded-for" => "$",
        "x-forwarded-proto" => "https"
    )
}

# 静态文件服务（如果需要）
$HTTP["url"] =~ "^/wechat/" {
    server.document-root = "/var/www/xintuxiangce"
}
```

### App服务器FastAPI静态文件配置示例

```python
# app/main.py
from fastapi.staticfiles import StaticFiles

# 配置微信页面静态文件服务
app.mount("/wechat", StaticFiles(directory="wechat"), name="wechat")
```

---

## ✅ 验收标准

### 功能验收
- [ ] 所有API接口正常工作
- [ ] 所有微信页面正常访问
- [ ] 微信授权流程正常
- [ ] 支付流程正常
- [ ] 消息推送正常

### 性能验收
- [ ] API响应时间正常（< 1秒）
- [ ] 反向代理延迟正常（< 100ms）
- [ ] 服务器负载正常

### 稳定性验收
- [ ] 运行24小时无故障
- [ ] 日志无错误
- [ ] 所有功能正常

---

## 📅 时间估算

| 阶段 | 任务 | 预计时间 |
|------|------|---------|
| 阶段1 | 准备工作 | 30分钟 |
| 阶段2 | 配置反向代理 | 1小时 |
| 阶段3 | 部署App服务器 | 2小时 |
| 阶段4 | 测试验证 | 2小时 |
| 阶段5 | 监控和验证 | 1小时 |
| 阶段6 | 清理和文档 | 30分钟 |
| **总计** | | **7小时** |

---

## 🔄 回滚方案

如果出现问题，可以按以下步骤回滚：

1. **恢复Web服务器lighttpd配置**
   ```bash
   ssh root@web "cp /etc/lighttpd/lighttpd.conf.backup.$(date +%Y%m%d) /etc/lighttpd/lighttpd.conf"
   ssh root@web "systemctl restart lighttpd"
   ```

2. **恢复App服务器代码**（如果有备份）

3. **验证回滚后功能正常**

---

**最后更新**: 2024-11-18  
**维护者**: ImageClassifier Team

