# 微信平台配置迁移指南

## 📋 概述

当API服务从web服务器迁移到app服务器后，需要在微信平台进行以下配置更新。

---

## 🔍 需要确认的信息

在开始配置前，请确认以下信息：

1. **新的API域名**：`https://api.aifuture.net.cn`（请确认）
2. **前端页面域名**：`https://www.xintuxiangce.top`（保持不变）
3. **支付回调URL**：`https://api.aifuture.net.cn/api/v1/payment/notify`

---

## 1. 微信公众平台配置 🔐

### 1.1 授权回调域名（网页授权）

**位置**：微信公众平台 → 开发 → 接口权限 → 网页授权获取用户基本信息

**配置项**：授权回调域名

**当前配置**（可能）：
```
www.xintuxiangce.top
```

**是否需要更新**：
- ✅ **不需要更新**（前端页面域名未变）
- 授权回调域名配置的是**前端页面所在域名**，不是API域名
- 授权流程：用户点击菜单 → 微信授权 → 回调到前端页面 → 前端页面调用API

**配置说明**：
- 只需要配置域名，不需要带协议（http/https）和路径
- 例如：`www.xintuxiangce.top`
- 配置后，该域名下的所有页面都可以进行网页授权

---

### 1.2 JS安全域名（微信JS-SDK）

**位置**：微信公众平台 → 设置 → 公众号设置 → 功能设置 → JS接口安全域名

**配置项**：JS接口安全域名

**当前配置**（可能）：
```
www.xintuxiangce.top
```

**是否需要更新**：
- ✅ **不需要更新**（前端页面域名未变）
- JS安全域名配置的是**前端页面所在域名**，不是API域名

**配置说明**：
- 只需要配置域名，不需要带协议和路径
- 例如：`www.xintuxiangce.top`
- 配置后，该域名下的页面可以使用微信JS-SDK

---

### 1.3 服务器配置URL（消息推送）

**位置**：微信公众平台 → 开发 → 基本配置 → 服务器配置

**配置项**：URL（服务器地址）

**当前配置**（需要更新）：
```
https://www.xintuxiangce.top/api/v1/auth/wechat/verify
```

**需要更新为**：
```
https://api.aifuture.net.cn/api/v1/auth/wechat/verify
```

**配置说明**：
- 这是接收微信消息推送的接口地址
- 必须是公网可访问的HTTPS地址
- 需要验证Token（在环境变量`WECHAT_TOKEN`中配置）
- 配置后需要点击"启用"才能生效

**验证步骤**：
1. 更新URL为新的API地址
2. 确认Token与代码中的`WECHAT_TOKEN`一致
3. 点击"提交"验证
4. 验证通过后点击"启用"

---

## 2. 微信商户平台配置 💰

### 2.1 支付授权目录

**位置**：微信商户平台 → 产品中心 → 开发配置 → 支付授权目录

**配置项**：支付授权目录

**当前配置**（可能）：
```
https://www.xintuxiangce.top/
```

**是否需要更新**：
- ✅ **不需要更新**（前端页面域名未变）
- 支付授权目录配置的是**前端支付页面所在域名**，不是API域名
- 支付流程：前端页面调起支付 → 调用API创建订单 → 微信支付

**配置说明**：
- 需要配置完整的URL路径，包括协议和域名
- 例如：`https://www.xintuxiangce.top/`
- 配置后，该目录下的页面可以调起微信支付

---

### 2.2 支付回调URL

**位置**：微信商户平台 → 产品中心 → 开发配置 → 支付配置

**配置项**：支付回调URL（或"支付通知URL"）

**当前配置**（需要更新）：
```
https://www.xintuxiangce.top/api/v1/payment/notify
```

**需要更新为**：
```
https://api.aifuture.net.cn/api/v1/payment/notify
```

**配置说明**：
- 这是接收微信支付结果通知的接口地址
- 必须是公网可访问的HTTPS地址
- 接口需要验证微信签名确保安全性
- 配置后，用户完成支付时微信会调用此接口

**验证步骤**：
1. 更新URL为新的API地址
2. 确认接口可以正常访问（返回XML格式）
3. 进行一笔测试支付，验证回调是否正常

---

## 3. 代码配置更新 📝

### 3.1 支付回调URL配置

**文件**：`app/config.py`

**配置项**：`WECHAT_PAY_NOTIFY_URL`

**需要更新为**：
```python
WECHAT_PAY_NOTIFY_URL=https://api.aifuture.net.cn/api/v1/payment/notify
```

**更新方式**：
- 在`.env`文件中设置环境变量
- 或在服务器环境变量中设置

---

### 3.2 前端API地址（如需要）

**文件**：`wechat/*.html`

**当前配置**：
```javascript
const API_BASE_URL = 'https://www.xintuxiangce.top/api/v1';
```

**是否需要更新**：
- ⚠️ **需要确认**
- 如果API服务已迁移到新域名，需要更新为：
```javascript
const API_BASE_URL = 'https://api.aifuture.net.cn/api/v1';
```

**需要更新的文件**：
- `wechat/member.html` (第211行)
- `wechat/credits.html` (第258行)
- `wechat/credits_info.html` (第273行)

---

## 4. 配置检查清单 ✅

### 微信公众平台
- [ ] **授权回调域名**：确认配置为 `www.xintuxiangce.top`（无需更新）
- [ ] **JS安全域名**：确认配置为 `www.xintuxiangce.top`（无需更新）
- [ ] **服务器配置URL**：更新为 `https://api.aifuture.net.cn/api/v1/auth/wechat/verify`
- [ ] **Token验证**：确认Token与代码中的`WECHAT_TOKEN`一致
- [ ] **启用服务器配置**：验证通过后点击"启用"

### 微信商户平台
- [ ] **支付授权目录**：确认配置为 `https://www.xintuxiangce.top/`（无需更新）
- [ ] **支付回调URL**：更新为 `https://api.aifuture.net.cn/api/v1/payment/notify`
- [ ] **测试支付回调**：进行测试支付，验证回调是否正常

### 代码配置
- [ ] **支付回调URL**：更新`.env`中的`WECHAT_PAY_NOTIFY_URL`
- [ ] **前端API地址**：如需要，更新HTML文件中的`API_BASE_URL`
- [ ] **重启服务**：更新配置后重启API服务

---

## 5. 测试验证 🧪

### 5.1 服务器配置验证

1. 在微信公众平台更新服务器配置URL
2. 点击"提交"进行验证
3. 验证通过后点击"启用"
4. 发送消息到公众号，确认能正常接收

### 5.2 网页授权测试

1. 点击公众号菜单"开通会员"
2. 确认能正常跳转并获取openid
3. 检查浏览器控制台，确认API调用正常

### 5.3 支付回调测试

1. 进行一笔测试支付（金额0.01元）
2. 完成支付后，检查：
   - 订单状态是否更新
   - 用户额度/会员是否更新
   - 服务器日志中是否有回调记录

---

## 6. 常见问题 ❓

### Q1: 授权回调域名和API域名有什么区别？

**A**: 
- **授权回调域名**：配置前端页面所在域名，用于网页授权回调
- **API域名**：后端服务所在域名，用于接收API请求
- 两者可以不同，授权流程是：微信 → 前端页面 → 前端调用API

### Q2: 支付授权目录和支付回调URL有什么区别？

**A**:
- **支付授权目录**：配置前端支付页面所在域名，用于调起支付
- **支付回调URL**：配置后端API地址，用于接收支付结果通知
- 两者可以不同，支付流程是：前端调起支付 → 用户支付 → 微信回调API

### Q3: 更新配置后多久生效？

**A**:
- 微信公众平台配置：通常立即生效
- 微信商户平台配置：可能需要几分钟生效
- 建议更新后等待5-10分钟再进行测试

### Q4: 如何确认配置是否正确？

**A**:
1. 检查服务器日志，确认接口被正常调用
2. 进行实际测试（授权、支付）
3. 检查数据库，确认数据正常更新

---

## 7. 回滚方案 🔄

如果迁移后出现问题，可以：

1. **临时回滚**：将微信平台的配置改回原来的URL
2. **检查日志**：查看服务器日志，定位问题
3. **逐步迁移**：先迁移非关键功能，确认正常后再迁移支付功能

---

**最后更新**: 2024-11-18  
**维护者**: ImageClassifier Team

