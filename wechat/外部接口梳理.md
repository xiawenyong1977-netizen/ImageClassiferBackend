# WeChatç›®å½•å¤–éƒ¨æ¥å£æ¢³ç†

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ¢³ç†äº†`wechat`ç›®å½•ä¸­ä¸å¤–éƒ¨ç³»ç»Ÿç›¸å…³çš„æ‰€æœ‰æ¥å£å’Œè¿æ¥é…ç½®ã€‚

---

## 1. å¾®ä¿¡å…¬ä¼—å·èœå•é“¾æ¥ ğŸ”—

### é…ç½®ä½ç½®
- **æ–‡ä»¶**: `app/api/auth.py`
- **å‡½æ•°**: `create_wechat_menu()` (çº¦ç¬¬705-816è¡Œ)

### å½“å‰é…ç½®
èœå•ä¸­çš„`redirect_uri`æŒ‡å‘ä»¥ä¸‹URLï¼ˆéœ€è¦æ›´æ–°ï¼‰ï¼š
```python
member_url = "https://www.xintuxiangce.top/member.html"
credits_url = "https://www.xintuxiangce.top/credits.html"
credits_info_url = "https://www.xintuxiangce.top/credits_info.html"
```

### éœ€è¦æ›´æ–°ä¸º
```python
member_url = "https://www.xintuxiangce.top/wechat/member.html"
credits_url = "https://www.xintuxiangce.top/wechat/credits.html"
credits_info_url = "https://www.xintuxiangce.top/wechat/credits_info.html"
```

### èœå•ç»“æ„
- **ä¸»èœå•1**: èŠ¯å›¾ç›¸å†Œ â†’ ç›´æ¥è·³è½¬åˆ° `https://www.xintuxiangce.top`
- **ä¸»èœå•2**: ä¼šå‘˜æœåŠ¡
  - å­èœå•1: å¼€é€šä¼šå‘˜ â†’ `member.html`
  - å­èœå•2: è´­ä¹°é¢åº¦ â†’ `credits.html`
  - å­èœå•3: é¢åº¦æŸ¥è¯¢ â†’ `credits_info.html`

### æˆæƒæµç¨‹ï¼ˆé™é»˜æˆæƒï¼‰
1. ç”¨æˆ·ç‚¹å‡»èœå•
2. è‡ªåŠ¨è·³è½¬åˆ°å¾®ä¿¡æˆæƒé¡µé¢ï¼š`https://open.weixin.qq.com/connect/oauth2/authorize`
   - ä½¿ç”¨ `scope=snsapi_base`ï¼ˆé™é»˜æˆæƒï¼‰
   - **æ— éœ€ç”¨æˆ·ç¡®è®¤**ï¼Œè‡ªåŠ¨å®Œæˆæˆæƒ
   - åªèƒ½è·å– `openid`ï¼Œä¸è·å–ç”¨æˆ·å…¶ä»–ä¿¡æ¯
3. å¾®ä¿¡è‡ªåŠ¨å›è°ƒåˆ°ç›®æ ‡é¡µé¢ï¼ŒURLå‚æ•°ä¸­åŒ…å«`code`
4. é¡µé¢é€šè¿‡`code`è°ƒç”¨`/api/v1/auth/wechat?code=xxx`è·å–`openid`

---

## 2. å¾®ä¿¡æ”¯ä»˜å›è°ƒæ¥å£ ğŸ’°

### é…ç½®ä½ç½®
- **é…ç½®æ–‡ä»¶**: `app/config.py`
- **é…ç½®é¡¹**: `WECHAT_PAY_NOTIFY_URL` (ç¬¬125-128è¡Œ)
- **é»˜è®¤å€¼**: `https://your-domain.com/api/v1/payment/notify`

### å®é™…æ¥å£
- **æ–‡ä»¶**: `app/api/payment.py`
- **è·¯ç”±**: `POST /api/v1/payment/notify` (ç¬¬215è¡Œ)
- **åŠŸèƒ½**: æ¥æ”¶å¾®ä¿¡æ”¯ä»˜ç»“æœé€šçŸ¥

### å›è°ƒæµç¨‹
1. ç”¨æˆ·å®Œæˆæ”¯ä»˜
2. å¾®ä¿¡æœåŠ¡å™¨è°ƒç”¨é…ç½®çš„`notify_url`
3. åç«¯éªŒè¯ç­¾åå¹¶å¤„ç†è®¢å•
4. è¿”å›`SUCCESS`æˆ–`FAIL`ç»™å¾®ä¿¡æœåŠ¡å™¨

### æ³¨æ„äº‹é¡¹
- å¿…é¡»æ˜¯å…¬ç½‘å¯è®¿é—®çš„HTTPSåœ°å€
- éœ€è¦åœ¨å¾®ä¿¡å•†æˆ·å¹³å°é…ç½®å›è°ƒåŸŸå
- æ¥å£éœ€è¦éªŒè¯å¾®ä¿¡ç­¾åç¡®ä¿å®‰å…¨æ€§

---

## 3. å‰ç«¯APIè°ƒç”¨ ğŸŒ

### APIåŸºç¡€URL
æ‰€æœ‰HTMLæ–‡ä»¶ä¸­çš„APIåŸºç¡€åœ°å€ï¼š
```javascript
const API_BASE_URL = 'https://www.xintuxiangce.top/api/v1';
```

### è°ƒç”¨çš„APIæ¥å£åˆ—è¡¨

#### 3.1 å¾®ä¿¡æˆæƒæ¥å£
- **æ¥å£**: `GET /api/v1/auth/wechat?code={code}`
- **ç”¨é€”**: é€šè¿‡å¾®ä¿¡æˆæƒç è·å–openid
- **è°ƒç”¨ä½ç½®**: 
  - `member.html` (ç¬¬240è¡Œ)
  - `credits.html` (ç¬¬300è¡Œ)
  - `credits_info.html` (ç¬¬318è¡Œ)

#### 3.2 åˆ›å»ºè®¢å•æ¥å£
- **æ¥å£**: `POST /api/v1/payment/create-order`
- **ç”¨é€”**: åˆ›å»ºæ”¯ä»˜è®¢å•
- **è°ƒç”¨ä½ç½®**:
  - `member.html` (ç¬¬377è¡Œ)
  - `credits.html` (ç¬¬395è¡Œ)

#### 3.3 æŸ¥è¯¢é¢åº¦æ¥å£
- **æ¥å£**: `GET /api/v1/user/credits`
- **ç”¨é€”**: æŸ¥è¯¢ç”¨æˆ·å½“å‰é¢åº¦
- **è°ƒç”¨ä½ç½®**:
  - `member.html` (ç¬¬280è¡Œ)
  - `credits_info.html` (ç¬¬372è¡Œ)

#### 3.4 æŸ¥è¯¢ä¼šå‘˜æ¥å£
- **æ¥å£**: `GET /api/v1/user/member`
- **ç”¨é€”**: æŸ¥è¯¢ç”¨æˆ·ä¼šå‘˜çŠ¶æ€
- **è°ƒç”¨ä½ç½®**:
  - `member.html` (ç¬¬388è¡Œ)

#### 3.5 æŸ¥è¯¢é¢åº¦ä½¿ç”¨è®°å½•æ¥å£
- **æ¥å£**: `GET /api/v1/user/credits-usage`
- **ç”¨é€”**: æŸ¥è¯¢é¢åº¦ä½¿ç”¨å†å²
- **è°ƒç”¨ä½ç½®**:
  - `credits_info.html` (ç¬¬447è¡Œ)

---

## 4. å¾®ä¿¡æœåŠ¡å™¨éªŒè¯æ¥å£ ğŸ”

### é…ç½®éªŒè¯æ¥å£
- **è·¯ç”±**: `GET /api/v1/auth/wechat/verify`
- **æ–‡ä»¶**: `app/main.py` (ç¬¬101-109è¡Œ)
- **ç”¨é€”**: å¾®ä¿¡å…¬ä¼—å¹³å°æœåŠ¡å™¨é…ç½®éªŒè¯
- **å‚æ•°**: `signature`, `timestamp`, `nonce`, `echostr`

### æ¶ˆæ¯æ¨é€æ¥å£
- **è·¯ç”±**: `POST /api/v1/auth/wechat/verify`
- **æ–‡ä»¶**: `app/main.py` (ç¬¬112-115è¡Œ)
- **ç”¨é€”**: æ¥æ”¶å¾®ä¿¡å…¬ä¼—å·æ¶ˆæ¯æ¨é€
- **å®ç°**: `app/api/auth.py` ä¸­çš„ `wechat_message_handler()`

---

## 5. å…¶ä»–å¤–éƒ¨ä¾èµ– ğŸ“¦

### 5.1 åŸŸåé…ç½®
- **å‰ç«¯é¡µé¢åŸŸå**: `https://www.xintuxiangce.top`
- **APIåŸŸå**: `https://www.xintuxiangce.top/api/v1`
- **éœ€è¦é…ç½®**: å¾®ä¿¡å…¬ä¼—å¹³å°JSå®‰å…¨åŸŸå

### 5.2 å¾®ä¿¡å¼€æ”¾å¹³å°é…ç½®
- **æˆæƒåŸŸå**: éœ€è¦åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½®æˆæƒå›è°ƒåŸŸå
- **æ”¯ä»˜åŸŸå**: éœ€è¦åœ¨å¾®ä¿¡å•†æˆ·å¹³å°é…ç½®æ”¯ä»˜æˆæƒç›®å½•

### 5.3 é™æ€èµ„æº
- **å›¾ç‰‡**: `imageclassify.png` (1.0MB)
- **ä½ç½®**: `wechat/imageclassify.png`
- **è®¿é—®è·¯å¾„**: `/wechat/imageclassify.png` (å¦‚æœé€šè¿‡Nginx/FastAPIæŒ‚è½½)

---

## ğŸ“ éœ€è¦æ›´æ–°çš„é…ç½®æ¸…å•

### 1. å¾®ä¿¡å…¬ä¼—å·èœå•é“¾æ¥
- [ ] æ›´æ–° `app/api/auth.py` ä¸­çš„ `redirect_uri` è·¯å¾„
  - `member.html` â†’ `wechat/member.html`
  - `credits.html` â†’ `wechat/credits.html`
  - `credits_info.html` â†’ `wechat/credits_info.html`

### 2. æ”¯ä»˜å›è°ƒURL
- [ ] ç¡®è®¤ `app/config.py` ä¸­çš„ `WECHAT_PAY_NOTIFY_URL` é…ç½®æ­£ç¡®
- [ ] ç¡®ä¿å›è°ƒURLæ˜¯å…¬ç½‘å¯è®¿é—®çš„HTTPSåœ°å€

### 3. å‰ç«¯APIåœ°å€ï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] å¦‚æœAPIåŸŸåæœ‰å˜åŒ–ï¼Œéœ€è¦æ›´æ–°æ‰€æœ‰HTMLæ–‡ä»¶ä¸­çš„ `API_BASE_URL`

### 4. å¾®ä¿¡å¹³å°é…ç½®
- [ ] å¾®ä¿¡å…¬ä¼—å¹³å°ï¼šæ›´æ–°æˆæƒå›è°ƒåŸŸå
- [ ] å¾®ä¿¡å•†æˆ·å¹³å°ï¼šæ›´æ–°æ”¯ä»˜æˆæƒç›®å½•
- [ ] å¾®ä¿¡å…¬ä¼—å¹³å°ï¼šæ›´æ–°JSå®‰å…¨åŸŸå

---

## ğŸ” æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰è¯·ç¡®è®¤ï¼š
- [ ] å¾®ä¿¡å…¬ä¼—å·èœå•é“¾æ¥æŒ‡å‘æ­£ç¡®çš„è·¯å¾„
- [ ] æ”¯ä»˜å›è°ƒURLé…ç½®æ­£ç¡®ä¸”å¯è®¿é—®
- [ ] æ‰€æœ‰APIæ¥å£åœ°å€æ­£ç¡®
- [ ] å¾®ä¿¡å¹³å°ç›¸å…³åŸŸåé…ç½®å·²æ›´æ–°
- [ ] HTTPSè¯ä¹¦æœ‰æ•ˆ
- [ ] é™æ€æ–‡ä»¶æœåŠ¡é…ç½®æ­£ç¡®ï¼ˆNginxæˆ–FastAPIï¼‰

---

**æœ€åæ›´æ–°**: 2024-11-18
**ç»´æŠ¤è€…**: ImageClassifier Team

