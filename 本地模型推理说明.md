# 本地模型推理说明 📝

## ✅ 简化完成

已将代码简化为单一版本，使用 **Ultralytics** 库自动处理YOLO的预处理和后处理。

## 📦 核心文件

```
app/
├── services/
│   └── local_model_inference.py  # 本地模型推理服务（使用Ultralytics）
└── api/
    └── local_classify.py          # 本地分类API接口
```

## 🚀 快速使用

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

主要依赖：
- **ultralytics** - YOLO推理库（自动预处理/后处理）
- **onnxruntime** - ONNX模型推理
- **numpy** - 数值计算
- **Pillow** - 图像处理

### 2. 在代码中使用

```python
from app.services.local_model_inference import local_model_inference

# 初始化模型（首次调用）
await local_model_inference.initialize()

# 执行推理
result = await local_model_inference.classify_image(image_bytes)

# 查看结果
print(f"分类: {result['categoryId']}")
print(f"置信度: {result['confidence']}")
```

### 3. API接口

- `POST /api/v1/local-classify` - 本地模型分类
- `POST /api/v1/local-classify/detailed` - 详细结果
- `GET /api/v1/local-classify/models` - 模型状态

## 🎯 支持的3个模型

1. **ID卡识别** - `id_card_detection.onnx`
2. **YOLO8s通用检测** - `yolov8s.onnx` (80种物体)
3. **MobileNetV3分类** - `mobilenetv3_rw_Opset17.onnx` (1000类)

## 🏷️ 分类结果

| 分类ID | 说明 |
|--------|------|
| `idcard` | 证件照 |
| `single_person` | 单人照片 |
| `social_activities` | 多人合照 |
| `pets` | 宠物 |
| `foods` | 美食 |
| `travel_scenery` | 风景 |
| `screenshot` | 截图（客户端识别） |
| `other` | 其它 |

## ⚠️ 重要说明

### 手机截图识别

**手机截图应在客户端识别**，因为：
- 服务器收到的图片已经过缩放处理
- 宽高比信息已失真
- 客户端可以在上传前判断并附带标记

客户端实现示例：
```javascript
// 客户端判断截图
const isScreenshot = (width, height) => {
  const aspectRatio = width / height;
  return aspectRatio <= 0.5;
};

// 上传时附带标记
const uploadData = {
  image: imageFile,
  is_screenshot: isScreenshot(width, height)
};
```

## 📖 技术特点

### 为什么使用这些库？

#### YOLO检测 - Ultralytics
✅ **简化代码** - 预处理/后处理/NMS全自动
✅ **性能优化** - 官方优化实现
✅ **易于维护** - 标准库，文档完善

#### MobileNetV3预处理 - torchvision.transforms
✅ **标准化** - PyTorch官方预处理库
✅ **自动优化** - 底层C++实现
✅ **零额外依赖** - ultralytics已包含

### 对比手动实现

| 操作 | 手动实现 | 使用库 |
|------|---------|--------|
| YOLO预处理 | ~50行代码 | 自动（Ultralytics）|
| YOLO后处理 | ~80行代码 | 自动（Ultralytics）|
| MobileNetV3预处理 | ~20行代码 | 3行（torchvision）|
| 维护成本 | 高 | 低 |
| 代码总量 | ~150行 | ~10行 ✅ |

## 🧪 测试

```bash
python test_local_inference.py
```

## 📚 详细文档

- 📖 [详细使用说明](./本地模型推理使用说明.md)
- 📖 [快速入门指南](./本地模型推理快速入门.md)

---

**版本**: 1.0.0 (简化版)  
**更新日期**: 2025-10-11  
**技术栈**: Ultralytics + ONNX Runtime

