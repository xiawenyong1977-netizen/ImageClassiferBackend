# 📖 图片分类后端系统 - 快速使用手册

## 🌐 访问地址

**Web管理界面**：http://123.57.68.4:8000/

⚠️ **如无法访问**：请在阿里云控制台开放8000端口

---

## 🎯 三大核心功能

### 1️⃣ 统计数据（📊 标签）

**功能**：实时查看系统运行数据

**可以看到**：
- 系统状态（服务、数据库、API）
- 今日请求数、缓存命中率
- 独立用户数、平均处理时间
- 预估成本、节省成本
- 缓存图片总数、总命中次数
- 分类分布（各类别占比）

**特点**：每30秒自动刷新

---

### 2️⃣ 分类测试（🧪 标签）

**功能**：上传图片测试分类功能

**操作步骤**：
1. 点击或拖拽上传图片
2. 预览图片
3. 点击"开始分类"按钮
4. 查看分类结果

**显示信息**：
- 分类类别（中文）
- 置信度（进度条）
- 图片描述
- 是否来自缓存
- 处理耗时
- 请求ID

**支持格式**：JPG、PNG、WebP、GIF  
**最大大小**：10MB

---

### 3️⃣ 配置管理（⚙️ 标签）

**功能**：查看和管理配置

**可配置项**：
- API服务地址
- 大模型提供商（固定：阿里云）
- 模型名称（固定：qwen-vl-plus）
- API密钥（提示）
- 分类提示词（查看和编辑）

**分类类别说明表**：8种预定义分类的详细说明

⚠️ **注意**：Web界面的配置仅保存在浏览器，实际修改需要SSH到服务器

---

## 🔧 配置修改指南

### 修改API密钥

```bash
# 1. SSH连接
ssh root@123.57.68.4

# 2. 编辑配置
cd /opt/ImageClassifierBackend
vi .env

# 3. 找到这行修改
LLM_API_KEY=sk-你的新密钥

# 4. 保存并重启
systemctl restart image-classifier
```

### 修改提示词

```bash
# 编辑.env文件
vi /opt/ImageClassifierBackend/.env

# 添加或修改（注意转义换行符\n）
CLASSIFICATION_PROMPT="你的自定义提示词\n可以多行\n分类要求..."

# 重启服务
systemctl restart image-classifier
```

---

## 📱 客户端集成指南

### API调用流程

**推荐流程（最优化）**：

```javascript
// 步骤1: 压缩图片
const compressed = await compressImage(originalImage, {
  maxWidth: 1024,
  quality: 0.8
});

// 步骤2: 计算哈希
const imageHash = await calculateSHA256(compressed);

// 步骤3: 查询缓存
const cacheResult = await fetch('http://123.57.68.4:8000/api/v1/classify/check-cache', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ image_hash: imageHash })
});

const cache = await cacheResult.json();

// 步骤4: 如果命中缓存，直接返回
if (cache.cached) {
  return cache.data;  // 节省100%带宽！
}

// 步骤5: 未命中，上传图片
const formData = new FormData();
formData.append('image', compressed);
formData.append('image_hash', imageHash);

const result = await fetch('http://123.57.68.4:8000/api/v1/classify', {
  method: 'POST',
  body: formData
});

return await result.json();
```

### 分类结果映射

**服务器返回**：
```json
{
  "category": "foods",
  "confidence": 0.92,
  "description": "一盘美味的意大利面"
}
```

**客户端显示**：
```javascript
const categoryMap = {
  "social_activities": "社交活动",
  "pets": "宠物萌照",
  "single_person": "单人照片",
  "foods": "美食记录",
  "travel_scenery": "旅行风景",
  "screenshot": "手机截图",
  "idcard": "证件照",
  "other": "其它"
};

const displayName = categoryMap[result.category];  // "美食记录"
```

---

## 📊 8种分类类别

| Key | 中文 | 适用场景 |
|-----|------|---------|
| `social_activities` | 社交活动 | 聚会、合影、团建 |
| `pets` | 宠物萌照 | 猫、狗等宠物 |
| `single_person` | 单人照片 | 自拍、个人照 |
| `foods` | 美食记录 | 美食、餐饮 |
| `travel_scenery` | 旅行风景 | 旅游、风景 |
| `screenshot` | 手机截图 | 屏幕截图 |
| `idcard` | 证件照 | 身份证等 |
| `other` | 其它 | 无法归类 |

---

## 🔍 监控与维护

### 每日检查

```bash
# 查看服务状态
systemctl status image-classifier

# 查看今日统计
curl http://localhost:8000/api/v1/stats/today
```

### 每周检查

```bash
# 查看缓存效率
curl http://localhost:8000/api/v1/stats/cache-efficiency

# 清理旧日志（可选）
mysql -u classifier -pClassifier@2024 -e "
USE image_classifier;
DELETE FROM request_log WHERE created_at < DATE_SUB(NOW(), INTERVAL 30 DAY);
"
```

### 性能监控

在Web界面查看：
- 缓存命中率（建议>30%）
- 平均处理时间（建议<2000ms）
- 每日请求量趋势

---

## 💰 成本控制

### 降低成本的方法

1. **提高缓存命中率**
   - 鼓励用户分享热门图片
   - 网络流行图片自动缓存

2. **客户端优化**
   - 压缩图片再上传
   - 先查询哈希缓存

3. **提示词优化**
   - 减少不必要的描述
   - 降低max_tokens设置

### 成本监控

在Web界面"统计数据"页可以看到：
- 今日API调用成本
- 缓存节省成本
- 月度预估

---

## 🆘 故障排查

| 问题 | 解决方案 |
|------|---------|
| 服务无法启动 | `journalctl -u image-classifier -n 50` |
| 分类返回other | 检查API密钥，查看日志 |
| 外网无法访问 | 阿里云控制台开放8000端口 |
| 数据库连接失败 | `systemctl status mariadb` |
| 内存占用过高 | 重启服务 `systemctl restart image-classifier` |

---

## ✅ 使用检查清单

- [ ] Web界面可以正常访问
- [ ] 系统状态显示"healthy"
- [ ] 可以上传图片并分类成功
- [ ] 统计数据正常显示
- [ ] 缓存机制正常工作（相同图片第二次上传会命中缓存）
- [ ] 分类结果准确（符合图片内容）
- [ ] 置信度合理（通常>0.7）

---

## 🎯 开始使用

1. **打开Web界面**：http://123.57.68.4:8000/
2. **上传测试图片**：切换到"分类测试"标签
3. **查看统计数据**：观察系统运行情况
4. **集成到APP**：参考客户端集成指南

---

**系统已就绪，开始使用吧！** 🚀✨

有任何问题随时查看文档或联系技术支持！

