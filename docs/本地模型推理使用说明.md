# æœ¬åœ°æ¨¡å‹æ¨ç†ä½¿ç”¨è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬åœ°æ¨¡å‹æ¨ç†æœåŠ¡ä½¿ç”¨ONNX Runtimeå¯¹ä¸Šä¼ çš„å›¾ç‰‡è¿›è¡Œæ¨ç†ï¼Œæ”¯æŒä¸‰ä¸ªç¥ç»ç½‘ç»œæ¨¡å‹ï¼š

1. **IDå¡è¯†åˆ«æ¨¡å‹** (`id_card_detection.onnx`) - æ£€æµ‹èº«ä»½è¯æ­£åé¢
2. **YOLO8sé€šç”¨æ£€æµ‹æ¨¡å‹** (`yolov8s.onnx`) - æ£€æµ‹80ç§å¸¸è§ç‰©ä½“ï¼ˆCOCOæ•°æ®é›†ï¼‰
3. **MobileNetV3å›¾åƒåˆ†ç±»æ¨¡å‹** (`mobilenetv3_rw_Opset17.onnx`) - ImageNet 1000ç±»å›¾åƒåˆ†ç±»

## ğŸ—‚ï¸ æ–‡ä»¶ç»“æ„

```
ImageClassifierBackend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ id_card_detection.onnx      # IDå¡æ£€æµ‹æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ yolov8s.onnx                # YOLO8sé€šç”¨æ£€æµ‹æ¨¡å‹
â”‚   â”‚   â””â”€â”€ mobilenetv3_rw_Opset17.onnx # MobileNetV3åˆ†ç±»æ¨¡å‹
â”‚   â””â”€â”€ services/
â”‚       â””â”€â”€ local_model_inference.py    # æœ¬åœ°æ¨¡å‹æ¨ç†æœåŠ¡
â”œâ”€â”€ test_local_inference.py             # æµ‹è¯•è„šæœ¬
â””â”€â”€ æœ¬åœ°æ¨¡å‹æ¨ç†ä½¿ç”¨è¯´æ˜.md              # æœ¬æ–‡æ¡£
```

## ğŸ“¦ ä¾èµ–å®‰è£…

ç¡®ä¿å·²å®‰è£…ä»¥ä¸‹ä¾èµ–ï¼š

```bash
pip install onnxruntime==1.16.3
pip install numpy==1.24.3
pip install Pillow==10.2.0
```

æˆ–è€…ç›´æ¥å®‰è£…æ‰€æœ‰ä¾èµ–ï¼š

```bash
pip install -r requirements.txt
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. åŸºæœ¬ä½¿ç”¨

```python
import asyncio
from app.services.local_model_inference import local_model_inference

async def main():
    # åˆå§‹åŒ–æ¨¡å‹
    await local_model_inference.initialize()
    
    # è¯»å–å›¾ç‰‡
    with open("test_image.jpg", "rb") as f:
        image_bytes = f.read()
    
    # æ‰§è¡Œæ¨ç†
    result = await local_model_inference.classify_image(image_bytes)
    
    # æŸ¥çœ‹ç»“æœ
    print(f"åˆ†ç±»: {result['categoryId']}")
    print(f"ç½®ä¿¡åº¦: {result['confidence']}")
    print(f"æ¶ˆæ¯: {result['message']}")

asyncio.run(main())
```

### 2. è¾“å‡ºæ ¼å¼

æ¨ç†ç»“æœä¸å®¢æˆ·ç«¯ä»£ç ä¿æŒä¸€è‡´ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š

```python
{
    'success': bool,           # æ˜¯å¦æˆåŠŸ
    'categoryId': str,         # åˆ†ç±»ID (è§ä¸‹æ–¹åˆ†ç±»åˆ—è¡¨)
    'confidence': float,       # ç½®ä¿¡åº¦ (0-1)
    'message': str,            # æ¶ˆæ¯æè¿°
    
    # æ£€æµ‹ç»“æœè¯¦æƒ…
    'idCardDetections': [      # IDå¡æ£€æµ‹ç»“æœ
        {
            'classId': int,
            'className': str,
            'confidence': float,
            'bbox': [x, y, w, h]
        }
    ],
    'generalDetections': [     # é€šç”¨ç‰©ä½“æ£€æµ‹ç»“æœ
        {
            'classId': int,
            'className': str,
            'confidence': float,
            'bbox': [x, y, w, h]
        }
    ],
    'mobileNetV3Detections': { # MobileNetV3åˆ†ç±»ç»“æœ
        'predictions': [
            {
                'index': int,
                'probability': float,
                'class': str
            }
        ],
        'topPrediction': {...},
        'confidence': float
    },
    
    # å›¾ç‰‡ä¿¡æ¯
    'imageDimensions': {
        'width': int,
        'height': int
    },
    
    # æ‰€æœ‰æ¨¡å‹åŸå§‹ç»“æœ
    'allModelResults': {
        'mobileScreenshot': bool,
        'idCard': [...],
        'general': [...],
        'mobileNetV3': {...}
    }
}
```

## ğŸ·ï¸ æ”¯æŒçš„åˆ†ç±»ç±»åˆ«

| åˆ†ç±»ID | ä¸­æ–‡åç§° | è¯´æ˜ |
|--------|---------|------|
| `social_activities` | ç¤¾äº¤æ´»åŠ¨ | å¤šäººåˆç…§ã€èšä¼šç­‰ |
| `pets` | å® ç‰©èŒç…§ | çŒ«ã€ç‹—ã€é¸Ÿç­‰å® ç‰© |
| `single_person` | å•äººç…§ç‰‡ | å•äººè‚–åƒã€è‡ªæ‹ç­‰ |
| `foods` | ç¾é£Ÿè®°å½• | é£Ÿç‰©ã€é¤é¥®ç…§ç‰‡ |
| `travel_scenery` | æ—…è¡Œé£æ™¯ | é£æ™¯ã€å»ºç­‘ã€æ—…æ¸¸ç…§ç‰‡ |
| `screenshot` | æ‰‹æœºæˆªå›¾ | æ‰‹æœºå±å¹•æˆªå›¾ |
| `idcard` | è¯ä»¶ç…§ | èº«ä»½è¯ã€è¯ä»¶ç±»ç…§ç‰‡ |
| `other` | å…¶å®ƒ | æ— æ³•æ˜ç¡®åˆ†ç±»çš„ç…§ç‰‡ |

## ğŸ”§ åˆ†ç±»é€»è¾‘

åˆ†ç±»æŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§è¿›è¡Œï¼š

1. **èº«ä»½è¯æ£€æµ‹** - æ£€æµ‹åˆ°èº«ä»½è¯æ­£åé¢ â†’ `idcard`
2. **äººç‰©æ£€æµ‹**
   - å•äºº â†’ `single_person`
   - å¤šäºº â†’ `social_activities`
3. **å® ç‰©æ£€æµ‹** - æ£€æµ‹åˆ°çŒ«ã€ç‹—ã€é¸Ÿç­‰ â†’ `pets`
4. **ç¾é£Ÿæ£€æµ‹** - æ£€æµ‹åˆ°é£Ÿç‰©ç›¸å…³ç‰©ä½“ â†’ `foods`
5. **é£æ™¯æ£€æµ‹** - æ£€æµ‹ç‰©ä½“è¾ƒå°‘æˆ–æ— æ˜æ˜¾ä¸»ä½“ â†’ `travel_scenery`
6. **é»˜è®¤åˆ†ç±»** - æ— æ³•æ˜ç¡®åˆ†ç±»æ—¶è¿”å› `other`

**æ³¨æ„**ï¼šæ‰‹æœºæˆªå›¾è¯†åˆ«åº”åœ¨å®¢æˆ·ç«¯å®Œæˆï¼ˆä¸Šä¼ å‰åˆ¤æ–­ï¼‰ï¼Œå› ä¸ºæœåŠ¡å™¨æ”¶åˆ°çš„å›¾ç‰‡å·²ç»è¿‡ç¼©æ”¾å¤„ç†ã€‚

## ğŸ§ª æµ‹è¯•

è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š

```bash
python test_local_inference.py
```

æµ‹è¯•è„šæœ¬ä¼šï¼š
1. åˆå§‹åŒ–æ‰€æœ‰æ¨¡å‹
2. éªŒè¯è¾“å‡ºæ ¼å¼å…¼å®¹æ€§
3. å¯¹æµ‹è¯•å›¾ç‰‡è¿›è¡Œæ¨ç†ï¼ˆå¦‚æœæä¾›ï¼‰

## âš™ï¸ æ¨¡å‹é…ç½®

å¯ä»¥åœ¨ `local_model_inference.py` ä¸­è°ƒæ•´æ¨¡å‹å‚æ•°ï¼š

```python
self.model_configs = {
    "idCard": {
        "confidence_threshold": 0.7,  # ç½®ä¿¡åº¦é˜ˆå€¼
        "nms_threshold": 0.4,         # NMSé˜ˆå€¼
        "input_size": 640             # è¾“å…¥å°ºå¯¸
    },
    "yolo8s": {
        "confidence_threshold": 0.25,
        "nms_threshold": 0.4,
        "input_size": 640
    },
    "mobilenetv3": {
        "confidence_threshold": 0.3,
        "input_size": 224
    }
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### GPUåŠ é€Ÿ

å¦‚æœæœ‰NVIDIA GPUï¼Œå¯ä»¥å®‰è£…CUDAç‰ˆæœ¬çš„ONNX Runtimeä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼š

```bash
pip uninstall onnxruntime
pip install onnxruntime-gpu==1.16.3
```

### æ‰¹é‡æ¨ç†

å¯¹äºæ‰¹é‡å›¾ç‰‡å¤„ç†ï¼Œå¯ä»¥è€ƒè™‘ï¼š
1. å¤ç”¨å·²åŠ è½½çš„æ¨¡å‹ï¼ˆé¿å…é‡å¤åˆå§‹åŒ–ï¼‰
2. ä½¿ç”¨å¼‚æ­¥å¹¶å‘å¤„ç†å¤šå¼ å›¾ç‰‡
3. åˆç†è®¾ç½®ç½®ä¿¡åº¦é˜ˆå€¼ä»¥å¹³è¡¡é€Ÿåº¦å’Œå‡†ç¡®æ€§

## ğŸ“Š YOLO8sæ£€æµ‹çš„ç‰©ä½“ç±»åˆ«

YOLO8sæ”¯æŒ80ç§COCOæ•°æ®é›†ç±»åˆ«ï¼ŒåŒ…æ‹¬ï¼š

- **äººç‰©**: person
- **åŠ¨ç‰©**: bird, cat, dog, horse, sheep, cow, elephant, bear, zebra, giraffe
- **äº¤é€šå·¥å…·**: bicycle, car, motorcycle, airplane, bus, train, truck, boat
- **å®¶å…·**: chair, couch, bed, dining table, toilet
- **ç”µå­äº§å“**: tv, laptop, mouse, keyboard, cell phone
- **é£Ÿç‰©**: banana, apple, sandwich, orange, pizza, donut, cake
- ç­‰å…±80ä¸ªç±»åˆ«

è¯¦ç»†ç±»åˆ«åˆ—è¡¨è¯·å‚è€ƒä»£ç ä¸­çš„ `_load_coco_classes()` æ–¹æ³•ã€‚

## ğŸ› æ•…éšœæ’æŸ¥

### æ¨¡å‹åŠ è½½å¤±è´¥

**é—®é¢˜**: `æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨: xxx.onnx`

**è§£å†³**: 
- ç¡®ä¿ä¸‰ä¸ªONNXæ¨¡å‹æ–‡ä»¶éƒ½åœ¨ `app/models/` ç›®å½•ä¸‹
- æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦æ­£ç¡®

### å†…å­˜ä¸è¶³

**é—®é¢˜**: æ¨ç†æ—¶å†…å­˜æº¢å‡º

**è§£å†³**:
- é™ä½å›¾ç‰‡åˆ†è¾¨ç‡ï¼ˆæ¨ç†å‰ä¼šè‡ªåŠ¨ç¼©æ”¾ï¼‰
- åªåŠ è½½éœ€è¦çš„æ¨¡å‹
- ä½¿ç”¨GPUåŠ é€Ÿ

### æ¨ç†é€Ÿåº¦æ…¢

**é—®é¢˜**: æ¨ç†è€—æ—¶è¿‡é•¿

**è§£å†³**:
- å®‰è£…GPUç‰ˆæœ¬çš„ONNX Runtime
- é™ä½confidence_thresholdä»¥å‡å°‘æ£€æµ‹ç»“æœ
- è€ƒè™‘ä½¿ç”¨æ›´å°çš„æ¨¡å‹

## ğŸ“ é›†æˆåˆ°FastAPI

å¦‚æœéœ€è¦å°†æœ¬åœ°æ¨ç†é›†æˆåˆ°ç°æœ‰çš„FastAPIæœåŠ¡ä¸­ï¼š

```python
from app.services.local_model_inference import local_model_inference
from app.services.model_client import model_client

async def classify_image_hybrid(image_bytes: bytes, use_local: bool = False):
    """æ··åˆåˆ†ç±»ç­–ç•¥"""
    if use_local:
        # ä½¿ç”¨æœ¬åœ°æ¨¡å‹æ¨ç†
        return await local_model_inference.classify_image(image_bytes)
    else:
        # ä½¿ç”¨å¤§æ¨¡å‹API
        return await model_client.classify_image(image_bytes)
```

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [ONNX Runtime å®˜æ–¹æ–‡æ¡£](https://onnxruntime.ai/)
- [YOLO8 å®˜æ–¹æ–‡æ¡£](https://docs.ultralytics.com/)
- [MobileNetV3 è®ºæ–‡](https://arxiv.org/abs/1905.02244)

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- æ—¥å¿—è¾“å‡ºï¼ˆä½¿ç”¨loguruè®°å½•è¯¦ç»†æ—¥å¿—ï¼‰
- æµ‹è¯•è„šæœ¬è¾“å‡º
- æ¨¡å‹é…ç½®å‚æ•°

---

**ç‰ˆæœ¬**: 1.0.0  
**æ›´æ–°æ—¥æœŸ**: 2025-10-11  
**ä½œè€…**: ImageClassifier Backend Team

