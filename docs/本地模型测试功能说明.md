# 本地模型测试功能说明 🤖

## 🎯 新增功能

已在管理后台添加**本地模型推理测试**功能，可以上传图片并查看三个模型的检测结果。

## 🆕 更新内容

### 1. Web界面（`web/index.html`）
- ✅ 新增"🤖 本地模型测试"标签页
- ✅ 支持上传图片
- ✅ 实时预览图片
- ✅ 显示推理结果

### 2. JavaScript（`web/app.js`）
- ✅ `previewLocalTestImage()` - 图片预览
- ✅ `testLocalModel()` - 调用本地模型API并展示结果

### 3. API接口（`app/api/local_classify.py`）
- ✅ 更新返回格式（移除categoryId和imageDimensions）
- ✅ 只返回原始检测结果

### 4. 推理服务（`app/services/local_model_inference.py`）
- ✅ 代码优化至 245行（减少62%）
- ✅ 严格模式初始化
- ✅ 移除所有冗余数据

## 🌐 使用方法

### 1. 访问管理后台

```
http://123.57.68.4:8000
```

### 2. 登录

- 用户名：`zywl`
- 密码：`zywl@123`

### 3. 点击"🤖 本地模型测试"标签页

### 4. 上传测试图片

- 点击"选择测试图片"按钮
- 选择任意图片（支持jpg、png等格式）
- 图片会自动预览

### 5. 开始推理

- 点击"🚀 开始推理"按钮
- 等待推理完成（通常 < 1秒）

### 6. 查看结果

显示三个模型的检测结果：

#### 🆔 ID卡检测结果
```
检测到的身份证数量
每个检测：类别名、置信度、边界框位置
```

#### 🔍 YOLO通用检测结果
```
检测到的物体数量（显示前10个）
每个检测：物体名称、置信度、边界框位置
```

#### 🧠 MobileNetV3分类结果
```
Top-5预测结果
每个预测：ImageNet类别、概率
```

#### 📝 原始JSON数据
```
可折叠展开查看完整的API返回数据
```

## 📊 返回数据格式

```json
{
  "success": true,
  "message": "模型推理完成",
  "details": {
    "idCardDetections": [
      {
        "classId": 0,
        "className": "id_card_front",
        "confidence": 0.95,
        "bbox": [100, 200, 300, 400]
      }
    ],
    "generalDetections": [
      {
        "classId": 0,
        "className": "person",
        "confidence": 0.92,
        "bbox": [50, 100, 200, 400]
      }
    ],
    "mobileNetV3Detections": {
      "predictions": [
        {
          "index": 123,
          "probability": 0.85,
          "class": "imagenet_class_123"
        }
      ],
      "topPrediction": {...},
      "confidence": 0.85
    }
  },
  "timestamp": "2025-10-11T12:00:00"
}
```

## 🎯 设计理念

### 服务器端职责
- ✅ **只做模型推理** - 返回原始检测结果
- ❌ 不做分类映射 - 由客户端负责
- ❌ 不返回图片尺寸 - 客户端已知原始尺寸

### 客户端职责
- ✅ 上传图片
- ✅ 获取检测结果
- ✅ 分类映射（MapObjectes2Category）
- ✅ 主角识别（identifyMainRole）

## 🧪 测试示例

### 测试人物照片
上传包含人物的照片，查看：
- YOLO检测到的人物数量
- 边界框位置
- MobileNetV3的预测结果

### 测试身份证
上传身份证图片，查看：
- ID卡模型是否检测到身份证
- 是正面还是反面
- 置信度

### 测试宠物照片
上传猫/狗照片，查看：
- YOLO是否检测到宠物
- MobileNetV3的预测

### 测试食物照片
上传美食照片，查看：
- YOLO检测到的食物类别
- MobileNetV3的Top-5预测

## 📈 性能指标

- **推理速度**: 通常 < 1秒
- **支持格式**: JPG, PNG, WebP等
- **并发支持**: 多用户同时测试

## 🔧 部署步骤

### 1. 安装依赖
```bash
pip install ultralytics onnxruntime numpy Pillow
```

### 2. 确保模型文件存在
```bash
ls -la app/models/
# 应该看到:
# - id_card_detection.onnx
# - yolov8s.onnx
# - mobilenetv3_rw_Opset17.onnx
```

### 3. 启动服务
```bash
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

### 4. 访问测试
```
http://localhost:8000/
→ 登录
→ 点击"🤖 本地模型测试"
→ 上传图片测试
```

## 🐛 故障排查

### 模型初始化失败

**现象**: 启动时报错 `FileNotFoundError: 模型文件不存在`

**解决**: 
```bash
# 检查模型文件
ls app/models/*.onnx

# 如果缺失，需要从客户端复制或重新下载
```

### 推理失败

**现象**: 上传图片后报错

**解决**:
- 检查图片格式是否支持
- 查看服务器日志获取详细错误
- 确认模型已正确加载

### 结果显示异常

**现象**: 检测结果为空或不正确

**解决**:
- 调整置信度阈值（在代码中）
- 查看原始JSON数据确认API返回
- 检查图片质量和内容

## 📚 相关文档

- 📖 [本地模型推理使用说明](./本地模型推理使用说明.md)
- 📖 [架构说明：职责分离](./架构说明_服务器与客户端职责分离.md)
- 📖 [最终代码优化总结](./最终代码优化总结.md)

## ✅ 功能清单

- [x] 新增本地模型测试标签页
- [x] 图片上传和预览
- [x] 调用本地模型API
- [x] 显示ID卡检测结果
- [x] 显示YOLO通用检测结果
- [x] 显示MobileNetV3分类结果
- [x] 显示原始JSON数据
- [x] 显示推理耗时
- [x] 错误处理和提示
- [x] 更新API返回格式

---

**功能完成日期**: 2025-10-11  
**支持的模型**: ID卡识别、YOLO8s、MobileNetV3  
**界面位置**: 管理后台 → 🤖 本地模型测试

