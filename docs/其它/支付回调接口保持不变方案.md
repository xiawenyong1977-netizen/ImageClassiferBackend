# 支付回调接口保持不变方案

## 📋 需求

- ✅ **支付回调URL保持不变**：`https://www.xintuxiangce.top/api/v1/payment/notify`
- ✅ **不修改微信支付商户平台配置**：避免风险提示
- ✅ **后端API部署到新服务器**：`www.aifuture.net.cn`

---

## 🎯 解决方案：反向代理

### 方案概述

在**旧服务器**上配置**Nginx反向代理**，将支付回调请求转发到新服务器，这样：
- ✅ URL保持不变：`https://www.xintuxiangce.top/api/v1/payment/notify`
- ✅ 实际处理在新服务器：`https://www.aifuture.net.cn/api/v1/payment/notify`
- ✅ 微信配置不需要修改
- ✅ 旧服务器只需要Nginx配置，不需要部署后端代码

---

## 🔧 实施步骤

### 步骤1：确认旧服务器架构

检查旧服务器当前如何服务 `/api/v1/payment/notify`：

**情况A**：旧服务器直接运行FastAPI服务
- 需要保留支付回调接口在旧服务器，或者
- 配置Nginx反向代理转发到新服务器

**情况B**：旧服务器已经使用Nginx反向代理
- 只需修改Nginx配置，将 `/api/v1/payment/notify` 转发到新服务器

**情况C**：旧服务器使用其他Web服务器
- 配置相应的反向代理规则

---

### 步骤2：配置Nginx反向代理（推荐方案）

#### 2.1 在旧服务器配置Nginx

假设旧服务器已经使用Nginx，配置如下：

```nginx
server {
    listen 443 ssl;
    server_name www.xintuxiangce.top;

    # SSL证书配置
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    # 支付回调接口 - 反向代理到新服务器
    location /api/v1/payment/notify {
        proxy_pass https://www.aifuture.net.cn;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 重要：支付回调是POST请求，需要传递请求体
        proxy_pass_request_body on;
        proxy_pass_request_headers on;
        
        # 超时设置（微信支付回调可能需要较长时间）
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # 不缓存
        proxy_cache off;
    }

    # 其他API接口 - 也转发到新服务器（可选）
    location /api/ {
        proxy_pass https://www.aifuture.net.cn;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CORS头（如果需要）
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-User-ID, X-WeChat-OpenID";
    }

    # 前端页面 - 保留在旧服务器
    location / {
        root /path/to/web;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 静态资源
    location /static/ {
        root /path/to/web;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

#### 2.2 如果旧服务器没有Nginx

**安装Nginx**：
```bash
# Ubuntu/Debian
apt update && apt install -y nginx

# CentOS/RHEL
yum install -y nginx
```

**配置Nginx**（同上）

**启动Nginx**：
```bash
systemctl start nginx
systemctl enable nginx
```

---

### 步骤3：新服务器配置

#### 3.1 后端API部署

在新服务器 `www.aifuture.net.cn` 部署完整的后端API服务，包括：
- ✅ 所有API接口
- ✅ 支付回调接口：`/api/v1/payment/notify`
- ✅ 数据库连接

#### 3.2 配置CORS

在新服务器的 `app/main.py` 中配置CORS，允许旧域名访问：

```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "https://www.xintuxiangce.top",  # 旧服务器前端
        "http://localhost:8000",  # 本地开发
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

#### 3.3 支付回调URL配置

在新服务器的 `.env` 文件中，支付回调URL仍然指向旧服务器（因为微信会调用旧服务器的URL）：

```env
# 支付回调URL（微信会调用这个URL，但会被Nginx转发到新服务器）
WECHAT_PAY_NOTIFY_URL=https://www.xintuxiangce.top/api/v1/payment/notify
```

**注意**：虽然实际处理在新服务器，但配置中仍然写旧服务器的URL，因为这是微信会调用的URL。

---

## 🔄 请求流程

### 支付回调流程

```
1. 用户完成支付
   ↓
2. 微信支付服务器调用回调URL
   POST https://www.xintuxiangce.top/api/v1/payment/notify
   ↓
3. 旧服务器Nginx接收请求
   ↓
4. Nginx反向代理转发到新服务器
   POST https://www.aifuture.net.cn/api/v1/payment/notify
   ↓
5. 新服务器处理支付回调
   - 验证签名
   - 查询订单
   - 更新订单状态
   - 更新用户额度
   - 返回XML响应
   ↓
6. 响应通过Nginx返回给微信
   ↓
7. 微信收到成功响应
```

---

## ✅ 方案优势

1. ✅ **微信配置不变**：回调URL保持不变，不需要修改微信支付商户平台
2. ✅ **无风险提示**：不触发微信的安全检查
3. ✅ **架构清晰**：旧服务器只负责反向代理，新服务器处理业务逻辑
4. ✅ **易于维护**：业务逻辑集中在新服务器
5. ✅ **可扩展**：未来可以轻松添加更多反向代理规则

---

## ⚠️ 注意事项

### 1. SSL证书

- ✅ 旧服务器需要有效的SSL证书（微信要求HTTPS）
- ✅ 新服务器也需要SSL证书（如果使用HTTPS反向代理）

### 2. 网络连接

- ✅ 确保旧服务器可以访问新服务器
- ✅ 如果新服务器在内网，需要配置内网地址或VPN

### 3. 超时设置

- ✅ 支付回调处理可能需要较长时间（数据库操作）
- ✅ Nginx需要配置足够的超时时间

### 4. 日志记录

- ✅ 在Nginx中记录转发日志，便于排查问题
- ✅ 在新服务器记录支付回调处理日志

### 5. 错误处理

- ✅ 如果新服务器不可用，Nginx应该返回错误响应
- ✅ 可以考虑配置备用服务器或错误页面

---

## 🔍 测试验证

### 测试步骤

1. **配置Nginx反向代理**
   ```bash
   # 测试Nginx配置
   nginx -t
   
   # 重载Nginx配置
   nginx -s reload
   ```

2. **测试反向代理**
   ```bash
   # 从旧服务器测试转发
   curl -X POST https://www.xintuxiangce.top/api/v1/payment/notify \
     -H "Content-Type: application/xml" \
     -d '<xml>...</xml>'
   ```

3. **检查新服务器日志**
   ```bash
   # 查看新服务器是否收到请求
   tail -f /var/log/image-classifier/app.log
   ```

4. **测试支付流程**
   - 创建测试订单
   - 完成支付
   - 检查回调是否正常
   - 验证订单状态是否更新

---

## 📝 配置检查清单

### 旧服务器（www.xintuxiangce.top）
- [ ] Nginx已安装并运行
- [ ] Nginx配置已更新（反向代理规则）
- [ ] SSL证书有效
- [ ] 可以访问新服务器
- [ ] 测试反向代理正常工作

### 新服务器（www.aifuture.net.cn）
- [ ] 后端API已部署
- [ ] 支付回调接口正常
- [ ] 数据库连接正常
- [ ] CORS配置正确
- [ ] SSL证书有效
- [ ] 日志记录正常

### 微信配置
- [ ] 支付回调URL保持不变：`https://www.xintuxiangce.top/api/v1/payment/notify`
- [ ] 不需要修改微信支付商户平台配置
- [ ] 测试支付回调正常

---

## 🚀 实施建议

### 阶段1：准备（1天）
1. 在新服务器部署后端API
2. 测试新服务器API是否正常
3. 配置新服务器CORS

### 阶段2：配置反向代理（半天）
1. 在旧服务器配置Nginx反向代理
2. 测试反向代理是否正常
3. 验证请求转发是否正确

### 阶段3：测试验证（1天）
1. 测试支付回调流程
2. 验证订单状态更新
3. 检查日志记录
4. 全面功能测试

### 阶段4：正式切换（半天）
1. 修改前端API调用路径（其他接口）
2. 监控运行状态
3. 处理异常情况

---

## 🔄 其他接口处理

### 微信授权接口

微信授权接口 `/api/v1/auth/wechat` 也可以使用同样的反向代理方式：

```nginx
# 授权接口 - 反向代理到新服务器
location /api/v1/auth/wechat {
    proxy_pass https://www.aifuture.net.cn;
    # ... 其他配置同上
}
```

### 所有API接口

如果希望所有API接口都通过旧服务器转发（保持URL不变），可以配置：

```nginx
# 所有API接口 - 反向代理到新服务器
location /api/ {
    proxy_pass https://www.aifuture.net.cn;
    # ... 其他配置
}
```

这样前端代码中的API调用路径也可以保持不变！

---

## 📊 架构图

```
┌─────────────────────────────────┐
│  微信支付服务器                    │
└──────────────┬──────────────────┘
               │ POST /api/v1/payment/notify
               │ https://www.xintuxiangce.top
               ↓
┌─────────────────────────────────┐
│  旧服务器                        │
│  www.xintuxiangce.top           │
│  ┌──────────────────────────┐  │
│  │  Nginx反向代理             │  │
│  │  /api/v1/payment/notify  │  │
│  └──────────┬───────────────┘  │
│             │ 转发请求          │
└─────────────┼──────────────────┘
              │
              ↓
┌─────────────────────────────────┐
│  新服务器                        │
│  www.aifuture.net.cn             │
│  ┌──────────────────────────┐  │
│  │  FastAPI后端服务          │  │
│  │  /api/v1/payment/notify  │  │
│  │  - 处理支付回调           │  │
│  │  - 更新数据库             │  │
│  └──────────────────────────┘  │
└─────────────────────────────────┘
```

---

## ✅ 总结

**支付回调接口可以保持不变！**

通过Nginx反向代理，可以实现：
- ✅ URL保持不变：`https://www.xintuxiangce.top/api/v1/payment/notify`
- ✅ 不修改微信配置：避免风险提示
- ✅ 实际处理在新服务器：业务逻辑集中管理
- ✅ 架构清晰：职责分离

这是一个**零风险、零配置变更**的完美方案！

---

**文档版本**: v1.0  
**创建日期**: 2025-01-XX  
**维护者**: ImageClassifier Team

