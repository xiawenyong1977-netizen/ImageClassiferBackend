# 前后端分离部署方案评估

## 📋 方案概述

### 目标架构
- **后端API服务**：部署到新服务器（app服务器），使用新域名 `www.aifuture.net.cn`
- **前端Web服务**：保留在旧服务器，使用旧域名 `www.xintuxiangce.top`
- **微信公众号和授权接口**：保留在旧服务器，保持旧域名和链接不变

---

## ✅ 方案可行性分析

### 1. 技术可行性：✅ **完全可行**

#### 1.1 前后端分离架构
- ✅ FastAPI支持CORS跨域请求
- ✅ 前端可以通过fetch/axios调用不同域名的API
- ✅ 这是标准的微服务架构模式

#### 1.2 域名配置
- ✅ 新域名 `www.aifuture.net.cn` 可以独立部署后端API
- ✅ 旧域名 `www.xintuxiangce.top` 继续服务前端页面
- ✅ 两个域名可以独立配置SSL证书

---

## 🔍 详细技术分析

### 2. 跨域问题（CORS）

#### 2.1 当前CORS配置
```python
# app/main.py
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # 当前允许所有域名
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

#### 2.2 需要修改的配置
```python
# 生产环境应该配置具体的域名
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "https://www.xintuxiangce.top",  # 旧服务器前端
        "http://localhost:8000",  # 本地开发
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

**结论**：✅ CORS配置简单，只需更新允许的源域名列表

---

### 3. 微信授权回调URL

#### 3.1 当前配置（硬编码）
```python
# app/api/auth.py
member_url = f"{auth_base_url}?appid={appid}&redirect_uri={quote('https://www.xintuxiangce.top/member.html')}..."
credits_url = f"{auth_base_url}?appid={appid}&redirect_uri={quote('https://www.xintuxiangce.top/credits.html')}..."
```

#### 3.2 方案分析
- ✅ **授权接口可以保留在旧服务器**：微信授权回调URL指向旧服务器页面
- ✅ **授权接口逻辑可以迁移**：授权接口（`/api/v1/auth/wechat`）可以部署在新服务器
- ⚠️ **需要修改**：授权接口返回的redirect_uri需要指向旧服务器的前端页面

**结论**：✅ 可行，但需要确保授权接口在新服务器上，回调URL指向旧服务器

---

### 4. 微信支付回调URL

#### 4.1 当前配置
```python
# env.example
WECHAT_PAY_NOTIFY_URL=https://www.xintuxiangce.top/api/v1/payment/notify
```

#### 4.2 方案分析
- ✅ **支付回调接口需要部署在新服务器**：因为支付回调需要访问数据库
- ✅ **需要修改回调URL**：改为新域名 `https://www.aifuture.net.cn/api/v1/payment/notify`
- ⚠️ **需要在微信支付商户平台更新回调URL**

**结论**：✅ 可行，需要更新微信支付商户平台的回调URL配置

---

### 5. 前端API调用路径修改

#### 5.1 需要修改的文件

**微信公众号页面**（旧服务器）：
- `web/member.html` - 当前：`https://www.xintuxiangce.top/api/v1`
- `web/credits.html` - 当前：`https://www.xintuxiangce.top/api/v1`
- `web/credits_info.html` - 当前：`https://www.xintuxiangce.top/api/v1`

**需要改为**：`https://www.aifuture.net.cn/api/v1`

**管理后台页面**（旧服务器）：
- `web/app.js` - 当前：`http://123.57.68.4:8000`（可配置）
- `web/index.html` - 配置输入框

**需要改为**：`https://www.aifuture.net.cn`（或保持可配置）

**结论**：✅ 需要修改前端代码中的API基础URL

---

## 📊 架构对比

### 当前架构（单服务器）
```
www.xintuxiangce.top
├── /api/v1/*          # RESTful API
├── /                  # 管理后台
├── /member.html       # 微信公众号页面
└── /static/*          # 静态资源
```

### 目标架构（双服务器）
```
旧服务器: www.xintuxiangce.top
├── /                  # 管理后台
├── /member.html       # 微信公众号页面
├── /credits.html      # 微信公众号页面
├── /credits_info.html # 微信公众号页面
└── /static/*          # 静态资源

新服务器: www.aifuture.net.cn
└── /api/v1/*          # RESTful API（所有后端接口）
```

---

## 🔧 实施步骤

### 步骤1：新服务器部署后端API

1. **部署后端代码**到新服务器
2. **配置新域名** `www.aifuture.net.cn`
3. **配置SSL证书**（HTTPS）
4. **配置CORS**，允许旧域名访问
5. **测试API接口**是否正常

### 步骤2：修改前端API调用路径

1. **修改微信公众号页面**的API_BASE_URL
   - `web/member.html`
   - `web/credits.html`
   - `web/credits_info.html`
   
2. **修改管理后台**的API配置
   - `web/app.js`
   - `web/index.html`

### 步骤3：更新微信授权接口

1. **确保授权接口在新服务器**：`/api/v1/auth/wechat`
2. **授权回调URL保持不变**：指向旧服务器的前端页面
3. **测试授权流程**

### 步骤4：更新微信支付配置

1. **修改支付回调URL**：`https://www.aifuture.net.cn/api/v1/payment/notify`
2. **在微信支付商户平台更新回调URL**
3. **测试支付流程**

### 步骤5：旧服务器配置

1. **移除后端API服务**（可选，如果不再需要）
2. **保留前端页面服务**
3. **配置Nginx反向代理**（如果需要）

---

## ⚠️ 潜在问题和解决方案

### 问题1：跨域Cookie和Session

**问题**：如果使用Cookie或Session进行认证，跨域会有问题

**解决方案**：
- ✅ 使用JWT Token认证（当前已使用）
- ✅ Token存储在localStorage，通过Header传递
- ✅ 不需要Cookie，跨域无问题

### 问题2：微信授权流程

**问题**：授权接口在新服务器，但回调URL指向旧服务器

**解决方案**：
- ✅ 授权接口在新服务器：`https://www.aifuture.net.cn/api/v1/auth/wechat`
- ✅ 回调URL指向旧服务器：`https://www.xintuxiangce.top/member.html`
- ✅ 前端页面从旧服务器加载，然后调用新服务器的授权接口
- ✅ 授权成功后，前端页面跳转到旧服务器的其他页面

**流程图**：
```
1. 用户访问: https://www.xintuxiangce.top/member.html
2. 页面加载，检测到需要授权
3. 跳转到: https://www.aifuture.net.cn/api/v1/auth/wechat?code=xxx
4. 新服务器处理授权，返回openid
5. 前端页面使用openid调用新服务器API
6. 页面跳转: https://www.xintuxiangce.top/member.html?openid=xxx
```

### 问题3：微信支付回调

**问题**：支付回调URL需要更新

**解决方案**：
- ✅ 修改 `.env` 配置：`WECHAT_PAY_NOTIFY_URL=https://www.aifuture.net.cn/api/v1/payment/notify`
- ✅ 在微信支付商户平台更新回调URL
- ✅ 确保新服务器可以接收微信支付的回调请求

### 问题4：API文档访问

**问题**：API文档（`/docs`）现在在新服务器

**解决方案**：
- ✅ 访问：`https://www.aifuture.net.cn/docs`
- ✅ 或者在新服务器配置重定向

### 问题5：静态资源路径

**问题**：前端页面中的静态资源路径

**解决方案**：
- ✅ 静态资源保留在旧服务器
- ✅ 前端页面中的静态资源路径使用相对路径或旧域名

---

## 📝 需要修改的文件清单

### 后端文件（新服务器）
- [ ] `app/main.py` - 更新CORS配置，允许旧域名
- [ ] `app/api/auth.py` - 确保授权接口正常工作（回调URL指向旧服务器）
- [ ] `.env` - 更新支付回调URL为 `https://www.aifuture.net.cn/api/v1/payment/notify`

### 前端文件（旧服务器）
- [ ] `web/member.html` - 修改 `API_BASE_URL` 为 `https://www.aifuture.net.cn/api/v1`
- [ ] `web/credits.html` - 修改 `API_BASE_URL` 为 `https://www.aifuture.net.cn/api/v1`
- [ ] `web/credits_info.html` - 修改 `API_BASE_URL` 为 `https://www.aifuture.net.cn/api/v1`
- [ ] `web/app.js` - 修改默认 `apiUrl` 为 `https://www.aifuture.net.cn`
- [ ] `web/index.html` - 更新API配置输入框的默认值

---

## ✅ 方案可行性结论

### 总体评估：✅ **完全可行**

#### 优势
1. ✅ **架构清晰**：前后端完全分离，职责明确
2. ✅ **易于扩展**：后端可以独立扩展，不影响前端
3. ✅ **域名独立**：新域名专门用于API服务
4. ✅ **不影响现有功能**：微信公众号页面和授权流程保持不变
5. ✅ **技术成熟**：使用标准的CORS跨域方案

#### 注意事项
1. ⚠️ **需要修改前端代码**：更新API调用路径
2. ⚠️ **需要配置CORS**：允许旧域名访问新服务器API
3. ⚠️ **需要更新微信支付回调URL**：在微信支付商户平台配置
4. ⚠️ **需要测试授权流程**：确保跨域授权正常工作

#### 风险评估
- **技术风险**：低（标准的前后端分离架构）
- **业务风险**：低（不影响现有功能）
- **实施风险**：中（需要修改多处代码和配置）

---

## 🚀 实施建议

### 阶段1：准备阶段（1-2天）
1. 在新服务器部署后端API
2. 配置新域名和SSL证书
3. 配置CORS，允许旧域名访问
4. 测试所有API接口

### 阶段2：代码修改（1天）
1. 修改前端API调用路径
2. 更新配置文件
3. 本地测试

### 阶段3：灰度发布（1-2天）
1. 先修改一个页面测试（如credits_info.html）
2. 验证功能正常
3. 逐步修改其他页面

### 阶段4：正式切换（1天）
1. 修改所有前端页面
2. 更新微信支付回调URL
3. 全面测试
4. 监控运行状态

---

## 📋 检查清单

### 新服务器（www.aifuture.net.cn）
- [ ] 后端代码已部署
- [ ] 域名已配置并解析
- [ ] SSL证书已配置（HTTPS）
- [ ] CORS已配置，允许旧域名访问
- [ ] 所有API接口测试通过
- [ ] 数据库连接正常
- [ ] 微信授权接口测试通过
- [ ] 支付回调接口测试通过

### 旧服务器（www.xintuxiangce.top）
- [ ] 前端页面API路径已更新
- [ ] 静态资源路径正确
- [ ] 页面功能测试通过
- [ ] 授权流程测试通过
- [ ] 支付流程测试通过

### 微信配置
- [ ] 微信授权回调URL保持不变（指向旧服务器）
- [ ] 微信支付回调URL已更新（指向新服务器）
- [ ] 微信支付商户平台配置已更新

### 测试验证
- [ ] 管理后台功能正常
- [ ] 微信公众号页面功能正常
- [ ] 微信授权流程正常
- [ ] 微信支付流程正常
- [ ] API接口调用正常
- [ ] 跨域请求正常

---

## 📞 技术支持

如遇到问题，请检查：
1. CORS配置是否正确
2. API路径是否正确
3. 网络连接是否正常
4. SSL证书是否有效
5. 微信配置是否正确

---

**文档版本**: v1.0  
**创建日期**: 2025-01-XX  
**维护者**: ImageClassifier Team

