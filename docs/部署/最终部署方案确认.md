# 最终部署方案确认

## ✅ 方案确认

### 部署架构

```
┌─────────────────────────────────────┐
│  旧服务器 (Web服务器)                │
│  www.xintuxiangce.top               │
│  ┌──────────────────────────────┐   │
│  │  前端页面                     │   │
│  │  - 管理后台 (index.html)      │   │
│  │  - 公众号页面 (member.html等)  │   │
│  └──────────────────────────────┘   │
│  ┌──────────────────────────────┐   │
│  │  Nginx反向代理                │   │
│  │  /api/* → 新服务器            │   │
│  └──────────────────────────────┘   │
└─────────────────────────────────────┘
              │
              │ 反向代理转发
              ↓
┌─────────────────────────────────────┐
│  新服务器 (App服务器)                │
│  www.aifuture.net.cn                │
│  ┌──────────────────────────────┐   │
│  │  后端API服务                  │   │
│  │  - 所有RESTful接口            │   │
│  │  - 支付回调接口               │   │
│  │  - 微信授权接口               │   │
│  └──────────────────────────────┘   │
└─────────────────────────────────────┘
```

---

## ✅ 确认事项

### 1. 前端页面（旧服务器）
- ✅ **管理后台**：`index.html`, `login.html`, `app.js`
- ✅ **公众号页面**：`member.html`, `credits.html`, `credits_info.html`
- ✅ **静态资源**：图片、JSON文件等
- ✅ **部署位置**：旧服务器（www.xintuxiangce.top）

### 2. 后端API（新服务器）
- ✅ **所有RESTful接口**：`/api/v1/*`
- ✅ **支付回调接口**：`/api/v1/payment/notify`
- ✅ **微信授权接口**：`/api/v1/auth/wechat`
- ✅ **部署位置**：新服务器（www.aifuture.net.cn）

### 3. 外部配置（不需要修改）
- ✅ **微信支付回调URL**：保持 `https://www.xintuxiangce.top/api/v1/payment/notify`
- ✅ **微信授权回调URL**：保持 `https://www.xintuxiangce.top/member.html` 等
- ✅ **微信支付商户平台**：不需要修改任何配置
- ✅ **微信公众号配置**：不需要修改任何配置

---

## 🔧 需要做的事情

### 旧服务器（Web服务器）

#### 1. 部署前端页面
- [ ] 确保前端页面文件在旧服务器
- [ ] 配置Web服务器（Nginx/Apache）服务静态文件

#### 2. 配置Nginx反向代理
- [ ] 安装/配置Nginx
- [ ] 配置 `/api/*` 反向代理到新服务器
- [ ] 配置SSL证书
- [ ] 测试反向代理是否正常

#### 3. 前端代码修改（可选）
- [ ] 如果使用反向代理，前端API路径可以保持不变
- [ ] 或者修改前端API路径为新服务器域名

### 新服务器（App服务器）

#### 1. 部署后端API
- [ ] 部署完整的后端代码（app目录）
- [ ] 配置环境变量（.env文件）
- [ ] 配置数据库连接
- [ ] 启动FastAPI服务

#### 2. 配置域名和SSL
- [ ] 配置域名 `www.aifuture.net.cn`
- [ ] 配置SSL证书（HTTPS）
- [ ] 测试API接口可访问

#### 3. 配置CORS
- [ ] 允许旧域名访问：`https://www.xintuxiangce.top`
- [ ] 测试跨域请求是否正常

---

## 📋 详细配置清单

### 旧服务器 Nginx 配置示例

```nginx
server {
    listen 443 ssl;
    server_name www.xintuxiangce.top;

    # SSL证书
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    # API接口 - 反向代理到新服务器
    location /api/ {
        proxy_pass https://www.aifuture.net.cn;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 重要：传递请求体和头信息
        proxy_pass_request_body on;
        proxy_pass_request_headers on;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 前端页面 - 静态文件服务
    location / {
        root /path/to/web;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 静态资源
    location /static/ {
        root /path/to/web;
        expires 30d;
    }
}
```

### 新服务器 CORS 配置

```python
# app/main.py
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "https://www.xintuxiangce.top",  # 旧服务器前端
        "http://localhost:8000",  # 本地开发
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### 新服务器环境变量配置

```env
# .env
# 支付回调URL（微信会调用旧服务器的URL，通过Nginx转发）
WECHAT_PAY_NOTIFY_URL=https://www.xintuxiangce.top/api/v1/payment/notify

# 其他配置...
```

---

## 🔄 请求流程

### 前端页面访问
```
用户访问: https://www.xintuxiangce.top/
  ↓
旧服务器直接返回前端页面
```

### API接口调用
```
前端页面调用API: https://www.xintuxiangce.top/api/v1/classify
  ↓
旧服务器Nginx接收请求
  ↓
Nginx反向代理转发: https://www.aifuture.net.cn/api/v1/classify
  ↓
新服务器处理请求并返回
  ↓
响应通过Nginx返回给前端
```

### 支付回调
```
微信支付服务器: POST https://www.xintuxiangce.top/api/v1/payment/notify
  ↓
旧服务器Nginx接收请求
  ↓
Nginx反向代理转发: POST https://www.aifuture.net.cn/api/v1/payment/notify
  ↓
新服务器处理支付回调
  ↓
响应通过Nginx返回给微信
```

---

## ✅ 优势总结

1. ✅ **外部配置零修改**：微信配置完全不需要改动
2. ✅ **无风险提示**：不触发微信的安全检查
3. ✅ **架构清晰**：前后端完全分离
4. ✅ **易于维护**：业务逻辑集中在新服务器
5. ✅ **可扩展**：未来可以轻松扩展

---

## 📝 实施检查清单

### 旧服务器
- [ ] 前端页面已部署
- [ ] Nginx已安装并配置
- [ ] 反向代理规则已配置
- [ ] SSL证书有效
- [ ] 可以访问新服务器
- [ ] 测试反向代理正常

### 新服务器
- [ ] 后端API已部署
- [ ] 域名已配置
- [ ] SSL证书已配置
- [ ] CORS已配置
- [ ] 数据库连接正常
- [ ] 所有API接口测试通过

### 测试验证
- [ ] 前端页面可以正常访问
- [ ] API接口调用正常
- [ ] 支付回调流程正常
- [ ] 微信授权流程正常
- [ ] 跨域请求正常

---

## 🎯 总结

**确认：外部配置完全不需要修改！**

- ✅ 微信支付回调URL保持不变
- ✅ 微信授权回调URL保持不变
- ✅ 微信支付商户平台不需要修改
- ✅ 微信公众号配置不需要修改

只需要：
1. 在旧服务器配置Nginx反向代理
2. 在新服务器部署后端API
3. 配置CORS允许跨域访问

**完美方案！** 🎉

---

**文档版本**: v1.0  
**创建日期**: 2025-01-XX  
**维护者**: ImageClassifier Team

