# å¾®ä¿¡æ”¯ä»˜æ¥å£è¯´æ˜

## ğŸ“‹ å·²å®ç°çš„æ¥å£

### 1. åˆ›å»ºæ”¯ä»˜è®¢å•

**æ¥å£**ï¼š`POST /api/v1/payment/create-order`

**è¯·æ±‚å¤´**ï¼š
- `X-WeChat-OpenID`ï¼šå¾®ä¿¡ç”¨æˆ·openidï¼ˆå¿…å¡«ï¼‰

**è¯·æ±‚ä½“**ï¼š
```json
{
  "order_type": "member",      // è®¢å•ç±»å‹ï¼šmemberï¼ˆä¼šå‘˜ï¼‰æˆ– creditsï¼ˆé¢åº¦ï¼‰
  "credits_amount": 10         // è´­ä¹°é¢åº¦æ•°é‡ï¼ˆä»…è®¢å•ç±»å‹ä¸ºcreditsæ—¶å¿…å¡«ï¼‰
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "order_no": "20251028123456789",
  "amount": 29.90,
  "payment_params": {
    "appId": "wx519901dac7705111",
    "timeStamp": "1698480000",
    "nonceStr": "abc123",
    "package": "preify_id=wx123456",
    "signType": "MD5",
    "paySign": "ABCDEF123456"
  },
  "message": "è®¢å•åˆ›å»ºæˆåŠŸï¼Œæ­£åœ¨è°ƒèµ·æ”¯ä»˜..."
}
```

**è®¢å•ç±»å‹è¯´æ˜**ï¼š
- `member`ï¼šå¼€é€šä¼šå‘˜ï¼Œå›ºå®šä»·æ ¼ 29.90å…ƒï¼Œå¼€é€š30å¤©ä¼šå‘˜
- `credits`ï¼šè´­ä¹°é¢åº¦ï¼Œæ”¯æŒ10/20/50/100å¼ ï¼Œä»·æ ¼åˆ†åˆ«ä¸º9.9/18.0/39.0/69.0å…ƒ

### 2. æ”¯ä»˜å›è°ƒæ¥å£ï¼ˆå¾®ä¿¡è°ƒç”¨ï¼‰

**æ¥å£**ï¼š`POST /api/v1/payment/notify`

å¾®ä¿¡æ”¯ä»˜æˆåŠŸåè‡ªåŠ¨è°ƒç”¨æ­¤æ¥å£ï¼Œç”¨äºï¼š
- éªŒè¯æ”¯ä»˜ç­¾å
- æ›´æ–°è®¢å•çŠ¶æ€ä¸º"paid"
- å‘æ”¾ä¼šå‘˜æˆ–é¢åº¦

### 3. æŸ¥è¯¢è®¢å•åˆ—è¡¨

**æ¥å£**ï¼š`GET /api/v1/payment/orders`

**è¯·æ±‚å¤´**ï¼š
- `X-WeChat-OpenID`ï¼šå¾®ä¿¡ç”¨æˆ·openid

**å“åº”**ï¼š
```json
{
  "success": true,
  "orders": [
    {
      "order_no": "20251028123456789",
      "order_type": "member",
      "amount": 29.90,
      "status": "paid",
      "created_at": "2025-10-28 20:00:00",
      "paid_at": "2025-10-28 20:01:00"
    }
  ]
}
```

### 4. æŸ¥è¯¢å•ä¸ªè®¢å•

**æ¥å£**ï¼š`GET /api/v1/payment/order/{order_no}`

**è¯·æ±‚å¤´**ï¼š
- `X-WeChat-OpenID`ï¼šå¾®ä¿¡ç”¨æˆ·openid

**å“åº”**ï¼š
```json
{
  "success": true,
  "order": {
    "order_no": "20251028123456789",
    "order_type": "member",
    "amount": 29.90,
    "status": "paid",
    "created_at": "2025-10-28 20:00:00",
    "paid_at": "2025-10-28 20:01:00"
  }
}
```

## ğŸ¯ æ”¯ä»˜æµç¨‹

### ä¼šå‘˜å¼€é€šæµç¨‹

1. **ç”¨æˆ·ç‚¹å‡»èœå•"å¼€é€šä¼šå‘˜"**
2. **å‰ç«¯è°ƒç”¨åˆ›å»ºè®¢å•æ¥å£**ï¼š
   ```javascript
   fetch('/api/v1/payment/create-order', {
     method: 'POST',
     headers: {
       'X-WeChat-OpenID': openid,
       'Content-Type': 'application/json'
     },
     body: JSON.stringify({
       order_type: 'member'
     })
   })
   ```
3. **è·å–payment_paramsï¼Œè°ƒèµ·å¾®ä¿¡æ”¯ä»˜**ï¼š
   ```javascript
   WeixinJSBridge.invoke('getBrandWCPayRequest', {
     ...payment_params
   }, function(res) {
     if(res.err_msg === "get_brand_wcpay_request:ok") {
       // æ”¯ä»˜æˆåŠŸ
     }
   });
   ```
4. **å¾®ä¿¡å®Œæˆæ”¯ä»˜åï¼Œè°ƒç”¨æˆ‘ä»¬çš„å›è°ƒæ¥å£**
5. **åç«¯æ›´æ–°è®¢å•çŠ¶æ€ï¼Œå‘æ”¾ä¼šå‘˜**

### è´­ä¹°é¢åº¦æµç¨‹

1. **ç”¨æˆ·ç‚¹å‡»èœå•"è´­ä¹°é¢åº¦"**
2. **å‰ç«¯æ˜¾ç¤ºé¢åº¦é€‰æ‹©ï¼ˆ10/20/50/100å¼ ï¼‰**
3. **ç”¨æˆ·é€‰æ‹©åè°ƒç”¨åˆ›å»ºè®¢å•æ¥å£**ï¼š
   ```javascript
   fetch('/api/v1/payment/create-order', {
     method: 'POST',
     headers: {
       'X-WeChat-OpenID': openid,
       'Content-Type': 'application/json'
     },
     body: JSON.stringify({
       order_type: 'credits',
       credits_amount: 10
     })
   })
   ```
4. **åç»­æµç¨‹åŒä¼šå‘˜å¼€é€š**

## ğŸ”§ å‰ç«¯å®ç°è¦ç‚¹

### âš ï¸ é‡è¦æç¤º

å‰ç«¯æ”¯ä»˜åŠŸèƒ½éœ€è¦åœ¨å‰ç«¯é¡¹ç›®ä¸­å®ç°ã€‚æœ¬åç«¯é¡¹ç›®ä»…æä¾›ç®¡ç†åå°åŠŸèƒ½ã€‚

å‰ç«¯é¡¹ç›®éœ€è¦å®ç°ä»¥ä¸‹å†…å®¹ï¼š

### 1. è·å–OpenID

ç”¨æˆ·é€šè¿‡æ‰«ç å…³æ³¨å…¬ä¼—å·åï¼Œå‰ç«¯éœ€è¦ä»localStorageè¯»å–`wechat_openid`ï¼š

```javascript
const openid = localStorage.getItem('wechat_openid');
```

### 2. è°ƒèµ·æ”¯ä»˜

åœ¨å¾®ä¿¡å…¬ä¼—å·ç½‘é¡µä¸­è°ƒç”¨å¾®ä¿¡æ”¯ä»˜ï¼š

```javascript
function callWeChatPay(paymentParams) {
  if (typeof WeixinJSBridge == "undefined") {
    if (document.addEventListener) {
      document.addEventListener('WeixinJSBridgeReady', function() {
        invokeWeChatPay(paymentParams);
      }, false);
    } else if (document.attachEvent) {
      document.attachEvent('WeixinJSBridgeReady', function() {
        invokeWeChatPay(paymentParams);
      });
    }
  } else {
    invokeWeChatPay(paymentParams);
  }
}

function invokeWeChatPay(paymentParams) {
  WeixinJSBridge.invoke('getBrandWCPayRequest', paymentParams, function(res) {
    if (res.err_msg === "get_brand_wcpay_request:ok") {
      // æ”¯ä»˜æˆåŠŸ
      alert('æ”¯ä»˜æˆåŠŸï¼');
      // è·³è½¬åˆ°ç»“æœé¡µé¢æˆ–åˆ·æ–°é¢åº¦
    } else {
      // æ”¯ä»˜å¤±è´¥
      alert('æ”¯ä»˜å¤±è´¥ï¼š' + res.err_msg);
    }
  });
}
```

### 3. è§£æURLå‚æ•°

å½“ç”¨æˆ·é€šè¿‡èœå•è¿›å…¥æ—¶ï¼Œéœ€è¦è§£æURLä¸­çš„`action`å‚æ•°ï¼š

```javascript
function parseUrlParams() {
  const params = new URLSearchParams(window.location.search);
  const action = params.get('action');
  
  switch(action) {
    case 'member':
      showMemberPage();
      break;
    case 'credits':
      showCreditsPage();
      break;
    case 'credits_info':
      showCreditsInfoPage();
      break;
    default:
      showDefaultPage();
  }
}
```

### 4. å®Œæ•´çš„æ”¯ä»˜æµç¨‹ç¤ºä¾‹

```javascript
// åˆ›å»ºè®¢å•å¹¶è°ƒèµ·æ”¯ä»˜
async function createMemberOrder() {
  const openid = localStorage.getItem('wechat_openid');
  
  const response = await fetch('https://www.xintuxiangce.top/api/v1/payment/create-order', {
    method: 'POST',
    headers: {
      'X-WeChat-OpenID': openid,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ order_type: 'member' })
  });
  
  const result = await response.json();
  
  if (result.success && result.payment_params) {
    // è°ƒèµ·å¾®ä¿¡æ”¯ä»˜
    callWeChatPay(result.payment_params);
  } else {
    alert('åˆ›å»ºè®¢å•å¤±è´¥');
  }
}
```

### 5. å‰ç«¯é¡¹ç›®é…ç½®

å‰ç«¯é¡¹ç›®éœ€è¦é…ç½®ï¼š
- **APIåŸŸå**ï¼š`https://www.xintuxiangce.top/api/v1`
- **å¾®ä¿¡å…¬ä¼—å·æˆæƒåŸŸå**ï¼šåœ¨å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½®`www.xintuxiangce.top`
- **JSAPIæ”¯ä»˜æˆæƒç›®å½•**ï¼šåœ¨å¾®ä¿¡æ”¯ä»˜å•†æˆ·å¹³å°é…ç½®`https://www.xintuxiangce.top/api/v1/payment/notify`

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¿…é¡»ä½¿ç”¨HTTPS**ï¼šå¾®ä¿¡æ”¯ä»˜è¦æ±‚æ‰€æœ‰æ¥å£ä½¿ç”¨HTTPS
2. **åŸŸåæˆæƒ**ï¼šéœ€è¦åœ¨å¾®ä¿¡æ”¯ä»˜å•†æˆ·å¹³å°é…ç½®æˆæƒåŸŸå
3. **æ”¯ä»˜å›è°ƒ**ï¼šå¾®ä¿¡ä¼šå¤šæ¬¡é‡è¯•æ”¯ä»˜å›è°ƒï¼Œéœ€è¦ä¿è¯æ¥å£å¹‚ç­‰æ€§
4. **è®¢å•è¶…æ—¶**ï¼šè®¢å•30åˆ†é’Ÿæœªæ”¯ä»˜ä¼šè‡ªåŠ¨è¿‡æœŸ
5. **ç­¾åéªŒè¯**ï¼šæ‰€æœ‰æ”¯ä»˜ç›¸å…³çš„è¯·æ±‚éƒ½å¿…é¡»éªŒè¯ç­¾å

## ğŸ§ª æµ‹è¯•

### æµ‹è¯•ä¼šå‘˜å¼€é€š

```bash
curl -X POST http://admin.xintuxiangce.top:8000/api/v1/payment/create-order \
  -H "X-WeChat-OpenID: okbfi1wlkjqhkaHYIYKUxwJe66P8" \
  -H "Content-Type: application/json" \
  -d '{"order_type": "member"}'
```

### æµ‹è¯•è´­ä¹°é¢åº¦

```bash
curl -X POST http://admin.xintuxiangce.top:8000/api/v1/payment/create-order \
  -H "X-WeChat-OpenID: okbfi1wlkjqhkaHYIYKUxwJe66P8" \
  -H "Content-Type: application/json" \
  -d '{"order_type": "credits", "credits_amount": 10}'
```

## ğŸ“ æ•°æ®åº“è¡¨ç»“æ„

### payment_ordersï¼ˆè®¢å•è¡¨ï¼‰
- `order_no`ï¼šè®¢å•å·ï¼ˆä¸»é”®ï¼‰
- `openid`ï¼šå¾®ä¿¡ç”¨æˆ·openid
- `order_type`ï¼šè®¢å•ç±»å‹ï¼ˆmember/creditsï¼‰
- `amount`ï¼šè®¢å•é‡‘é¢
- `credits_amount`ï¼šè´­ä¹°çš„é¢åº¦æ•°é‡
- `status`ï¼šè®¢å•çŠ¶æ€ï¼ˆpending/paid/cancelledï¼‰
- `created_at`ï¼šåˆ›å»ºæ—¶é—´
- `paid_at`ï¼šæ”¯ä»˜æ—¶é—´

### membership_recordsï¼ˆä¼šå‘˜è®°å½•è¡¨ï¼‰
- `id`ï¼šä¸»é”®
- `openid`ï¼šå¾®ä¿¡ç”¨æˆ·openid
- `start_date`ï¼šä¼šå‘˜å¼€å§‹æ—¥æœŸ
- `end_date`ï¼šä¼šå‘˜ç»“æŸæ—¥æœŸ
- `created_at`ï¼šåˆ›å»ºæ—¶é—´

### wechat_usersï¼ˆç”¨æˆ·è¡¨ï¼‰
- `openid`ï¼šå¾®ä¿¡ç”¨æˆ·openidï¼ˆä¸»é”®ï¼‰
- `total_credits`ï¼šæ€»é¢åº¦
- `remaining_credits`ï¼šå‰©ä½™é¢åº¦
- `used_credits`ï¼šå·²ç”¨é¢åº¦
- `is_member`ï¼šæ˜¯å¦ä¼šå‘˜
- `member_expire_at`ï¼šä¼šå‘˜åˆ°æœŸæ—¶é—´

