# 微信支付接口说明

## 📋 已实现的接口

### 1. 创建支付订单

**接口**：`POST /api/v1/payment/create-order`

**请求头**：
- `X-WeChat-OpenID`：微信用户openid（必填）

**请求体**：
```json
{
  "order_type": "member",      // 订单类型：member（会员）或 credits（额度）
  "credits_amount": 10         // 购买额度数量（仅订单类型为credits时必填）
}
```

**响应**：
```json
{
  "success": true,
  "order_no": "20251028123456789",
  "amount": 29.90,
  "payment_params": {
    "appId": "wx519901dac7705111",
    "timeStamp": "1698480000",
    "nonceStr": "abc123",
    "package": "preify_id=wx123456",
    "signType": "MD5",
    "paySign": "ABCDEF123456"
  },
  "message": "订单创建成功，正在调起支付..."
}
```

**订单类型说明**：
- `member`：开通会员，固定价格 29.90元，开通30天会员
- `credits`：购买额度，支持10/20/50/100张，价格分别为9.9/18.0/39.0/69.0元

### 2. 支付回调接口（微信调用）

**接口**：`POST /api/v1/payment/notify`

微信支付成功后自动调用此接口，用于：
- 验证支付签名
- 更新订单状态为"paid"
- 发放会员或额度

### 3. 查询订单列表

**接口**：`GET /api/v1/payment/orders`

**请求头**：
- `X-WeChat-OpenID`：微信用户openid

**响应**：
```json
{
  "success": true,
  "orders": [
    {
      "order_no": "20251028123456789",
      "order_type": "member",
      "amount": 29.90,
      "status": "paid",
      "created_at": "2025-10-28 20:00:00",
      "paid_at": "2025-10-28 20:01:00"
    }
  ]
}
```

### 4. 查询单个订单

**接口**：`GET /api/v1/payment/order/{order_no}`

**请求头**：
- `X-WeChat-OpenID`：微信用户openid

**响应**：
```json
{
  "success": true,
  "order": {
    "order_no": "20251028123456789",
    "order_type": "member",
    "amount": 29.90,
    "status": "paid",
    "created_at": "2025-10-28 20:00:00",
    "paid_at": "2025-10-28 20:01:00"
  }
}
```

## 🎯 支付流程

### 会员开通流程

1. **用户点击菜单"开通会员"**
2. **前端调用创建订单接口**：
   ```javascript
   fetch('/api/v1/payment/create-order', {
     method: 'POST',
     headers: {
       'X-WeChat-OpenID': openid,
       'Content-Type': 'application/json'
     },
     body: JSON.stringify({
       order_type: 'member'
     })
   })
   ```
3. **获取payment_params，调起微信支付**：
   ```javascript
   WeixinJSBridge.invoke('getBrandWCPayRequest', {
     ...payment_params
   }, function(res) {
     if(res.err_msg === "get_brand_wcpay_request:ok") {
       // 支付成功
     }
   });
   ```
4. **微信完成支付后，调用我们的回调接口**
5. **后端更新订单状态，发放会员**

### 购买额度流程

1. **用户点击菜单"购买额度"**
2. **前端显示额度选择（10/20/50/100张）**
3. **用户选择后调用创建订单接口**：
   ```javascript
   fetch('/api/v1/payment/create-order', {
     method: 'POST',
     headers: {
       'X-WeChat-OpenID': openid,
       'Content-Type': 'application/json'
     },
     body: JSON.stringify({
       order_type: 'credits',
       credits_amount: 10
     })
   })
   ```
4. **后续流程同会员开通**

## 🔧 前端实现要点

### ⚠️ 重要提示

前端支付功能需要在前端项目中实现。本后端项目仅提供管理后台功能。

前端项目需要实现以下内容：

### 1. 获取OpenID

用户通过扫码关注公众号后，前端需要从localStorage读取`wechat_openid`：

```javascript
const openid = localStorage.getItem('wechat_openid');
```

### 2. 调起支付

在微信公众号网页中调用微信支付：

```javascript
function callWeChatPay(paymentParams) {
  if (typeof WeixinJSBridge == "undefined") {
    if (document.addEventListener) {
      document.addEventListener('WeixinJSBridgeReady', function() {
        invokeWeChatPay(paymentParams);
      }, false);
    } else if (document.attachEvent) {
      document.attachEvent('WeixinJSBridgeReady', function() {
        invokeWeChatPay(paymentParams);
      });
    }
  } else {
    invokeWeChatPay(paymentParams);
  }
}

function invokeWeChatPay(paymentParams) {
  WeixinJSBridge.invoke('getBrandWCPayRequest', paymentParams, function(res) {
    if (res.err_msg === "get_brand_wcpay_request:ok") {
      // 支付成功
      alert('支付成功！');
      // 跳转到结果页面或刷新额度
    } else {
      // 支付失败
      alert('支付失败：' + res.err_msg);
    }
  });
}
```

### 3. 解析URL参数

当用户通过菜单进入时，需要解析URL中的`action`参数：

```javascript
function parseUrlParams() {
  const params = new URLSearchParams(window.location.search);
  const action = params.get('action');
  
  switch(action) {
    case 'member':
      showMemberPage();
      break;
    case 'credits':
      showCreditsPage();
      break;
    case 'credits_info':
      showCreditsInfoPage();
      break;
    default:
      showDefaultPage();
  }
}
```

### 4. 完整的支付流程示例

```javascript
// 创建订单并调起支付
async function createMemberOrder() {
  const openid = localStorage.getItem('wechat_openid');
  
  const response = await fetch('https://www.xintuxiangce.top/api/v1/payment/create-order', {
    method: 'POST',
    headers: {
      'X-WeChat-OpenID': openid,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ order_type: 'member' })
  });
  
  const result = await response.json();
  
  if (result.success && result.payment_params) {
    // 调起微信支付
    callWeChatPay(result.payment_params);
  } else {
    alert('创建订单失败');
  }
}
```

### 5. 前端项目配置

前端项目需要配置：
- **API域名**：`https://www.xintuxiangce.top/api/v1`
- **微信公众号授权域名**：在微信公众平台配置`www.xintuxiangce.top`
- **JSAPI支付授权目录**：在微信支付商户平台配置`https://www.xintuxiangce.top/api/v1/payment/notify`

## ⚠️ 注意事项

1. **必须使用HTTPS**：微信支付要求所有接口使用HTTPS
2. **域名授权**：需要在微信支付商户平台配置授权域名
3. **支付回调**：微信会多次重试支付回调，需要保证接口幂等性
4. **订单超时**：订单30分钟未支付会自动过期
5. **签名验证**：所有支付相关的请求都必须验证签名

## 🧪 测试

### 测试会员开通

```bash
curl -X POST http://admin.xintuxiangce.top:8000/api/v1/payment/create-order \
  -H "X-WeChat-OpenID: okbfi1wlkjqhkaHYIYKUxwJe66P8" \
  -H "Content-Type: application/json" \
  -d '{"order_type": "member"}'
```

### 测试购买额度

```bash
curl -X POST http://admin.xintuxiangce.top:8000/api/v1/payment/create-order \
  -H "X-WeChat-OpenID: okbfi1wlkjqhkaHYIYKUxwJe66P8" \
  -H "Content-Type: application/json" \
  -d '{"order_type": "credits", "credits_amount": 10}'
```

## 📝 数据库表结构

### payment_orders（订单表）
- `order_no`：订单号（主键）
- `openid`：微信用户openid
- `order_type`：订单类型（member/credits）
- `amount`：订单金额
- `credits_amount`：购买的额度数量
- `status`：订单状态（pending/paid/cancelled）
- `created_at`：创建时间
- `paid_at`：支付时间

### membership_records（会员记录表）
- `id`：主键
- `openid`：微信用户openid
- `start_date`：会员开始日期
- `end_date`：会员结束日期
- `created_at`：创建时间

### wechat_users（用户表）
- `openid`：微信用户openid（主键）
- `total_credits`：总额度
- `remaining_credits`：剩余额度
- `used_credits`：已用额度
- `is_member`：是否会员
- `member_expire_at`：会员到期时间

