# 微信公众号网页授权配置指南

## 问题症状

当用户通过公众号菜单点击"立即开通"时，提示"页面无授权"。

## 问题原因

需要在微信公众号后台配置**网页授权域名**，才能使用网页授权功能。

## 解决步骤

### 1. 登录微信公众号后台

访问：https://mp.weixin.qq.com/

### 2. 配置网页授权域名

1. 进入：**开发** → **接口权限**
2. 找到 **"网页授权"** 功能
3. 点击 **"设置"** 或 **"修改"**
4. 在 **"授权回调页面域名"** 中填入：
   ```
   www.xintuxiangce.top
   ```
   **注意**：
   - 只需要填写域名，不需要包含 `https://` 或 `/`
   - 不需要包含路径或端口号
   - 示例：`www.xintuxiangce.top` ✅
   - 错误：`https://www.xintuxiangce.top` ❌
   - 错误：`www.xintuxiangce.top/member.html` ❌

5. 点击 **"保存"**

### 3. 验证配置

配置完成后，授权流程如下：

1. 用户点击公众号菜单
2. 跳转到微信授权页面
3. 授权后带着 `code` 参数返回页面
4. 页面调用 `/api/v1/auth/wechat?code=xxx` 获取 openid
5. 将 openid 保存到 localStorage
6. 用户可以使用支付功能

### 4. 测试授权流程

1. 关注公众号
2. 点击菜单 **"开通会员"**
3. 应该能正常进入开通会员页面
4. 点击 **"立即开通"** 应该能正常创建订单并调起支付

## 已修复的问题

### 1. openid 持久化问题

**问题**：页面刷新后 openid 丢失

**修复**：
- 将 openid 保存到 localStorage
- 页面加载时从 localStorage 读取 openid
- 避免每次都需要重新授权

### 2. 调试信息干扰

**问题**：页面上显示调试信息

**修复**：移除调试信息显示

### 3. 错误处理改善

**问题**：错误提示不够清晰

**修复**：
- 区分不同的错误情况
- 提供更明确的错误提示
- 在控制台输出详细日志

## 配置检查清单

- [ ] 在公众号后台配置了授权回调域名：`www.xintuxiangce.top`
- [ ] 菜单中使用了正确的授权 URL
- [ ] 服务器已部署并运行
- [ ] 域名已备案（如果是国内服务器）
- [ ] SSL 证书已配置（HTTPS 必须）

## 常见问题

### Q: 配置后仍然提示"页面无授权"？

A: 检查以下几点：
1. 确认域名配置正确（不要包含协议和路径）
2. 确认公众号 AppID 和 AppSecret 配置正确
3. 检查服务器日志，查看授权接口是否有错误
4. 尝试清除浏览器缓存后重新测试

### Q: code 参数有效期是多久？

A: code 参数只有 5 分钟有效期，且只能使用一次。

### Q: 如何查看授权日志？

A: 查看服务器日志，授权流程的日志包含：
- 收到授权请求
- 调用微信 API 获取 openid
- 创建或更新用户
- 返回授权结果

### Q: 哪些域名需要配置？

A: 只需要配置主域名：`www.xintuxiangce.top`

所有子页面都会使用同一个授权域名。

## 相关文件

- `web/member.html` - 开通会员页面
- `web/credits.html` - 购买额度页面
- `web/credits_info.html` - 我的额度页面
- `app/api/auth.py` - 认证相关接口
- `app/api/payment.py` - 支付相关接口

## 技术支持

如有问题，请查看：
1. 微信公众号开发文档：https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html
2. 服务器日志：`/var/log/image-classifier/app.log`
3. 控制台日志（浏览器开发者工具）

