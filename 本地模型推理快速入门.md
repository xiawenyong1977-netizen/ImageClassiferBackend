# æœ¬åœ°æ¨¡å‹æ¨ç†å¿«é€Ÿå…¥é—¨ ğŸš€

## ğŸ“Œ åŠŸèƒ½æ¦‚è¿°

å·²æˆåŠŸå®ç°**æœ¬åœ°ç¥ç»ç½‘ç»œæ¨¡å‹æ¨ç†**åŠŸèƒ½ï¼Œä½¿ç”¨ä¸‰ä¸ªONNXæ¨¡å‹å¯¹ä¸Šä¼ çš„å›¾ç‰‡è¿›è¡Œæ¨ç†ï¼Œè¾“å‡ºæ ¼å¼ä¸å®¢æˆ·ç«¯ä»£ç å®Œå…¨ä¸€è‡´ã€‚

### æ”¯æŒçš„æ¨¡å‹

1. **IDå¡è¯†åˆ«** (`id_card_detection.onnx`) - æ£€æµ‹èº«ä»½è¯æ­£åé¢
2. **YOLO8sé€šç”¨æ£€æµ‹** (`yolov8s.onnx`) - æ£€æµ‹80ç§å¸¸è§ç‰©ä½“
3. **MobileNetV3å›¾åƒåˆ†ç±»** (`mobilenetv3_rw_Opset17.onnx`) - ImageNet 1000ç±»åˆ†ç±»

## ğŸ†• æ–°å¢æ–‡ä»¶

```
ImageClassifierBackend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ local_model_inference.py    # â­ æœ¬åœ°æ¨¡å‹æ¨ç†æœåŠ¡ï¼ˆä½¿ç”¨Ultralyticsï¼‰
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ local_classify.py           # â­ æœ¬åœ°åˆ†ç±»APIæ¥å£
â”œâ”€â”€ test_local_inference.py             # â­ æµ‹è¯•è„šæœ¬
â”œâ”€â”€ requirements.txt                    # âœï¸ æ›´æ–°ï¼ˆæ·»åŠ ultralyticsã€onnxruntimeç­‰ï¼‰
â”œâ”€â”€ æœ¬åœ°æ¨¡å‹æ¨ç†ä½¿ç”¨è¯´æ˜.md              # ğŸ“„ è¯¦ç»†ä½¿ç”¨æ–‡æ¡£
â””â”€â”€ æœ¬åœ°æ¨¡å‹æ¨ç†å¿«é€Ÿå…¥é—¨.md              # ğŸ“„ æœ¬æ–‡æ¡£
```

## ğŸ“¦ å®‰è£…ä¾èµ–

```bash
# å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…å«Ultralyticsï¼‰
pip install -r requirements.txt
```

ä¸»è¦ä¾èµ–ï¼š
- `ultralytics==8.0.200` - YOLOæ¨ç†åº“ï¼ˆè‡ªåŠ¨å¤„ç†é¢„å¤„ç†å’Œåå¤„ç†ï¼‰
- `onnxruntime==1.16.3` - ONNXæ¨¡å‹æ¨ç†å¼•æ“
- `numpy==1.24.3` - æ•°å€¼è®¡ç®—
- `Pillow==10.2.0` - å›¾åƒå¤„ç†

### GPUåŠ é€Ÿï¼ˆå¯é€‰ï¼‰

å¦‚æœæœ‰NVIDIA GPUï¼Œå¯ä»¥å®‰è£…CUDAç‰ˆæœ¬ï¼š

```bash
pip uninstall onnxruntime
pip install onnxruntime-gpu==1.16.3
```

## ğŸš€ å¿«é€Ÿæµ‹è¯•

### 1. è¿è¡Œæµ‹è¯•è„šæœ¬

```bash
python test_local_inference.py
```

æµ‹è¯•è„šæœ¬ä¼šï¼š
- âœ… åˆå§‹åŒ–æ‰€æœ‰æ¨¡å‹
- âœ… éªŒè¯è¾“å‡ºæ ¼å¼å…¼å®¹æ€§
- âœ… åˆ›å»ºæµ‹è¯•å›¾ç‰‡å¹¶æ¨ç†

### 2. åœ¨ä»£ç ä¸­ä½¿ç”¨

```python
import asyncio
from app.services.local_model_inference import local_model_inference

async def main():
    # åˆå§‹åŒ–æ¨¡å‹ï¼ˆé¦–æ¬¡è°ƒç”¨ï¼‰
    await local_model_inference.initialize()
    
    # è¯»å–å›¾ç‰‡
    with open("test.jpg", "rb") as f:
        image_bytes = f.read()
    
    # æ‰§è¡Œæ¨ç†
    result = await local_model_inference.classify_image(image_bytes)
    
    # æŸ¥çœ‹ç»“æœ
    print(f"åˆ†ç±»: {result['categoryId']}")
    print(f"ç½®ä¿¡åº¦: {result['confidence']}")
    print(f"æ¶ˆæ¯: {result['message']}")
    
    # æŸ¥çœ‹è¯¦ç»†æ£€æµ‹ç»“æœ
    print(f"\nIDå¡æ£€æµ‹: {len(result['idCardDetections'])}ä¸ª")
    print(f"é€šç”¨æ£€æµ‹: {len(result['generalDetections'])}ä¸ª")

asyncio.run(main())
```

## ğŸŒ APIæ¥å£

æ–°å¢äº†ä¸‰ä¸ªAPIæ¥å£ï¼š

### 1. æœ¬åœ°æ¨¡å‹åˆ†ç±»æ¥å£

```http
POST /api/v1/local-classify
Content-Type: multipart/form-data

image: <å›¾ç‰‡æ–‡ä»¶>
```

**å“åº”æ ¼å¼**ï¼ˆä¸ç°æœ‰APIä¿æŒä¸€è‡´ï¼‰ï¼š

```json
{
  "success": true,
  "data": {
    "category": "single_person",
    "confidence": 0.95,
    "description": "æ£€æµ‹åˆ°å•äººç…§ç‰‡"
  },
  "from_cache": false,
  "processing_time_ms": 0,
  "request_id": "local_20251011120000",
  "timestamp": "2025-10-11T12:00:00"
}
```

### 2. è¯¦ç»†ç»“æœæ¥å£

```http
POST /api/v1/local-classify/detailed
Content-Type: multipart/form-data

image: <å›¾ç‰‡æ–‡ä»¶>
```

**å“åº”æ ¼å¼**ï¼ˆåŒ…å«æ‰€æœ‰æ£€æµ‹ç»“æœï¼‰ï¼š

```json
{
  "success": true,
  "category": "single_person",
  "confidence": 0.95,
  "message": "å›¾åƒåˆ†ç±»å®Œæˆ",
  "details": {
    "imageDimensions": {"width": 1920, "height": 1080},
    "idCardDetections": [...],
    "generalDetections": [
      {
        "classId": 0,
        "className": "person",
        "confidence": 0.92,
        "bbox": [100, 200, 300, 400]
      }
    ],
    "mobileNetV3Detections": {
      "predictions": [...],
      "topPrediction": {...},
      "confidence": 0.85
    },
    "isMobileScreenshot": false
  },
  "timestamp": "2025-10-11T12:00:00"
}
```

### 3. æ¨¡å‹çŠ¶æ€æ¥å£

```http
GET /api/v1/local-classify/models
```

**å“åº”æ ¼å¼**ï¼š

```json
{
  "initialized": true,
  "models": {
    "idCard": {
      "loaded": true,
      "path": ".../id_card_detection.onnx",
      "confidence_threshold": 0.7,
      "input_size": 640
    },
    "yolo8s": {...},
    "mobilenetv3": {...}
  },
  "available_categories": [
    "social_activities",
    "pets",
    "single_person",
    "foods",
    "travel_scenery",
    "screenshot",
    "idcard",
    "other"
  ]
}
```

## ğŸ¯ è¾“å‡ºæ ¼å¼

è¾“å‡ºæ ¼å¼**å®Œå…¨å…¼å®¹**å®¢æˆ·ç«¯ä»£ç  `ImageClassifierService.js`ï¼š

```javascript
{
  success: boolean,           // æ˜¯å¦æˆåŠŸ
  categoryId: string,         // åˆ†ç±»ID
  confidence: number,         // ç½®ä¿¡åº¦ (0-1)
  message: string,            // æ¶ˆæ¯æè¿°
  
  // æ£€æµ‹ç»“æœè¯¦æƒ…
  idCardDetections: Array,    // IDå¡æ£€æµ‹ç»“æœ
  generalDetections: Array,   // é€šç”¨ç‰©ä½“æ£€æµ‹ç»“æœ
  mobileNetV3Detections: Object, // MobileNetV3åˆ†ç±»ç»“æœ
  
  // å›¾ç‰‡ä¿¡æ¯
  imageDimensions: {
    width: number,
    height: number
  },
  
  // æ‰€æœ‰æ¨¡å‹åŸå§‹ç»“æœ
  allModelResults: {
    mobileScreenshot: boolean,
    idCard: Array,
    general: Array,
    mobileNetV3: Object
  }
}
```

## ğŸ“Š æ”¯æŒçš„åˆ†ç±»

| åˆ†ç±»ID | ä¸­æ–‡åç§° | æ£€æµ‹é€»è¾‘ |
|--------|---------|---------|
| `idcard` | è¯ä»¶ç…§ | IDå¡æ¨¡å‹æ£€æµ‹åˆ°èº«ä»½è¯ |
| `single_person` | å•äººç…§ç‰‡ | YOLOæ£€æµ‹åˆ°1ä¸ªäºº |
| `social_activities` | ç¤¾äº¤æ´»åŠ¨ | YOLOæ£€æµ‹åˆ°å¤šäºº |
| `pets` | å® ç‰©èŒç…§ | YOLOæ£€æµ‹åˆ°çŒ«/ç‹—/é¸Ÿ |
| `foods` | ç¾é£Ÿè®°å½• | YOLOæ£€æµ‹åˆ°é£Ÿç‰©ç±»ç‰©ä½“ |
| `travel_scenery` | æ—…è¡Œé£æ™¯ | æ£€æµ‹ç‰©ä½“è¾ƒå°‘ |
| `screenshot` | æ‰‹æœºæˆªå›¾ | å®¢æˆ·ç«¯åˆ¤æ–­ |
| `other` | å…¶å®ƒ | æ— æ³•æ˜ç¡®åˆ†ç±» |

> **æ³¨æ„**ï¼š`screenshot`ï¼ˆæ‰‹æœºæˆªå›¾ï¼‰åº”åœ¨å®¢æˆ·ç«¯è¯†åˆ«ï¼Œå› ä¸ºæœåŠ¡å™¨æ”¶åˆ°çš„å›¾ç‰‡å·²è¢«ç¼©æ”¾ã€‚

## ğŸ”§ é…ç½®è°ƒæ•´

åœ¨ `local_model_inference.py` ä¸­å¯ä»¥è°ƒæ•´å‚æ•°ï¼š

```python
self.model_configs = {
    "idCard": {
        "confidence_threshold": 0.7,  # è°ƒæ•´æ­¤å€¼æ”¹å˜ç½®ä¿¡åº¦é˜ˆå€¼
        "nms_threshold": 0.4,
        "input_size": 640
    },
    # ...
}
```

## ğŸš€ å¯åŠ¨æœåŠ¡

### å¼€å‘ç¯å¢ƒ

```bash
cd ImageClassifierBackend
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### ç”Ÿäº§ç¯å¢ƒ

```bash
cd ImageClassifierBackend
gunicorn -c gunicorn_config.py app.main:app
```

## ğŸ“– APIæ–‡æ¡£

å¯åŠ¨æœåŠ¡åè®¿é—®ï¼š

- Swaggeræ–‡æ¡£: http://localhost:8000/docs
- ReDocæ–‡æ¡£: http://localhost:8000/redoc

åœ¨æ–‡æ¡£ä¸­å¯ä»¥çœ‹åˆ°æ–°å¢çš„ä¸‰ä¸ªæ¥å£ï¼š
- `/api/v1/local-classify` - æœ¬åœ°æ¨¡å‹åˆ†ç±»
- `/api/v1/local-classify/detailed` - è¯¦ç»†ç»“æœ
- `/api/v1/local-classify/models` - æ¨¡å‹çŠ¶æ€

## ğŸ§ª æµ‹è¯•API

### ä½¿ç”¨curl

```bash
curl -X POST "http://localhost:8000/api/v1/local-classify" \
  -H "accept: application/json" \
  -H "Content-Type: multipart/form-data" \
  -F "image=@test.jpg"
```

### ä½¿ç”¨Python requests

```python
import requests

url = "http://localhost:8000/api/v1/local-classify"
files = {"image": open("test.jpg", "rb")}

response = requests.post(url, files=files)
print(response.json())
```

### ä½¿ç”¨Postman

1. é€‰æ‹© `POST` æ–¹æ³•
2. URL: `http://localhost:8000/api/v1/local-classify`
3. é€‰æ‹© `Body` -> `form-data`
4. æ·»åŠ é”® `image`ï¼Œç±»å‹é€‰æ‹© `File`
5. ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶
6. ç‚¹å‡» `Send`

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

| å¯¹æ¯”é¡¹ | å¤§æ¨¡å‹API | æœ¬åœ°æ¨ç† |
|--------|----------|---------|
| **é€Ÿåº¦** | 2-5ç§’ | 0.1-0.5ç§’ |
| **æˆæœ¬** | æŒ‰è°ƒç”¨æ¬¡æ•°æ”¶è´¹ | æ— é¢å¤–è´¹ç”¨ |
| **éšç§** | éœ€ä¸Šä¼ åˆ°äº‘ç«¯ | æœ¬åœ°å¤„ç† |
| **å‡†ç¡®æ€§** | è¾ƒé«˜ï¼ˆLLMç†è§£ï¼‰ | ä¸­ç­‰ï¼ˆåŸºäºæ£€æµ‹ï¼‰ |
| **ä¾èµ–** | ç½‘ç»œè¿æ¥ | æ— éœ€ç½‘ç»œ |

## ğŸ”„ ä¸ç°æœ‰æœåŠ¡é›†æˆ

### æ··åˆç­–ç•¥ç¤ºä¾‹

å¯ä»¥åˆ›å»ºä¸€ä¸ªæ··åˆç­–ç•¥ï¼Œä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ¨ç†ï¼Œå¿…è¦æ—¶é™çº§åˆ°å¤§æ¨¡å‹ï¼š

```python
from app.services.local_model_inference import local_model_inference
from app.services.model_client import model_client

async def classify_image_hybrid(image_bytes: bytes, prefer_local: bool = True):
    """æ··åˆåˆ†ç±»ç­–ç•¥"""
    if prefer_local:
        try:
            # å°è¯•æœ¬åœ°æ¨ç†
            result = await local_model_inference.classify_image(image_bytes)
            if result['success'] and result['categoryId'] != 'other':
                return result
        except Exception as e:
            logger.warning(f"æœ¬åœ°æ¨ç†å¤±è´¥ï¼Œé™çº§åˆ°å¤§æ¨¡å‹: {e}")
    
    # ä½¿ç”¨å¤§æ¨¡å‹API
    llm_result = await model_client.classify_image(image_bytes)
    return {
        'success': True,
        'categoryId': llm_result['category'],
        'confidence': llm_result['confidence'],
        'message': llm_result['description'],
        # ... å…¶ä»–å­—æ®µ
    }
```

## ğŸ› æ•…éšœæ’æŸ¥

### æ¨¡å‹åŠ è½½å¤±è´¥

**ç°è±¡**: `æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨: xxx.onnx`

**è§£å†³**: 
```bash
# æ£€æŸ¥æ¨¡å‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la app/models/
# åº”è¯¥çœ‹åˆ°ä¸‰ä¸ª.onnxæ–‡ä»¶
```

### å†…å­˜ä¸è¶³

**ç°è±¡**: æ¨ç†æ—¶å†…å­˜æº¢å‡º

**è§£å†³**:
- é™ä½å›¾ç‰‡åˆ†è¾¨ç‡
- ä½¿ç”¨GPUç‰ˆæœ¬ï¼ˆ`onnxruntime-gpu`ï¼‰
- åªåŠ è½½éœ€è¦çš„æ¨¡å‹

### æ¨ç†ç»“æœä¸å‡†ç¡®

**ç°è±¡**: åˆ†ç±»ç»“æœä¸é¢„æœŸä¸ç¬¦

**è§£å†³**:
- è°ƒæ•´ `confidence_threshold` å‚æ•°
- æŸ¥çœ‹è¯¦ç»†æ£€æµ‹ç»“æœåˆ†æåŸå› 
- è€ƒè™‘ä½¿ç”¨å¤§æ¨¡å‹APIä½œä¸ºè¡¥å……

## ğŸ“š ç›¸å…³æ–‡æ¡£

- ğŸ“– [è¯¦ç»†ä½¿ç”¨è¯´æ˜](./æœ¬åœ°æ¨¡å‹æ¨ç†ä½¿ç”¨è¯´æ˜.md)
- ğŸ“– [å®¢æˆ·ç«¯è°ƒç”¨æŒ‡å—](./å®¢æˆ·ç«¯è°ƒç”¨æŒ‡å—.md)
- ğŸ“– [APIè®¾è®¡æ–‡æ¡£](./DESIGN.md)

## âœ… æ€»ç»“

âœ¨ **å·²å®Œæˆçš„å·¥ä½œ**:

1. âœ… åˆ›å»ºæœ¬åœ°æ¨¡å‹æ¨ç†æœåŠ¡ (`local_model_inference.py`)
2. âœ… è¾“å‡ºæ ¼å¼ä¸å®¢æˆ·ç«¯ä»£ç å®Œå…¨ä¸€è‡´
3. âœ… æ”¯æŒä¸‰ä¸ªONNXæ¨¡å‹æ¨ç†
4. âœ… æ–°å¢ä¸‰ä¸ªAPIæ¥å£
5. âœ… æä¾›æµ‹è¯•è„šæœ¬å’Œå®Œæ•´æ–‡æ¡£
6. âœ… æ›´æ–°ä¾èµ–é…ç½® (`requirements.txt`)

ğŸ¯ **ä¸‹ä¸€æ­¥å»ºè®®**:

1. å®‰è£…ä¾èµ–å¹¶è¿è¡Œæµ‹è¯•è„šæœ¬
2. å‡†å¤‡æµ‹è¯•å›¾ç‰‡éªŒè¯æ¨ç†æ•ˆæœ
3. æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´æ¨¡å‹å‚æ•°
4. è€ƒè™‘é›†æˆåˆ°ç°æœ‰åˆ†ç±»æµç¨‹ä¸­
5. éƒ¨ç½²åˆ°æœåŠ¡å™¨ç¯å¢ƒæµ‹è¯•æ€§èƒ½

---

**åˆ›å»ºæ—¥æœŸ**: 2025-10-11  
**ä½œè€…**: ImageClassifier Backend Team  
**ç‰ˆæœ¬**: 1.0.0

